<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ëª½ê¸€ëª½ê¸€ ìš°ë¦¬ì§‘</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Dongle:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* [Theme: Soft Cloud & Cotton Candy] */
        :root {
            --bg-color: #FFFDF9; /* ë” ë°ê³  ë”°ëœ»í•œ í¬ë¦¼ìƒ‰ */
            --card-bg: rgba(255, 255, 255, 0.85); /* ë°˜íˆ¬ëª…í•œ ì¹´ë“œ */
            --primary: #FF9EAA; /* ë” ë¶€ë“œëŸ¬ìš´ í•‘í¬ */
            --primary-soft: #FFF0F3;
            --text-main: #5D534A; /* ë”°ëœ»í•œ ê°ˆìƒ‰ í†¤ì˜ í…ìŠ¤íŠ¸ */
            --text-sub: #9E948A;
            --accent-yellow: #FFD966;
            
            --radius-XL: 32px; /* ë” ë‘¥ê¸€ê²Œ */
            --radius-L: 24px;
            --radius-M: 18px;
            
            /* [NEW] ëª½ê¸€ëª½ê¸€í•œ ê·¸ë¦¼ì: ë” ë„“ê³  ë¶€ë“œëŸ½ê²Œ í¼ì§ */
            --shadow-cloud: 
                0 15px 40px rgba(255, 158, 170, 0.15), 
                0 5px 15px rgba(255, 217, 102, 0.1);
            --shadow-hover: 
                0 20px 50px rgba(255, 158, 170, 0.25), 
                0 8px 20px rgba(255, 217, 102, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); color: var(--text-main);
            min-height: 100vh; overflow-x: hidden;
        }

        /* [NEW] ë°°ê²½ ì†œì‚¬íƒ• ì• ë‹ˆë©”ì´ì…˜ (ëª½ê¸€ëª½ê¸€ ì´í™íŠ¸ í•µì‹¬) */
        .blob-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden;
        }
        .blob {
            position: absolute; border-radius: 50%; filter: blur(70px); opacity: 0.6;
            animation: floatBlob 25s infinite alternate ease-in-out;
        }
        .blob-1 { top: -20%; left: -10%; width: 70%; height: 70%; background: rgba(255, 158, 170, 0.3); animation-delay: -5s; }
        .blob-2 { bottom: -30%; right: -20%; width: 80%; height: 80%; background: rgba(255, 217, 102, 0.3); animation-delay: -12s; }
        .blob-3 { top: 40%; left: 30%; width: 50%; height: 50%; background: rgba(163, 212, 175, 0.25); animation-delay: -2s; }
        
        @keyframes floatBlob {
            0% { transform: translate(0, 0) scale(1) rotate(0deg); border-radius: 50% 50% 50% 50%; }
            33% { transform: translate(5%, 10%) scale(1.1) rotate(10deg); border-radius: 60% 40% 50% 70%; }
            66% { transform: translate(-5%, 5%) scale(0.9) rotate(-5deg); border-radius: 50% 60% 70% 40%; }
            100% { transform: translate(10%, -5%) scale(1.05) rotate(5deg); border-radius: 50% 50% 50% 50%; }
        }

        /* ë ˆì´ì•„ì›ƒ */
        .app-layout { max-width: 600px; margin: 0 auto; padding-bottom: 110px; position: relative; }

        /* í—¤ë” */
        .header { 
            padding: 25px; display: flex; justify-content: space-between; align-items: center;
            /* í—¤ë”ë„ ëª½ê¸€í•˜ê²Œ */
            background: rgba(255, 253, 249, 0.7); backdrop-filter: blur(15px);
            border-radius: 0 0 var(--radius-XL) var(--radius-XL);
            box-shadow: 0 5px 20px rgba(255, 158, 170, 0.1);
            position: sticky; top: 0; z-index: 50;
        }
        .logo-sub { font-size: 14px; color: var(--text-sub); font-weight: 500; letter-spacing: 1px; }
        .logo-txt { font-family: 'Dongle', sans-serif; font-size: 36px; font-weight: 700; color: var(--text-main); line-height: 1.2; }
        .logo-txt span { color: var(--primary); position: relative; }
        /* ë¡œê³ ì— ì‘ì€ í¬ì¸íŠ¸ */
        .logo-txt span::after { content: ''; position: absolute; top: 5px; right: -8px; width: 6px; height: 6px; background: var(--accent-yellow); border-radius: 50%; }

        .my-profile { 
            width: 44px; height: 44px; border-radius: 50%; background: var(--white); 
            border: 3px solid var(--primary-soft); overflow: hidden; display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-cloud); transition: 0.3s;
        }

        /* --- [UI ìš”ì†Œ ì—…ë°ì´íŠ¸: ë” ë‘¥ê¸€ê³  ë¶€ë“œëŸ½ê²Œ] --- */
        .cozy-card {
            background: var(--card-bg); border-radius: var(--radius-XL); /* ë” ë‘¥ê¸€ê²Œ */
            padding: 28px; margin: 0 20px 28px 20px;
            box-shadow: var(--shadow-cloud); /* ëª½ê¸€í•œ ê·¸ë¦¼ì ì ìš© */
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.4);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); /* íŠ•ê¸°ëŠ” ë“¯í•œ ì „í™˜ */
        }
        .cozy-card:hover { transform: translateY(-5px) scale(1.01); box-shadow: var(--shadow-hover); }

        /* ë²„íŠ¼: ì ¤ë¦¬ íš¨ê³¼ ê°•í™” */
        .btn-jelly {
            background: var(--primary); color: white; border: none;
            padding: 14px 28px; border-radius: 50px;
            font-size: 16px; font-weight: 700; cursor: pointer;
            box-shadow: 0 8px 20px rgba(255, 158, 170, 0.4);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); /* ì«€ë“í•œ ì• ë‹ˆë©”ì´ì…˜ */
            display: flex; align-items: center; gap: 8px; justify-content: center;
        }
        .btn-jelly:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 12px 25px rgba(255, 158, 170, 0.5); }
        .btn-jelly:active { transform: scale(0.9); } /* ëˆŒë €ì„ ë•Œ ë” ë§ì´ ì‘ì•„ì§ */
        .btn-jelly.soft { background: var(--primary-soft); color: var(--primary); box-shadow: none; }
        .btn-jelly.soft:hover { background: #FFE8EC; box-shadow: 0 5px 15px rgba(255, 158, 170, 0.2); }

        /* íƒ­ ì „í™˜ íš¨ê³¼ */
        .tab-section { display: none; animation: softPopUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .tab-section.active { display: block; }
        @keyframes softPopUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* [í”¼ë“œ] */
        .writer-select { display: flex; gap: 12px; margin-bottom: 20px; overflow-x: auto; padding: 5px; scrollbar-width: none; }
        .writer-select::-webkit-scrollbar { display: none; }
        .radio-hidden { display: none; }
        .writer-chip {
            padding: 10px 20px; background: rgba(255,255,255,0.6); border-radius: 30px; border: 1px solid transparent;
            font-size: 15px; color: var(--text-sub); font-weight: 600; cursor: pointer;
            transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); white-space: nowrap; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        .radio-hidden:checked + .writer-chip {
            background: var(--primary); color: white; box-shadow: 0 8px 20px rgba(255, 158, 170, 0.4); transform: scale(1.08); border-color: transparent;
        }
        .writer-chip-img { width: 24px; height: 24px; border-radius: 50%; overflow: hidden; background: #fff; border: 2px solid #fff; }

        .input-area { width: 100%; border: none; background: transparent; font-size: 17px; line-height: 1.6; resize: none; min-height: 90px; outline: none; color: var(--text-main); }
        .input-area::placeholder { color: #C8C0B8; }
        .photo-btn { font-size: 24px; color: var(--primary); cursor: pointer; padding: 10px; transition: 0.3s; border-radius: 50%; background: var(--primary-soft); }
        .photo-btn:hover { transform: scale(1.1); background: #FFE8EC; }
        .img-preview { width: 100%; border-radius: 24px; margin-top: 20px; overflow: hidden; position: relative; display: none; box-shadow:var(--shadow-cloud); border: 3px solid white; }

        /* ê²Œì‹œë¬¼ ìŠ¤íƒ€ì¼ */
        .feed-header { margin-bottom: 20px; }
        .fp-img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 3px solid var(--white); box-shadow: var(--shadow-cloud); }
        .fp-info h4 { font-size: 17px; font-weight: 700; color: var(--text-main); }
        
        .feed-photo-frame { 
            padding: 10px; background: white; border-radius: 24px; 
            box-shadow: var(--shadow-cloud); margin-bottom: 20px; transform: rotate(-1.5deg); transition: 0.3s;
        }
        .feed-photo-frame:hover { transform: rotate(0deg) scale(1.02); }
        .feed-photo-frame img { width: 100%; border-radius: 18px; display: block; }

        .action-pill { 
            padding: 10px 18px; background: rgba(255,255,255,0.7); border-radius: 20px; color: var(--text-sub); 
            font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .action-pill.liked { background: var(--primary-soft); color: var(--primary); box-shadow: 0 4px 12px rgba(255, 158, 170, 0.3); }
        .action-pill:active { transform: scale(0.9); }

        /* ëŒ“ê¸€ */
        .comment-section { background: rgba(255,255,255,0.6); border-radius: 24px; padding: 20px; margin-top: 20px; }
        .cmt-bubble { background: white; padding: 12px 18px; border-radius: 4px 24px 24px 24px; box-shadow: var(--shadow-cloud); }
        .cmt-input-box { background: white; padding: 8px; border-radius: 30px; box-shadow: var(--shadow-cloud); }
        .cmt-input { border: none; padding: 8px 10px; font-size: 14px; }
        .cmt-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; border: none; box-shadow: 0 4px 12px rgba(255, 158, 170, 0.4); transition: 0.3s; }
        .cmt-btn:active { transform: scale(0.9); }

        /* [ìº˜ë¦°ë”] */
        .cal-title { font-family: 'Dongle', sans-serif; font-size: 40px; color: var(--text-main); font-weight: 700; line-height: 1; }
        .cal-arrow { width: 42px; height: 42px; border-radius: 50%; background: var(--primary-soft); color: var(--primary); border: none; cursor: pointer; font-size: 18px; transition: 0.3s; box-shadow: 0 4px 10px rgba(255, 158, 170, 0.2); }
        .cal-arrow:active { transform: scale(0.9); }
        .date-cell { 
            min-height: 80px; background: rgba(255,255,255,0.7); border-radius: 20px; border: 2px solid transparent;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .date-cell:hover { transform: translateY(-3px); box-shadow: var(--shadow-cloud); border-color: var(--primary-soft); }
        .date-cell.today { background: var(--primary); color: white; box-shadow: 0 8px 20px rgba(255, 158, 170, 0.4); transform: scale(1.05); }
        .event-badge { background: var(--accent-yellow); color: #7F6A20; padding: 4px 8px; border-radius: 10px; font-weight: 700; box-shadow: 0 2px 5px rgba(255, 217, 102, 0.3); }

        /* [ê°€ì¡±] */
        .member-card { 
            background: var(--card-bg); border-radius: 30px; padding: 25px 20px; text-align: center; 
            box-shadow: var(--shadow-cloud); position: relative; transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(10px);
        }
        .member-card:hover { transform: translateY(-8px) scale(1.03); box-shadow: var(--shadow-hover); }
        .mem-img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 4px solid white; box-shadow: var(--shadow-cloud); }
        .mem-role { font-family: 'Dongle', sans-serif; font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .add-card { border: 3px dashed var(--primary-soft); background: rgba(255, 240, 243, 0.5); color: var(--primary); gap: 15px; min-height: 220px; }
        .add-card:hover { background: var(--primary-soft); border-color: var(--primary); transform: scale(1.05); }

        /* ë„¤ë¹„ê²Œì´ì…˜ (í•˜ë‹¨ë°”) */
        .nav-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; height: 75px;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px);
            border-radius: 50px; box-shadow: var(--shadow-cloud);
            display: flex; justify-content: space-around; align-items: center; padding: 0 10px; z-index: 100;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #C8C0B8; cursor: pointer; transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); padding: 10px 20px; border-radius: 30px; }
        .nav-item i { font-size: 24px; margin-bottom: 4px; transition: 0.4s; }
        .nav-item.active { color: var(--primary); background: var(--primary-soft); box-shadow: 0 4px 15px rgba(255, 158, 170, 0.3); }
        .nav-item.active i { transform: scale(1.1); }

        /* ëª¨ë‹¬ */
        .modal-bg { background: rgba(93, 83, 74, 0.3); backdrop-filter: blur(8px); }
        .modal-box { background: var(--bg-color); width: 88%; padding: 32px; border-radius: 36px; box-shadow: var(--shadow-hover); animation: softPopUp 0.5s; }
        .modal-tit { font-size: 32px; color: var(--primary); }
        .inp-cozy { padding: 14px 20px; border: 2px solid var(--primary-soft); border-radius: 20px; font-size: 16px; background: white; }
        .inp-cozy:focus { border-color: var(--primary); box-shadow: 0 4px 15px rgba(255, 158, 170, 0.2); }
        .btn-m { padding: 15px; border-radius: 20px; font-size: 16px; transition: 0.3s; }
        .btn-gray { background: #F1F3F5; color: var(--text-sub); }
        .btn-pink { background: var(--primary); color: white; box-shadow: 0 8px 20px rgba(255, 158, 170, 0.4); }
        .btn-pink:active { transform: scale(0.95); }

        @media (min-width: 768px) {
            .app-layout { padding: 50px; }
            .nav-bar { bottom: auto; left: 50px; top: 50%; transform: translateY(-50%); width: 80px; height: auto; flex-direction: column; padding: 30px 10px; border-radius: 50px; gap: 20px; }
            .nav-item { padding: 20px 10px; width: 100%; } .nav-item span { display: none; }
            .main-content { margin-left: 120px; }
            .family-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="blob-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div class="app-layout">
        <header class="header">
            <div class="logo-area">
                <span class="logo-sub">ëª½ê¸€ëª½ê¸€í•œ ìš°ë¦¬ë“¤ì˜ í•˜ë£¨</span>
                <h1 class="logo-txt">í–‰ë³µí•œ <span>ìš°ë¦¬ì§‘</span></h1>
            </div>
            <div class="my-profile" id="headerProfile">
                <i class="fa-solid fa-user" style="color:#CED4DA;"></i>
            </div>
        </header>

        <nav class="nav-bar">
            <div class="nav-item active" onclick="changeTab('feed', this)">
                <i class="fa-solid fa-house-chimney"></i><span>í™ˆ</span>
            </div>
            <div class="nav-item" onclick="changeTab('calendar', this)">
                <i class="fa-regular fa-calendar-check"></i><span>ì¼ì •</span>
            </div>
            <div class="nav-item" onclick="changeTab('family', this)">
                <i class="fa-solid fa-face-smile"></i><span>ê°€ì¡±</span>
            </div>
        </nav>

        <main id="mainContent">
            <div id="feed" class="tab-section active">
                <div class="cozy-card">
                    <div style="margin-bottom:15px; font-size:15px; font-weight:700; color:var(--text-sub); display:flex; align-items:center; gap:8px;">
                        <i class="fa-solid fa-pen-nib" style="color:var(--primary);"></i> ì˜¤ëŠ˜ì˜ ê¸°ë¡ ë‚¨ê¸°ê¸°
                    </div>
                    <div class="writer-select" id="writerChips">
                        <div style="font-size:14px; color:#ADB5BD; padding:10px;">ê°€ì¡±ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”! â˜ï¸</div>
                    </div>
                    <textarea id="postContent" class="input-area" placeholder="ì–´ë–¤ ì¦ê±°ìš´ ì¼ì´ ìˆì—ˆë‚˜ìš”? ğŸ˜Š"></textarea>
                    <div id="imagePreviewBox" class="img-preview">
                        <img id="imagePreview" src="">
                        <button class="btn-x" onclick="clearImage()"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; border-top:2px dashed var(--primary-soft); padding-top:20px;">
                        <label for="imageInput" class="photo-btn"><i class="fa-regular fa-image"></i></label>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                        <button id="btnPost" class="btn-jelly" onclick="addPost()">ì˜¬ë¦¬ê¸° <i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
                <div id="loading-spinner" style="text-align:center; padding:40px; color:var(--primary); display:none;">
                    <i class="fa-solid fa-spinner fa-spin" style="font-size:24px;"></i>
                </div>
                <div id="feed-container"></div>
                <div style="text-align:center; margin-top:30px;">
                    <button id="btnLoadMore" class="btn-jelly soft" style="display:none; margin:0 auto; padding:12px 30px;" onclick="loadMorePosts()">ë” ë³´ê¸° ğŸ‘‡</button>
                </div>
            </div>

            <div id="calendar" class="tab-section">
                <div class="cozy-card">
                    <div class="cal-header">
                        <button class="cal-arrow" onclick="moveMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                        <h2 id="month-display" class="cal-title"></h2>
                        <button class="cal-arrow" onclick="moveMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <div class="cal-grid" style="margin-bottom:15px;">
                        <div class="day-name" style="color:var(--primary)">ì¼</div><div class="day-name">ì›”</div><div class="day-name">í™”</div><div class="day-name">ìˆ˜</div><div class="day-name">ëª©</div><div class="day-name">ê¸ˆ</div><div class="day-name">í† </div>
                    </div>
                    <div id="calendar-days" class="cal-grid"></div>
                </div>
            </div>

            <div id="family" class="tab-section">
                <div style="padding:10px 24px 25px; text-align:center;">
                    <h2 class="font-cute" style="font-size:34px; color:var(--primary);">ì‚¬ë‘í•˜ëŠ” ìš°ë¦¬ê°€ì¡± ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</h2>
                </div>
                <div id="family-container" class="family-grid"></div>
                <div id="noFamilyMsg" style="text-align:center; padding:60px; color:var(--text-sub); display:none; font-size:16px;">
                    ê°€ì¡± ë©¤ë²„ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”! ğŸ¤—
                </div>
            </div>
        </main>
    </div>

    <div id="eventModal" class="modal-bg">
        <div class="modal-box">
            <h3 class="modal-tit">ğŸ“… ì¼ì • ì¶”ê°€í•˜ê¸°</h3>
            <p id="modalDateDisplay" style="text-align:center; color:var(--primary); font-weight:700; margin-bottom:25px; font-size:18px;"></p>
            <ul id="eventList" style="list-style:none; margin-bottom:25px; max-height:120px; overflow-y:auto; color:var(--text-main); font-size:15px;"></ul>
            <input type="hidden" id="eventDate">
            <input type="text" id="eventTitle" class="inp-cozy" placeholder="ì¼ì •ì„ ì…ë ¥í•˜ì„¸ìš” âœï¸" onkeydown="handleEnter(event)">
            <div class="modal-btns">
                <button class="btn-m btn-gray" onclick="closeModal('eventModal')">ë‹«ê¸°</button>
                <button class="btn-m btn-pink" onclick="saveEvent()">ì €ì¥! âœ¨</button>
            </div>
        </div>
    </div>

    <div id="familyModal" class="modal-bg">
        <div class="modal-box">
            <h3 class="modal-tit">ğŸ˜Š ê°€ì¡± ë©¤ë²„ ì¶”ê°€</h3>
            <div style="text-align:center; margin-bottom:30px;">
                <label for="famImgInput" style="display:inline-block; cursor:pointer;">
                    <div id="famImgPreview" style="width:110px; height:110px; border-radius:50%; background:#FFF0F3; display:flex; align-items:center; justify-content:center; overflow:hidden; border:4px solid white; box-shadow: var(--shadow-cloud);">
                        <i class="fa-solid fa-camera" style="color:var(--primary); font-size:28px;"></i>
                    </div>
                </label>
                <input type="file" id="famImgInput" accept="image/*" style="display:none;" onchange="handleFamImgSelect(event)">
            </div>
            <input type="text" id="famRole" class="inp-cozy" placeholder="ì—­í•  (ì˜ˆ: ì•„ë¹ , ì²«ì§¸)">
            <input type="text" id="famName" class="inp-cozy" placeholder="ì´ë¦„ (ì„ íƒ)">
            <input type="text" id="famDesc" class="inp-cozy" placeholder="í•œ ë§ˆë”” ì†Œê°œ ğŸ’¬">
            <div class="modal-btns">
                <button class="btn-m btn-gray" onclick="closeModal('familyModal')">ì·¨ì†Œ</button>
                <button id="btnSaveFam" class="btn-m btn-pink" onclick="saveFamily()">ì¶”ê°€í•˜ê¸°! ğŸ‰</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCokmBJyH6xGaB42u_ScP6k7ghEVxTZSio", authDomain: "our-family-home.firebaseapp.com", projectId: "our-family-home", storageBucket: "our-family-home.firebasestorage.app", messagingSenderId: "446464856858", appId: "1:446464856858:web:344f2c83aeda0ea9ae52a3" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore();
        function compressImage(f,mW,cb){const r=new FileReader();r.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');let w=i.width,h=i.height;if(w>mW){h*=mW/w;w=mW;}c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);cb(c.toDataURL('image/jpeg',0.7));};i.src=e.target.result;};r.readAsDataURL(f);}

        let familyData=[], selectedRole="";
        function loadFamily(){
            db.collection("family_members").orderBy("timestamp").onSnapshot(snap=>{
                familyData=[]; const con=document.getElementById('family-container'); const chips=document.getElementById('writerChips');
                con.innerHTML=""; chips.innerHTML=""; document.getElementById('noFamilyMsg').style.display=snap.empty?'block':'none';
                snap.forEach(doc=>{
                    const d=doc.data(); familyData.push({id:doc.id,...d});
                    const imgHtml=d.imageUrl?`<img src="${d.imageUrl}" class="mem-img">`:`<div class="mem-img" style="background:#FFF0F3;display:flex;align-items:center;justify-content:center;"><i class="fa-solid fa-user" style="font-size:28px;color:var(--primary);"></i></div>`;
                    con.innerHTML+=`<div class="member-card"><button class="btn-del" onclick="delFamily('${doc.id}')"><i class="fa-solid fa-xmark"></i></button>${imgHtml}<div class="mem-role">${d.role}</div><div class="mem-name">${d.name||''}</div><div class="mem-desc">${d.desc||'ë°˜ê°€ì›Œìš”!'}</div></div>`;
                    chips.innerHTML+=`<input type="radio" name="auth" id="c-${doc.id}" class="radio-hidden" value="${d.role}" data-id="${doc.id}" onchange="selAuth(this)"><label for="c-${doc.id}" class="writer-chip"><div class="writer-chip-img">${d.imageUrl?`<img src="${d.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`:`<div style="width:100%;height:100%;background:#FFF0F3;display:flex;align-items:center;justify-content:center;"><i class="fa-solid fa-user" style="font-size:12px;color:var(--primary);"></i></div>`}</div> ${d.role}</label>`;
                });
                con.innerHTML+=`<div class="member-card add-card" onclick="openFamModal()"><i class="fa-solid fa-plus-circle" style="font-size:36px;"></i><span style="font-weight:700;">ê°€ì¡± ì¶”ê°€</span></div>`;
                updateHeaderProf();
            });
        }
        function selAuth(rd){ selectedRole=rd.value; updateHeaderProf(); }
        function updateHeaderProf(){ const hp=document.getElementById('headerProfile'); if(!selectedRole){ hp.innerHTML=`<i class="fa-solid fa-user" style="color:#CED4DA;"></i>`; return; } const mem=familyData.find(m=>m.role===selectedRole); if(mem&&mem.imageUrl) hp.innerHTML=`<img src="${mem.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`; else hp.innerHTML=`<i class="fa-solid fa-user" style="color:var(--primary);font-size:20px;"></i>`; }

        let feedImg=null, postLimit=5, unsubFeed=null;
        function handleImageSelect(e){if(e.target.files[0])compressImage(e.target.files[0],800,d=>{feedImg=d;document.getElementById('imagePreview').src=d;document.getElementById('imagePreviewBox').style.display='block';});}
        function clearImage(){feedImg=null;document.getElementById('imageInput').value='';document.getElementById('imagePreviewBox').style.display='none';}
        function addPost(){
            if(!selectedRole) return alert("ëˆ„ê°€ ê¸€ì„ ì“°ë‚˜ìš”? ì†œì‚¬íƒ•ì„ ì„ íƒí•´ì£¼ì„¸ìš”! â˜ï¸"); const txt=document.getElementById('postContent').value, btn=document.getElementById('btnPost');
            if(!txt&&!feedImg) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”! âœï¸"); const mem=familyData.find(m=>m.role===selectedRole); btn.disabled=true; btn.innerHTML="<i class='fa-solid fa-spinner fa-spin'></i> ì €ì¥ ì¤‘...";
            db.collection("family_posts").add({author:selectedRole,authorImg:mem?mem.imageUrl:null,content:txt,imageUrl:feedImg,likes:0,comments:[],timestamp:firebase.firestore.FieldValue.serverTimestamp()})
            .then(()=>{document.getElementById('postContent').value='';clearImage();btn.disabled=false;btn.innerHTML="ì˜¬ë¦¬ê¸° <i class='fa-solid fa-paper-plane'></i>"; window.scrollTo(0,0);})
            .catch(()=>{alert("ì˜¤ë¥˜ê°€ ë‚¬ì–´ìš”! ğŸ˜¢");btn.disabled=false;btn.innerHTML="ì˜¬ë¦¬ê¸° <i class='fa-solid fa-paper-plane'></i>";});
        }
        function loadFeed(){
            if(unsubFeed)unsubFeed(); document.getElementById('loading-spinner').style.display='block';
            unsubFeed=db.collection("family_posts").orderBy("timestamp","desc").limit(postLimit).onSnapshot(snap=>{
                document.getElementById('loading-spinner').style.display='none'; const con=document.getElementById('feed-container'); con.innerHTML="";
                snap.forEach(doc=>renderPost(doc.id,doc.data(),con)); document.getElementById('btnLoadMore').style.display=snap.size>=postLimit?'block':'none';
            });
        }
        function loadMorePosts(){postLimit+=5;loadFeed();}
        function renderPost(id,d,con){
            const pImg=d.authorImg?`<img src="${d.authorImg}" class="fp-img">`:`<div class="fp-img" style="background:#FFF0F3;display:flex;align-items:center;justify-content:center;"><i class="fa-solid fa-user" style="font-size:20px;color:var(--primary);"></i></div>`;
            const contentImg=d.imageUrl?`<div class="feed-photo-frame"><img src="${d.imageUrl}"></div>`:'';
            let cmts=""; if(d.comments)d.comments.forEach(c=>{ const cImg=c.authorImg?`<img src="${c.authorImg}" class="cmt-img">`:`<div class="cmt-img" style="background:#FFF0F3;display:flex;align-items:center;justify-content:center;"><i class="fa-solid fa-user" style="font-size:12px;color:var(--primary);"></i></div>`; cmts+=`<div class="cmt-row">${cImg}<div class="cmt-bubble"><span class="cmt-user">${c.author}</span><span class="cmt-text">${c.text}</span></div></div>`; });
            let cmtOpts=""; familyData.forEach(m=>{ cmtOpts+=`<option value="${m.role}" ${m.role===selectedRole?'selected':''}>${m.role}</option>`; });
            con.innerHTML+=`
            <div class="cozy-card">
                <div class="feed-header"><div class="feed-profile">${pImg}<div class="fp-info"><h4>${d.author}</h4><span>${d.timestamp?new Date(d.timestamp.toDate()).toLocaleDateString():'ë°©ê¸ˆ ì „'}</span></div></div><button onclick="delPost('${id}')" style="border:none;background:none;color:#C8C0B8;font-size:18px;padding:5px;"><i class="fa-solid fa-ellipsis-vertical"></i></button></div>
                <div class="feed-content">${d.content}</div>${contentImg}
                <div class="feed-actions"><button class="action-pill ${d.likes>0?'liked':''}" onclick="likePost('${id}',${d.likes})"><i class="fa-solid fa-heart"></i> ${d.likes||0}</button><button class="action-pill" onclick="toggleCmt('${id}')"><i class="fa-solid fa-comment-dots"></i> ëŒ“ê¸€</button></div>
                <div id="cmt-${id}" class="comment-section"><div style="margin-bottom:15px;max-height:150px;overflow-y:auto;padding-right:5px;">${cmts}</div><div class="cmt-input-box"><select id="cAuth-${id}" class="cmt-select">${cmtOpts}</select><input type="text" id="cInp-${id}" class="cmt-input" placeholder="ëŒ“ê¸€ ë‚¨ê¸°ê¸°... ğŸ’¬" onkeydown="if(event.key==='Enter')addCmt('${id}')"><button class="cmt-btn" onclick="addCmt('${id}')"><i class="fa-solid fa-arrow-up"></i></button></div></div>
            </div>`;
        }
        function likePost(id,n){db.collection("family_posts").doc(id).update({likes:(n||0)+1});}
        function delPost(id){if(confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”? ğŸ¥º"))db.collection("family_posts").doc(id).delete();}
        function toggleCmt(id){document.getElementById(`cmt-${id}`).classList.toggle('show');}
        function addCmt(id){const r=document.getElementById(`cAuth-${id}`).value,t=document.getElementById(`cInp-${id}`).value; if(!t)return; const m=familyData.find(x=>x.role===r); db.collection("family_posts").doc(id).update({comments:firebase.firestore.FieldValue.arrayUnion({author:r,text:t,authorImg:m?m.imageUrl:null})});}

        let curDate=new Date(), events=[], curModDate=null;
        function loadCal(){
            const y=curDate.getFullYear(), m=curDate.getMonth(); document.getElementById('month-display').innerText=`${m+1}ì›”`;
            const f=new Date(y,m,1), l=new Date(y,m+1,0), con=document.getElementById('calendar-days'); con.innerHTML="";
            for(let i=0;i<f.getDay();i++)con.innerHTML+=`<div></div>`;
            for(let i=1;i<=l.getDate();i++){
                const dStr=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`, evs=events.filter(e=>e.date===dStr), hasEv=evs.map(e=>`<div class="event-badge">${e.title}</div>`).join(''), tdy=new Date().toDateString()===new Date(y,m,i).toDateString()?'today':'';
                con.innerHTML+=`<div class="date-cell ${tdy}" onclick="openEvModal('${dStr}')"><span class="date-num">${i}</span>${hasEv}</div>`;
            }
        }
        function moveMonth(n){curDate.setMonth(curDate.getMonth()+n);loadCal();}
        function openEvModal(d){curModDate=d; openModal(`${d} ì¼ì • ğŸ—“ï¸`, `<ul id="evList" style="list-style:none;margin-bottom:15px;padding:0;"></ul><input type="hidden" id="evDate" value="${d}">`, null); renderEvList(); }
        function renderEvList(){const el=document.getElementById('eventList'); const evs=events.filter(e=>e.date===curModDate); el.innerHTML=evs.length?"": "<li style='color:#ccc;text-align:center;padding:10px;'>ì¼ì •ì´ ì—†ì–´ìš”. ğŸ˜´</li>"; evs.forEach(e=>el.innerHTML+=`<li style="display:flex;justify-content:space-between;padding:12px 5px;border-bottom:1px dashed #eee;"><span>${e.title}</span><i class="fa-solid fa-trash" style="color:var(--primary);cursor:pointer;" onclick="delEv('${e.id}')"></i></li>`); 
        document.getElementById('modalDateDisplay').innerText=curModDate; document.getElementById('eventDate').value=curModDate; document.getElementById('eventModal').style.display='flex'; }
        function saveEvent(){const t=document.getElementById('eventTitle').value; if(curModDate&&t) db.collection("family_events").add({date:curModDate,title:t,timestamp:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{document.getElementById('eventTitle').value=''; closeModal('eventModal');});}
        function delEv(id){if(confirm("ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?"))db.collection("family_events").doc(id).delete();}
        db.collection("family_events").orderBy("timestamp").onSnapshot(s=>{events=[];s.forEach(d=>events.push({id:d.id,...d.data()}));loadCal();if(curModDate)renderEvList();});

        let famImg=null;
        function openModal(tit, bodyHtml, confirmFn){ } function closeModal(id){ document.getElementById(id).style.display='none'; famImg=null; curModDate=null; }
        function openFamModal(){ document.getElementById('familyModal').style.display='flex'; }
        function handleFamImgSelect(e){if(e.target.files[0])compressImage(e.target.files[0],500,d=>{famImg=d;document.getElementById('famImgPreview').innerHTML=`<img src="${d}" style="width:100%;height:100%;object-fit:cover;">`;});}
        function saveFam(){
            const r=document.getElementById('famRole').value, n=document.getElementById('famName').value, d=document.getElementById('famDesc').value;
            if(!r)return alert("ì—­í• ì„ ì…ë ¥í•´ì£¼ì„¸ìš”! ğŸ¤”"); const btn=document.getElementById('btnSaveFam'); btn.disabled=true; btn.innerText="ì¶”ê°€í•˜ëŠ” ì¤‘... â˜ï¸";
            db.collection("family_members").add({role:r,name:n,desc:d,imageUrl:famImg,timestamp:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{closeModal('familyModal');btn.disabled=false;btn.innerText="ì¶”ê°€í•˜ê¸°! ğŸ‰";}).catch(()=>{alert("ì˜¤ë¥˜ê°€ ë‚¬ì–´ìš”! ğŸ˜¢");btn.disabled=false;btn.innerText="ì¶”ê°€í•˜ê¸°! ğŸ‰";});
        }
        function delFamily(id){if(confirm("ì •ë§ ë©¤ë²„ë¥¼ ì‚­ì œí• ê¹Œìš”? ğŸ¥º"))db.collection("family_members").doc(id).delete();}
        function handleEnter(e){if(e.key==='Enter'&&!e.isComposing)saveEvent();}

        window.changeTab = function(id, el) {
            document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); if(el) el.classList.add('active');
            window.scrollTo(0,0);
        }
        loadFeed(); loadCal(); loadFamily();
    </script>
</body>
</html>
