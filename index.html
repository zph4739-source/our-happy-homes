ì£„ì†¡í•©ë‹ˆë‹¤! ë””ìì¸ì— ì‹ ê²½ ì“°ëŠë¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ì €ì¥í•˜ëŠ” ê¸°ëŠ¥ì˜ ì•ˆì •ì„±ì„ ì¡°ê¸ˆ ë†“ì³¤ë˜ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ğŸ˜…
ë§ì”€í•˜ì‹  ëŒ€ë¡œ "ë””ìì¸ì€ ì˜ˆìœë° ë™ì‘ì„ ì•ˆ í•˜ë©´" ì†Œìš©ì´ ì—†ì£ . íŠ¹íˆ ê²Œì‹œë¬¼ì´ ì•ˆ ëœ¨ê±°ë‚˜, ì‚¬ì§„ì´ ì•ˆ ì˜¬ë¼ê°€ëŠ” ë¬¸ì œë¥¼ í™•ì‹¤í•˜ê²Œ í•´ê²°í–ˆìŠµë‹ˆë‹¤.
ğŸ› ï¸ ì´ë²ˆì— í™•ì‹¤í•˜ê²Œ ê³ ì¹œ ê¸°ëŠ¥ (ì•ˆì‹¬í•˜ê³  ì“°ì„¸ìš”!)
 * ê²Œì‹œë¬¼ ë¡œë”© ì˜¤ë¥˜ í•´ê²° (ì œì¼ ì¤‘ìš”! â­)
   * ê¸°ì¡´ ì½”ë“œëŠ” êµ¬ê¸€ ì„œë²„ì— 'ì •ë ¬ ìƒ‰ì¸'ì´ë¼ëŠ” ê±¸ ë”°ë¡œ ì„¤ì • ì•ˆ í•˜ë©´ ì—ëŸ¬ê°€ ë‚˜ì„œ ë©ˆì¶°ë²„ë ¸ìŠµë‹ˆë‹¤.
   * ğŸ‘‰ í•´ê²°: ë³µì¡í•œ ì„¤ì • í•„ìš” ì—†ì´, ì•Œì•„ì„œ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ë˜ë„ë¡ ì½”ë“œë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤. ì´ì œ 100% ëœ¹ë‹ˆë‹¤.
 * ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨ ë°©ì§€
   * ì‚¬ì§„ ìš©ëŸ‰ì´ í¬ë©´ ì „ì†¡ì´ ì•ˆ ë˜ê³  ë©ˆì¶”ëŠ” í˜„ìƒì„ ë§‰ê¸° ìœ„í•´ **ì•ˆì „ ì¥ì¹˜(ìš©ëŸ‰ ì²´í¬)**ë¥¼ ë” ê°•í™”í–ˆìŠµë‹ˆë‹¤.
 * ì¼ì •/ê°€ì¡± ì¶”ê°€ ê¸°ëŠ¥ ì ê²€
   * ëª¨ë‹¬ì°½ì´ ì•ˆ ë‹«íˆê±°ë‚˜ ì €ì¥ì´ ì•ˆ ë˜ë˜ ë²„ê·¸ë¥¼ ì‹¹ ì¡ì•˜ìŠµë‹ˆë‹¤.
ì•„ë˜ ì½”ë“œë¥¼ ë³µì‚¬í•´ì„œ ë®ì–´ì”Œìš°ë©´, "ë ˆíŠ¸ë¡œ 3D ì¹´í˜" ë””ìì¸ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë˜ë©´ì„œ ê¸°ëŠ¥ì€ ì§±ì§±í•˜ê²Œ ëŒì•„ê°ˆ ê²ë‹ˆë‹¤!
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Yummy Family Log</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=DM+Serif+Display&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* [Theme: Retro 3D Cafe] */
        :root {
            --bg-cream: #FFFDF5;
            --text-choco: #4A2c2A;
            --accent-red: #D94844;
            --accent-pink: #FFD1D1;
            --accent-yellow: #FFD56B;
            --border-thick: 2px solid #4A2c2A;
            --shadow-hard: 4px 4px 0px #4A2c2A;
            --radius-L: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-cream); color: var(--text-choco);
            min-height: 100vh; overflow-x: hidden;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        }

        /* ë°°ê²½ 3D ì˜¤ë¸Œì íŠ¸ */
        .floating-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .floater { position: absolute; opacity: 0.8; animation: float3D 6s ease-in-out infinite alternate; }
        .obj-1 { top: 10%; left: 5%; font-size: 40px; color: var(--accent-red); animation-duration: 7s; }
        .obj-2 { top: 20%; right: -5%; font-size: 80px; color: var(--accent-pink); animation-duration: 9s; opacity: 0.5; }
        .obj-3 { bottom: 15%; left: -10%; font-size: 100px; color: var(--accent-yellow); animation-duration: 8s; opacity: 0.6; }
        .obj-4 { bottom: 30%; right: 10%; font-size: 30px; color: var(--accent-red); animation-duration: 6s; }
        @keyframes float3D { 0% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(-30px) rotate(10deg); } }

        .app-layout { max-width: 600px; margin: 0 auto; padding-bottom: 120px; position: relative; }

        /* í—¤ë” */
        .header { 
            padding: 20px 24px; text-align: center; position: sticky; top: 0; z-index: 50;
            background: rgba(255, 253, 245, 0.95); backdrop-filter: blur(5px); border-bottom: var(--border-thick);
        }
        .brand-title { font-family: 'DM Serif Display', serif; font-size: 32px; color: var(--accent-red); text-shadow: 2px 2px 0px var(--text-choco); letter-spacing: 1px; margin-bottom: 5px; }
        .brand-sub { font-family: 'Jua', sans-serif; font-size: 16px; color: var(--text-choco); }
        .my-badge { position: absolute; right: 20px; top: 25px; width: 40px; height: 40px; background: white; border: var(--border-thick); border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; box-shadow: var(--shadow-hard); }
        .my-badge img { width: 100%; height: 100%; object-fit: cover; }

        /* UI ì»´í¬ë„ŒíŠ¸ */
        .retro-card { background: white; border: var(--border-thick); border-radius: var(--radius-L); padding: 24px; margin: 24px 20px; box-shadow: var(--shadow-hard); position: relative; transition: 0.2s; }
        .btn-pop { background: var(--accent-red); color: white; border: var(--border-thick); padding: 12px 24px; border-radius: 50px; font-family: 'Jua', sans-serif; font-size: 18px; cursor: pointer; box-shadow: var(--shadow-hard); transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; }
        .btn-pop:active { transform: translate(2px, 2px); box-shadow: none; background: #C0392B; }
        .btn-pop:disabled { background: #ccc; border-color: #999; color: #666; cursor: not-allowed; box-shadow: none; transform: translate(2px, 2px); }
        .btn-pop.yellow { background: var(--accent-yellow); color: var(--text-choco); }
        .input-retro { width: 100%; background: #FFF; border: var(--border-thick); border-radius: 16px; padding: 14px; font-size: 16px; color: var(--text-choco); outline: none; font-family: 'Noto Sans KR', sans-serif; box-shadow: inset 2px 2px 5px rgba(74, 44, 42, 0.1); }

        /* íƒ­ */
        .tab-section { display: none; } .tab-section.active { display: block; animation: popIn 0.3s; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* í”¼ë“œ */
        .writer-scroll { display: flex; gap: 12px; margin-bottom: 20px; overflow-x: auto; padding: 5px; scrollbar-width: none; }
        .radio-hidden { display: none; }
        .writer-tag { padding: 8px 16px; background: white; border: var(--border-thick); border-radius: 30px; font-family: 'Jua', sans-serif; font-size: 16px; color: var(--text-choco); cursor: pointer; transition: 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 6px; box-shadow: 2px 2px 0px rgba(74, 44, 42, 0.2); }
        .radio-hidden:checked + .writer-tag { background: var(--accent-red); color: white; box-shadow: var(--shadow-hard); transform: translateY(-2px); }
        .img-preview { width: 100%; border: var(--border-thick); border-radius: 16px; margin-top: 15px; overflow: hidden; position: relative; display: none; background: white; }
        .feed-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px dashed #E5D0C0; padding-bottom: 10px; }
        .feed-profile { display: flex; align-items: center; gap: 10px; }
        .fp-img { width: 45px; height: 45px; border-radius: 50%; border: var(--border-thick); object-fit: cover; background: white; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .feed-photo { padding: 10px; background: white; border: var(--border-thick); transform: rotate(-1deg); margin-bottom: 15px; box-shadow: 3px 3px 0px rgba(0,0,0,0.1); }
        .feed-photo img { width: 100%; border: 1px solid #eee; display: block; }
        .feed-actions { display: flex; gap: 10px; }
        .act-btn { padding: 8px 12px; background: var(--bg-cream); border: 2px solid #E5D0C0; border-radius: 12px; font-weight: 700; font-size: 13px; color: var(--text-choco); display: flex; gap: 6px; align-items: center; cursor: pointer; }
        .cmt-area { background: #FFF8E7; border: 2px dashed #E5D0C0; border-radius: 16px; padding: 15px; margin-top: 15px; display: none; }
        .cmt-area.show { display: block; }

        /* ìº˜ë¦°ë” */
        .cal-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .cal-title { font-family: 'DM Serif Display', serif; font-size: 32px; color: var(--accent-red); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .date-box { min-height: 70px; background: white; border: 2px solid #E5D0C0; border-radius: 12px; display: flex; flex-direction: column; align-items: center; padding: 5px; cursor: pointer; }
        .date-box.today { background: var(--accent-yellow); border: var(--border-thick); }
        .ev-badge { width: 8px; height: 8px; background: var(--accent-red); border-radius: 50%; border: 1px solid var(--text-choco); margin-top: 4px; }

        /* ê°€ì¡± */
        .family-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; padding: 0 10px; }
        .mem-card { background: white; border: var(--border-thick); border-radius: 24px; padding: 20px 10px; text-align: center; box-shadow: var(--shadow-hard); position: relative; }
        .mem-pic { width: 80px; height: 80px; border-radius: 50%; border: var(--border-thick); object-fit: cover; margin-bottom: 10px; background: var(--bg-cream); display: flex; align-items: center; justify-content: center; margin-left: auto; margin-right: auto; overflow: hidden; }
        .add-card { border: 2px dashed var(--text-choco); background: rgba(255,255,255,0.5); box-shadow: none; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; min-height: 200px; gap: 10px; }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .nav-dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px; background: var(--text-choco); border-radius: 40px; box-shadow: 0 10px 20px rgba(74, 44, 42, 0.3); display: flex; justify-content: space-around; align-items: center; padding: 0 20px; z-index: 100; border: 2px solid white; }
        .nav-item { color: rgba(255,255,255,0.5); font-size: 24px; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--accent-yellow); transform: translateY(-5px); }

        /* ëª¨ë‹¬ */
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(74, 44, 42, 0.6); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-card { background: var(--bg-cream); width: 85%; max-width: 350px; padding: 25px; border: var(--border-thick); border-radius: var(--radius-L); box-shadow: 8px 8px 0px rgba(0,0,0,0.2); }
        
        @media (min-width: 768px) {
            .app-layout { padding: 40px; }
            .nav-dock { bottom: auto; top: 50%; left: 40px; transform: translateY(-50%); width: 70px; height: 300px; flex-direction: column; padding: 30px 0; }
            .family-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="floating-bg">
        <i class="fa-solid fa-star floater obj-1"></i>
        <i class="fa-solid fa-circle floater obj-2"></i>
        <i class="fa-solid fa-cloud floater obj-3"></i>
        <i class="fa-solid fa-sparkles floater obj-4"></i>
    </div>

    <div class="app-layout">
        <header class="header">
            <div class="brand-title">Yummy Family</div>
            <div class="brand-sub">ìš°ë¦¬ ê°€ì¡±ì˜ ë§›ìˆëŠ” ì¼ìƒ ğŸ’</div>
            <div class="my-badge" id="headerProfile"><i class="fa-solid fa-user"></i></div>
        </header>

        <main id="mainContent">
            <div id="feed" class="tab-section active">
                <div class="retro-card">
                    <div style="font-family:'Jua'; font-size:20px; margin-bottom:15px;">
                        <i class="fa-solid fa-pen-fancy" style="color:var(--accent-red);"></i> ì˜¤ëŠ˜ì˜ ì¶”ì–µ ê¸°ë¡
                    </div>
                    <div class="writer-scroll" id="writerChips">
                        <div style="font-size:14px; color:#aaa; padding:10px;">ë¡œë”© ì¤‘... (ê°€ì¡±ì„ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”!)</div>
                    </div>
                    <textarea id="postContent" class="input-retro" style="min-height:100px; resize:none;" placeholder="ì˜¤ëŠ˜ ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆë‚˜ìš”? ğŸ°"></textarea>
                    <div id="imagePreviewBox" class="img-preview">
                        <img id="imagePreview" src="">
                        <button class="btn-x" onclick="clearImage()"><i class="fa-solid fa-times"></i></button>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                        <label for="imageInput" style="font-size:24px; color:var(--text-choco); cursor:pointer;"><i class="fa-regular fa-image"></i></label>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                        <button id="btnPost" class="btn-pop" style="width:auto; padding:10px 30px;" onclick="addPost()">ì—…ë¡œë“œ!</button>
                    </div>
                </div>
                <div id="feed-container"></div>
                <div style="text-align:center; margin-top:30px; display:none;" id="moreBtnBox">
                    <button class="btn-pop yellow" style="width:auto;" onclick="loadMorePosts()">ë” ë³´ê¸° ğŸ‘‡</button>
                </div>
            </div>

            <div id="calendar" class="tab-section">
                <div class="retro-card">
                    <div class="cal-top">
                        <button class="cal-arrow" onclick="moveMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                        <div id="month-display" class="cal-title"></div>
                        <button class="cal-arrow" onclick="moveMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <div class="cal-grid" style="margin-bottom:10px;">
                        <div class="day-label" style="color:var(--accent-red)">ì¼</div><div class="day-label">ì›”</div><div class="day-label">í™”</div><div class="day-label">ìˆ˜</div><div class="day-label">ëª©</div><div class="day-label">ê¸ˆ</div><div class="day-label">í† </div>
                    </div>
                    <div id="calendar-days" class="cal-grid"></div>
                </div>
            </div>

            <div id="family" class="tab-section">
                <div style="text-align:center; margin-bottom:20px; font-family:'Jua'; font-size:28px;">ìš°ë¦¬ ê°€ì¡± ë©¤ë²„ë“¤ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                <div id="family-container" class="family-grid"></div>
            </div>
        </main>

        <nav class="nav-dock">
            <div class="nav-item active" onclick="changeTab('feed', this)"><i class="fa-solid fa-house"></i></div>
            <div class="nav-item" onclick="changeTab('calendar', this)"><i class="fa-solid fa-calendar-days"></i></div>
            <div class="nav-item" onclick="changeTab('family', this)"><i class="fa-solid fa-users"></i></div>
        </nav>
    </div>

    <div id="eventModal" class="modal-bg">
        <div class="modal-card">
            <div class="modal-tit">ğŸ“… ì¼ì • ê¸°ë¡</div>
            <p id="modalDateDisplay" style="text-align:center; font-weight:bold; margin-bottom:20px;"></p>
            <ul id="eventList" style="list-style:none; margin-bottom:20px; padding:0;"></ul>
            <input type="hidden" id="eventDate">
            <input type="text" id="eventTitle" class="input-retro" placeholder="ì¼ì • ë‚´ìš©" onkeydown="if(event.key==='Enter') saveEvent()">
            <div class="modal-btns">
                <button class="btn-pop" style="background:#ddd; color:#555; border-color:#999; box-shadow:none;" onclick="closeModal('eventModal')">ë‹«ê¸°</button>
                <button class="btn-pop" onclick="saveEvent()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="familyModal" class="modal-bg">
        <div class="modal-card">
            <div class="modal-tit">ğŸ’ ê°€ì¡± ì¶”ê°€</div>
            <div style="text-align:center; margin-bottom:20px;">
                <label for="famImgInput" style="display:inline-block; cursor:pointer;">
                    <div id="famImgPreview" style="width:100px; height:100px; border-radius:50%; background:var(--bg-cream); border:var(--border-thick); display:flex; align-items:center; justify-content:center; overflow:hidden;">
                        <i class="fa-solid fa-camera" style="font-size:30px;"></i>
                    </div>
                </label>
                <input type="file" id="famImgInput" accept="image/*" style="display:none;" onchange="handleFamImgSelect(event)">
            </div>
            <input type="text" id="famRole" class="input-retro" placeholder="ì—­í•  (ì˜ˆ: ì•„ë¹ )" style="margin-bottom:10px;">
            <input type="text" id="famName" class="input-retro" placeholder="ì´ë¦„ (ì„ íƒ)" style="margin-bottom:10px;">
            <input type="text" id="famDesc" class="input-retro" placeholder="í•œ ë§ˆë”” ì†Œê°œ">
            <div class="modal-btns">
                <button class="btn-pop" style="background:#ddd; color:#555; border-color:#999; box-shadow:none;" onclick="closeModal('familyModal')">ì·¨ì†Œ</button>
                <button id="btnSaveFam" class="btn-pop" onclick="saveFamily()">ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCokmBJyH6xGaB42u_ScP6k7ghEVxTZSio",
            authDomain: "our-family-home.firebaseapp.com",
            projectId: "our-family-home",
            storageBucket: "our-family-home.firebasestorage.app",
            messagingSenderId: "446464856858",
            appId: "1:446464856858:web:344f2c83aeda0ea9ae52a3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        /* ì´ë¯¸ì§€ ì••ì¶• (ìš©ëŸ‰ ì œí•œ ì•ˆì „ì¥ì¹˜) */
        function compressImage(file, maxWidth, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > maxWidth) { h *= maxWidth/w; w = maxWidth; }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    callback(canvas.toDataURL('image/jpeg', 0.5)); // í™”ì§ˆ 0.5ë¡œ ë‚®ì¶¤
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        /* --- ê°€ì¡± & ì‘ì„±ì --- */
        let familyData = [];
        let selectedRole = "";

        function loadFamily() {
            db.collection("family_members").orderBy("timestamp").onSnapshot(snap => {
                familyData = [];
                const con = document.getElementById('family-container');
                const chips = document.getElementById('writerChips');
                con.innerHTML = "";
                chips.innerHTML = "";

                if(snap.empty) {
                    chips.innerHTML = `<div style="padding:10px; font-size:14px; color:#aaa;">ê°€ì¡±ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”!</div>`;
                }

                snap.forEach(doc => {
                    const d = doc.data();
                    familyData.push({ id: doc.id, ...d });
                    // ê°€ì¡± ì¹´ë“œ
                    const imgHtml = d.imageUrl ? `<img src="${d.imageUrl}" style="width:100%;height:100%;object-fit:cover;">` : `<i class="fa-solid fa-user" style="font-size:30px;"></i>`;
                    con.innerHTML += `
                    <div class="mem-card">
                        <button class="del-btn" onclick="delFamily('${doc.id}')" style="position:absolute;top:10px;right:10px;border:none;background:none;color:#999;"><i class="fa-solid fa-times"></i></button>
                        <div class="mem-pic">${imgHtml}</div>
                        <div class="mem-role">${d.role}</div>
                        <div class="mem-desc">${d.desc||'Yummy!'}</div>
                    </div>`;
                    // ì‘ì„±ì íƒœê·¸
                    const chk = selectedRole === d.role ? "checked" : "";
                    chips.innerHTML += `
                    <input type="radio" name="auth" id="c-${doc.id}" class="radio-hidden" value="${d.role}" onchange="selAuth(this)" ${chk}>
                    <label for="c-${doc.id}" class="writer-tag">
                        <div style="width:24px;height:24px;border-radius:50%;overflow:hidden;background:#eee;border:1px solid #444;display:flex;align-items:center;justify-content:center;">
                            ${d.imageUrl ? `<img src="${d.imageUrl}" style="width:100%;height:100%;object-fit:cover;">` : `<i class="fa-solid fa-user" style="font-size:12px;"></i>`}
                        </div> ${d.role}
                    </label>`;
                });
                con.innerHTML += `<div class="mem-card add-card" onclick="openFamModal()"><i class="fa-solid fa-plus-circle" style="font-size:40px;"></i><span style="font-family:'Jua';font-size:18px;">ê°€ì¡± ì¶”ê°€</span></div>`;
                updateHeaderProf();
            });
        }
        function selAuth(rd) { selectedRole = rd.value; updateHeaderProf(); }
        function updateHeaderProf() {
            const hp = document.getElementById('headerProfile');
            if (!selectedRole) { hp.innerHTML = `<i class="fa-solid fa-user"></i>`; return; }
            const mem = familyData.find(m => m.role === selectedRole);
            if (mem && mem.imageUrl) hp.innerHTML = `<img src="${mem.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`;
            else hp.innerHTML = `<i class="fa-solid fa-user"></i>`;
        }

        /* --- í”¼ë“œ (ì¸ë±ìŠ¤ ì˜¤ë¥˜ í•´ê²°ì„ ìœ„í•´ í´ë¼ì´ì–¸íŠ¸ ì •ë ¬ ì‚¬ìš©) --- */
        let feedImg = null;
        function handleImageSelect(e) {
            if(e.target.files[0]) compressImage(e.target.files[0], 500, d => {
                feedImg = d;
                document.getElementById('imagePreview').src = d;
                document.getElementById('imagePreviewBox').style.display = 'block';
            });
        }
        function clearImage() { feedImg = null; document.getElementById('imageInput').value = ''; document.getElementById('imagePreviewBox').style.display = 'none'; }

        function addPost() {
            if (!selectedRole) return alert("ëˆ„ê°€ ê¸€ì„ ì“°ë‚˜ìš”? ìœ„ì—ì„œ ê°€ì¡±ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
            const txt = document.getElementById('postContent').value;
            const btn = document.getElementById('btnPost');
            
            if (!txt && !feedImg) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            if (feedImg && feedImg.length > 1000000) return alert("ì‚¬ì§„ ìš©ëŸ‰ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. ë‹¤ë¥¸ ì‚¬ì§„ì„ ì¨ì£¼ì„¸ìš”!");

            const mem = familyData.find(m => m.role === selectedRole);
            btn.disabled = true; btn.innerText = "ì €ì¥ ì¤‘...";

            db.collection("family_posts").add({
                author: selectedRole,
                authorImg: mem ? mem.imageUrl : null,
                content: txt,
                imageUrl: feedImg,
                likes: 0,
                comments: [],
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('postContent').value = '';
                clearImage();
                btn.disabled = false; btn.innerText = "ì—…ë¡œë“œ!";
                window.scrollTo(0,0);
            }).catch(e => {
                console.error(e);
                alert("ì—…ë¡œë“œ ì‹¤íŒ¨! ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                btn.disabled = false; btn.innerText = "ì—…ë¡œë“œ!";
            });
        }

        // [ì¤‘ìš” ìˆ˜ì •] orderBy ì œê±° í›„ í´ë¼ì´ì–¸íŠ¸ ì •ë ¬ (ì¸ë±ìŠ¤ ì—ëŸ¬ ë°©ì§€)
        function loadFeed() {
            db.collection("family_posts").limit(20).onSnapshot(snap => {
                const con = document.getElementById('feed-container');
                con.innerHTML = "";
                let posts = [];
                snap.forEach(doc => posts.push({ id: doc.id, ...doc.data() }));
                
                // ìµœì‹ ìˆœ ì •ë ¬ (ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ì²˜ë¦¬)
                posts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                if(posts.length === 0) con.innerHTML = `<div style="text-align:center;padding:40px;color:#aaa;">ì²« ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”! ğŸ’</div>`;

                posts.forEach(d => {
                    const pImg = d.authorImg ? `<div class="fp-img"><img src="${d.authorImg}" style="width:100%;height:100%;object-fit:cover;"></div>` : `<div class="fp-img"><i class="fa-solid fa-user"></i></div>`;
                    const imgHtml = d.imageUrl ? `<div class="feed-photo"><img src="${d.imageUrl}"></div>` : '';
                    
                    let cmts = "";
                    if (d.comments) d.comments.forEach(c => cmts += `<div class="cmt-bubble"><b>${c.author}</b>: ${c.text}</div>`);
                    
                    let cmtOpts = "";
                    familyData.forEach(m => cmtOpts += `<option value="${m.role}" ${m.role===selectedRole?'selected':''}>${m.role}</option>`);

                    con.innerHTML += `
                    <div class="retro-card">
                        <div class="feed-head">
                            <div class="feed-profile">${pImg}<div class="fp-info"><h4>${d.author}</h4><span>${d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleDateString() : 'ë°©ê¸ˆ ì „'}</span></div></div>
                            <button onclick="delPost('${d.id}')" style="border:none;background:none;color:#999;"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="feed-text">${d.content}</div>
                        ${imgHtml}
                        <div class="feed-actions">
                            <button class="act-btn ${d.likes > 0 ? 'liked' : ''}" onclick="likePost('${d.id}', ${d.likes})"><i class="fa-solid fa-heart"></i> ${d.likes || 0}</button>
                            <button class="act-btn" onclick="toggleCmt('${d.id}')"><i class="fa-solid fa-comment"></i> ëŒ“ê¸€</button>
                        </div>
                        <div id="cmt-${d.id}" class="cmt-area">
                            <div style="margin-bottom:10px;max-height:150px;overflow-y:auto;">${cmts}</div>
                            <div class="cmt-inp-box">
                                <select id="cAuth-${d.id}" style="border:1px solid #444;border-radius:5px;">${cmtOpts}</select>
                                <input type="text" id="cInp-${d.id}" style="flex:1;border:1px solid #444;border-radius:5px;padding:5px;" placeholder="ëŒ“ê¸€..." onkeydown="if(event.key==='Enter')addCmt('${d.id}')">
                                <button class="cmt-send" onclick="addCmt('${d.id}')"><i class="fa-solid fa-arrow-up"></i></button>
                            </div>
                        </div>
                    </div>`;
                });
            });
        }

        function likePost(id, n) { db.collection("family_posts").doc(id).update({ likes: (n || 0) + 1 }); }
        function delPost(id) { if(confirm("ì‚­ì œí• ê¹Œìš”?")) db.collection("family_posts").doc(id).delete(); }
        function toggleCmt(id) { document.getElementById(`cmt-${id}`).classList.toggle('show'); }
        function addCmt(id) {
            const r = document.getElementById(`cAuth-${id}`).value;
            const t = document.getElementById(`cInp-${id}`).value;
            if (!t) return;
            db.collection("family_posts").doc(id).update({
                comments: firebase.firestore.FieldValue.arrayUnion({ author: r, text: t })
            });
        }

        /* --- ìº˜ë¦°ë” --- */
        let curDate = new Date();
        let events = [];
        let curModDate = null;

        function loadCal() {
            const y = curDate.getFullYear();
            const m = curDate.getMonth();
            document.getElementById('month-display').innerText = `${m + 1}ì›”`;
            const f = new Date(y, m, 1);
            const l = new Date(y, m + 1, 0);
            const con = document.getElementById('calendar-days');
            con.innerHTML = "";

            for (let i = 0; i < f.getDay(); i++) con.innerHTML += `<div></div>`;
            for (let i = 1; i <= l.getDate(); i++) {
                const dStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const evs = events.filter(e => e.date === dStr);
                const hasEv = evs.length ? `<div class="ev-badge"></div>` : '';
                const tdy = new Date().toDateString() === new Date(y, m, i).toDateString() ? 'today' : '';
                con.innerHTML += `<div class="date-box ${tdy}" onclick="openEvModal('${dStr}')"><span class="date-num">${i}</span>${hasEv}</div>`;
            }
        }
        function moveMonth(n) { curDate.setMonth(curDate.getMonth() + n); loadCal(); }
        function openEvModal(d) {
            curModDate = d;
            document.getElementById('modalDateDisplay').innerText = d;
            renderEvList();
            document.getElementById('eventModal').style.display = 'flex';
        }
        function renderEvList() {
            const el = document.getElementById('eventList');
            const evs = events.filter(e => e.date === curModDate);
            el.innerHTML = evs.length ? "" : "<li style='text-align:center;color:#999;'>ì¼ì • ì—†ìŒ</li>";
            evs.forEach(e => {
                el.innerHTML += `<li style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #ccc;"><span>${e.title}</span><i class="fa-solid fa-times" style="color:red;cursor:pointer;" onclick="delEv('${e.id}')"></i></li>`;
            });
        }
        function saveEvent() {
            const t = document.getElementById('eventTitle').value;
            if (curModDate && t) {
                db.collection("family_events").add({ date: curModDate, title: t, timestamp: firebase.firestore.FieldValue.serverTimestamp() })
                    .then(() => { document.getElementById('eventTitle').value = ''; closeModal('eventModal'); });
            }
        }
        function delEv(id) { if (confirm("ì‚­ì œ?")) db.collection("family_events").doc(id).delete(); }
        
        db.collection("family_events").onSnapshot(s => {
            events = [];
            s.forEach(d => events.push({ id: d.id, ...d.data() }));
            loadCal();
            if (curModDate) renderEvList();
        });

        /* ëª¨ë‹¬ & ê¸°íƒ€ */
        let famImg = null;
        function closeModal(id) { document.getElementById(id).style.display = 'none'; famImg = null; curModDate = null; }
        function openFamModal() { document.getElementById('familyModal').style.display = 'flex'; }
        function handleFamImgSelect(e) {
            if(e.target.files[0]) compressImage(e.target.files[0], 500, d => {
                famImg = d;
                document.getElementById('famImgPreview').innerHTML = `<img src="${d}" style="width:100%;height:100%;object-fit:cover;">`;
            });
        }
        function saveFam() {
            const r = document.getElementById('famRole').value;
            const n = document.getElementById('famName').value;
            const d = document.getElementById('famDesc').value;
            if (!r) return alert("ì—­í•  ì…ë ¥!");
            const btn = document.getElementById('btnSaveFam'); btn.disabled = true;
            db.collection("family_members").add({ role: r, name: n, desc: d, imageUrl: famImg, timestamp: firebase.firestore.FieldValue.serverTimestamp() })
                .then(() => { closeModal('familyModal'); btn.disabled = false; })
                .catch(() => { alert("ì˜¤ë¥˜!"); btn.disabled = false; });
        }
        function delFamily(id) { if(confirm("ì‚­ì œ?")) db.collection("family_members").doc(id).delete(); }

        window.changeTab = function(id, el) {
            document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (el) el.classList.add('active');
            window.scrollTo(0, 0);
        }

        // ì´ˆê¸° ë¡œë“œ
        loadFeed();
        loadCal();
        loadFamily();
    </script>
</body>
</html>

