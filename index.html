<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ìš°ë¦¬ ê°€ì¡±ì˜ ê³µê°„</title>
    
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* [Design System: Modern Hearth] */
        :root {
            /* Color Palette */
            --bg-main: #F9FAFB; /* ì•„ì£¼ ì—°í•œ íšŒìƒ‰ë¹› ë°°ê²½ (ëˆˆì´ í¸ì•ˆí•¨) */
            --bg-white: #FFFFFF;
            --text-primary: #1F2937; /* ì§„í•œ ì°¨ì½œìƒ‰ (ì™„ì „ ê²€ì •ë³´ë‹¤ ë¶€ë“œëŸ¬ì›€) */
            --text-secondary: #6B7280; /* ì¤‘ê°„ íšŒìƒ‰ */
            --text-tertiary: #9CA3AF; /* ì—°í•œ íšŒìƒ‰ */
            
            /* Accent Color: ë”°ëœ»í•˜ê³  ì„¸ë ¨ëœ í…Œë¼ì½”íƒ€/ì½”ë„ */
            --accent: #E07A5F; 
            --accent-light: #FDECE8;
            --accent-dark: #C05F45;

            /* UI Elements */
            --border-color: #E5E7EB;
            --radius-L: 24px;
            --radius-M: 16px;
            --radius-S: 12px;
            
            /* Shadows: ê¹Šì´ê° ìˆê³  ë¶€ë“œëŸ½ê²Œ */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
        }

        /* ê¸°ë³¸ ì„¤ì • */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: var(--bg-main); color: var(--text-primary);
            min-height: 100vh; overflow-x: hidden; line-height: 1.5;
        }
        button, select, input, textarea { font-family: inherit; }

        /* ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ */
        .app-container { max-width: 640px; margin: 0 auto; padding-bottom: 110px; background: var(--bg-main); min-height: 100vh; }

        /* --- [í—¤ë”] --- */
        .header { 
            padding: 24px 24px 16px; display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-main); position: sticky; top: 0; z-index: 50;
        }
        .header h1 { font-size: 26px; font-weight: 800; color: var(--text-primary); letter-spacing: -0.02em; }
        .header-profile { 
            width: 44px; height: 44px; border-radius: 50%; background: var(--accent-light); 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            border: 2px solid var(--bg-white); box-shadow: var(--shadow-sm); color: var(--accent); font-size: 20px; transition: 0.3s;
        }
        .header-profile img { width: 100%; height: 100%; object-fit: cover; }

        /* --- [íƒ­ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜] --- */
        .tab-content { display: none; animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .tab-content.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* --- [ê³µí†µ UI ì»´í¬ë„ŒíŠ¸] --- */
        /* ì¹´ë“œ: ê¹¨ë—í•˜ê³  ì •ëˆëœ ëŠë‚Œ */
        .card {
            background: var(--bg-white); border-radius: var(--radius-L); padding: 24px; margin: 0 20px 24px;
            box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
        }

        /* ë²„íŠ¼: ì„¸ë ¨ë˜ê³  ê²¬ê³ í•˜ê²Œ */
        .btn-primary {
            background: var(--accent); color: white; border: none; padding: 14px 24px; border-radius: var(--radius-M);
            font-size: 16px; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%;
        }
        .btn-primary:active { background: var(--accent-dark); transform: scale(0.98); }
        .btn-primary:disabled { background: var(--text-tertiary); cursor: not-allowed; }
        .btn-icon { padding: 8px; color: var(--text-secondary); background: none; border: none; font-size: 20px; cursor: pointer; border-radius: 50%; transition: 0.2s; }
        .btn-icon:hover { background: var(--bg-main); color: var(--text-primary); }

        /* ì…ë ¥ì°½: ë¶€ë“œëŸ¬ìš´ ë°°ê²½ */
        .input-field {
            width: 100%; background: var(--bg-main); border: 1px solid var(--border-color); border-radius: var(--radius-M);
            padding: 14px 16px; font-size: 16px; color: var(--text-primary); outline: none; transition: 0.2s; resize: none;
        }
        .input-field::placeholder { color: var(--text-tertiary); }
        .input-field:focus { border-color: var(--accent); background: var(--bg-white); box-shadow: 0 0 0 3px var(--accent-light); }

        /* ì´ë¯¸ì§€ ë°•ìŠ¤ (ê¹¨ì§ ë°©ì§€) */
        .img-box { width: 100%; background: var(--bg-main); border-radius: var(--radius-M); overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .img-placeholder { padding: 40px; color: var(--text-tertiary); font-size: 32px; }

        /* --- [íƒ­ 1: í”¼ë“œ] --- */
        /* ì‘ì„±ì ì„ íƒ ì¹© */
        .writer-select-wrap { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding: 4px; scrollbar-width: none; }
        .writer-select-wrap::-webkit-scrollbar { display: none; }
        .writer-radio { display: none; }
        .writer-chip {
            padding: 10px 20px; background: var(--bg-main); border: 1px solid var(--border-color); border-radius: 30px;
            font-size: 15px; color: var(--text-secondary); font-weight: 600; cursor: pointer; transition: 0.2s; white-space: nowrap;
            display: flex; align-items: center; gap: 8px;
        }
        .writer-avatar-small { width: 24px; height: 24px; border-radius: 50%; background: var(--accent-light); overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--accent); }
        .writer-radio:checked + .writer-chip { background: var(--accent); color: white; border-color: var(--accent); box-shadow: var(--shadow-md); }
        .writer-radio:checked + .writer-chip .writer-avatar-small { background: white; color: var(--accent); }

        /* ê²Œì‹œë¬¼ ë””ìì¸ */
        .feed-item { padding-bottom: 20px; }
        .feed-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .feed-profile-wrap { display: flex; align-items: center; gap: 12px; }
        .feed-avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--accent-light); overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--accent); border: 1px solid var(--border-color); }
        .feed-info h4 { font-size: 17px; font-weight: 700; margin-bottom: 2px; }
        .feed-info span { font-size: 13px; color: var(--text-secondary); }
        .feed-body { font-size: 16px; line-height: 1.6; color: var(--text-primary); margin-bottom: 16px; white-space: pre-wrap; }
        .feed-actions { display: flex; gap: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); }
        .action-btn { 
            display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-weight: 600; font-size: 14px; 
            background: none; border: none; cursor: pointer; transition: 0.2s; padding: 8px 12px; border-radius: var(--radius-S);
        }
        .action-btn:hover { background: var(--bg-main); color: var(--text-primary); }
        .action-btn.liked { color: var(--accent); background: var(--accent-light); }

        /* ëŒ“ê¸€ */
        .comment-box { background: var(--bg-main); border-radius: var(--radius-M); padding: 20px; margin-top: 16px; display: none; }
        .comment-box.show { display: block; }
        .cmt-item { display: flex; gap: 10px; margin-bottom: 16px; }
        .cmt-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--accent-light); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--accent); overflow: hidden; }
        .cmt-content { background: var(--bg-white); padding: 10px 14px; border-radius: 4px 16px 16px 16px; box-shadow: var(--shadow-sm); flex: 1; border: 1px solid var(--border-color); }
        .cmt-author { font-size: 13px; font-weight: 700; margin-bottom: 2px; display: block; }
        .cmt-text { font-size: 14px; color: var(--text-primary); }
        .cmt-input-wrap { display: flex; gap: 10px; margin-top: 20px; }

        /* --- [íƒ­ 2: ìº˜ë¦°ë”] --- */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .cal-title { font-size: 24px; font-weight: 800; color: var(--text-primary); }
        .cal-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--bg-main); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; color: var(--text-secondary); cursor: pointer; transition: 0.2s; }
        .cal-btn:hover { background: var(--bg-white); color: var(--accent); border-color: var(--accent); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
        .day-label { font-size: 13px; color: var(--text-tertiary); font-weight: 600; margin-bottom: 12px; }
        .date-cell { 
            min-height: 75px; background: var(--bg-white); border-radius: var(--radius-S); border: 1px solid var(--border-color);
            display: flex; flex-direction: column; align-items: center; padding: 8px 4px; gap: 4px; cursor: pointer; transition: 0.2s; position: relative;
        }
        .date-cell:hover { border-color: var(--accent); background: var(--accent-light); }
        .date-cell.today { background: var(--accent); color: white; border-color: var(--accent); }
        .event-marker { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); margin-top: 4px; }
        .date-cell.today .event-marker { background: white; }

        /* --- [íƒ­ 3: ê°€ì¡±] --- */
        .family-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; padding: 0 20px; }
        .member-card { 
            background: var(--bg-white); border-radius: var(--radius-L); padding: 24px 16px; text-align: center; 
            box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); position: relative; transition: 0.3s;
        }
        .member-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .mem-avatar-large { width: 80px; height: 80px; border-radius: 50%; background: var(--accent-light); margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 32px; color: var(--accent); overflow: hidden; border: 3px solid var(--bg-main); }
        .mem-role { font-size: 18px; font-weight: 800; margin-bottom: 4px; }
        .mem-name { font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; }
        .mem-desc { font-size: 13px; color: var(--text-secondary); background: var(--bg-main); padding: 6px 12px; border-radius: 20px; display: inline-block; }
        .btn-delete-mem { position: absolute; top: 12px; right: 12px; color: var(--text-tertiary); background: none; border: none; cursor: pointer; padding: 4px; opacity: 0.6; transition: 0.2s; }
        .btn-delete-mem:hover { opacity: 1; color: var(--accent); }
        
        .add-member-card { background: var(--bg-main); border: 2px dashed var(--border-color); color: var(--text-tertiary); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 220px; gap: 12px; cursor: pointer; font-weight: 600; }
        .add-member-card:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }

        /* --- [ë„¤ë¹„ê²Œì´ì…˜ë°” (ëª¨ë°”ì¼ ìµœì í™”)] --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 80px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color); box-shadow: var(--shadow-lg);
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom); z-index: 100;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-tertiary); cursor: pointer; transition: 0.3s; width: 100%; gap: 4px; }
        .nav-item i { font-size: 24px; transition: 0.3s; }
        .nav-item span { font-size: 11px; font-weight: 600; }
        .nav-item.active { color: var(--accent); }
        .nav-item.active i { transform: translateY(-2px); }

        /* --- [ëª¨ë‹¬] --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: var(--bg-white); width: 90%; max-width: 380px; padding: 32px; border-radius: var(--radius-L); box-shadow: var(--shadow-lg); animation: modalUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes modalUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-title { font-size: 22px; font-weight: 800; margin-bottom: 24px; text-align: center; }
        .modal-actions { display: flex; gap: 12px; margin-top: 24px; }

        /* --- [ë¹ˆ ìƒíƒœ (Empty State)] --- */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-tertiary); }
        .empty-state i { font-size: 48px; margin-bottom: 16px; color: var(--border-color); }
        .empty-state p { font-size: 16px; font-weight: 600; }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="header">
            <h1>ìš°ë¦¬ ê°€ì¡± ê³µê°„</h1>
            <div class="header-profile" id="headerProfile">
                <i class="fa-solid fa-user"></i>
            </div>
        </header>

        <main>
            <div id="feed" class="tab-content active">
                <div class="card">
                    <div style="margin-bottom:16px; font-weight:700; color:var(--text-secondary);">ì˜¤ëŠ˜ì˜ ì´ì•¼ê¸° ê¸°ë¡í•˜ê¸° âœï¸</div>
                    
                    <div class="writer-select-wrap" id="writerChips">
                        <div style="padding:10px; color:var(--text-tertiary); font-size:14px;">ê°€ì¡± ë©¤ë²„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                    
                    <textarea id="postContent" class="input-field" style="min-height:100px;" placeholder="ì–´ë–¤ í•˜ë£¨ë¥¼ ë³´ë‚´ì…¨ë‚˜ìš”?"></textarea>
                    
                    <div id="imagePreviewBox" class="img-box" style="display:none; margin-top:16px; height:auto; max-height:300px;">
                        <img id="imagePreview" src="" onerror="this.style.display='none';">
                        <button onclick="clearImage()" style="position:absolute; top:12px; right:12px; background:rgba(0,0,0,0.6); color:white; border:none; width:32px; height:32px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-xmark"></i></button>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                        <label for="imageInput" class="btn-icon" style="background:var(--bg-main);"><i class="fa-regular fa-image"></i></label>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                        <button id="btnPost" class="btn-primary" style="width:auto; padding-left:32px; padding-right:32px;" onclick="addPost()">ì˜¬ë¦¬ê¸°</button>
                    </div>
                </div>

                <div id="loading-spinner" style="text-align:center; padding:40px; color:var(--accent); display:none;">
                    <i class="fa-solid fa-circle-notch fa-spin" style="font-size:28px;"></i>
                </div>
                
                <div id="feed-container"></div>
                
                <div style="text-align:center; margin-top:24px;">
                    <button id="btnLoadMore" class="btn-primary" style="display:none; margin:0 auto; background:var(--accent-light); color:var(--accent); width:auto;" onclick="loadMorePosts()">ë” ë³´ê¸°</button>
                </div>
            </div>

            <div id="calendar" class="tab-content">
                <div class="card">
                    <div class="cal-header">
                        <button class="cal-btn" onclick="moveMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                        <h2 id="month-display" style="font-size:22px; font-weight:800;"></h2>
                        <button class="cal-btn" onclick="moveMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <div class="cal-grid" style="margin-bottom:12px;">
                        <div class="day-label" style="color:var(--accent)">ì¼</div><div class="day-label">ì›”</div><div class="day-label">í™”</div><div class="day-label">ìˆ˜</div><div class="day-label">ëª©</div><div class="day-label">ê¸ˆ</div><div class="day-label">í† </div>
                    </div>
                    <div id="calendar-days" class="cal-grid"></div>
                </div>
            </div>

            <div id="family" class="tab-content">
                <div style="padding:0 24px 24px;">
                    <h2 style="font-size:24px; font-weight:800;">ìš°ë¦¬ ê°€ì¡± ë©¤ë²„</h2>
                    <p style="color:var(--text-secondary); font-size:14px; margin-top:4px;">í•¨ê»˜í•˜ëŠ” ì†Œì¤‘í•œ ì‚¬ëŒë“¤</p>
                </div>
                <div id="family-container" class="family-grid"></div>
                <div id="noFamilyMsg" class="empty-state" style="display:none;">
                    <i class="fa-solid fa-users"></i>
                    <p>ì•„ì§ ë“±ë¡ëœ ê°€ì¡±ì´ ì—†ì–´ìš”.<br>ë©¤ë²„ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                </div>
            </div>
        </main>

        <nav class="nav-bar">
            <div class="nav-item active" onclick="changeTab('feed', this)">
                <i class="fa-solid fa-house"></i><span>í™ˆ</span>
            </div>
            <div class="nav-item" onclick="changeTab('calendar', this)">
                <i class="fa-regular fa-calendar"></i><span>ì¼ì •</span>
            </div>
            <div class="nav-item" onclick="changeTab('family', this)">
                <i class="fa-solid fa-user-group"></i><span>ê°€ì¡±</span>
            </div>
        </nav>
    </div>

    <div id="eventModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">ğŸ“… ì¼ì • ê´€ë¦¬</h3>
            <p id="modalDateDisplay" style="text-align:center; color:var(--accent); font-weight:700; margin-bottom:24px; font-size:18px;"></p>
            <ul id="eventList" style="list-style:none; margin-bottom:24px; max-height:150px; overflow-y:auto; color:var(--text-primary);"></ul>
            <input type="hidden" id="eventDate">
            <input type="text" id="eventTitle" class="input-field" placeholder="ìƒˆë¡œìš´ ì¼ì • ì…ë ¥" onkeydown="handleEnter(event)">
            <div class="modal-actions">
                <button class="btn-primary" style="background:var(--bg-main); color:var(--text-secondary);" onclick="closeModal('eventModal')">ë‹«ê¸°</button>
                <button class="btn-primary" onclick="saveEvent()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="familyModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">ê°€ì¡± ë©¤ë²„ ì¶”ê°€</h3>
            <div style="text-align:center; margin-bottom:24px;">
                <label for="famImgInput" style="display:inline-block; cursor:pointer;">
                    <div id="famImgPreview" class="mem-avatar-large" style="margin-bottom:0; width:100px; height:100px; font-size:40px; border:3px solid var(--bg-main); box-shadow:var(--shadow-sm);">
                        <i class="fa-solid fa-camera"></i>
                    </div>
                </label>
                <input type="file" id="famImgInput" accept="image/*" style="display:none;" onchange="handleFamImgSelect(event)">
            </div>
            <div style="display:flex; flex-direction:column; gap:12px;">
                <input type="text" id="famRole" class="input-field" placeholder="ì—­í•  (ì˜ˆ: ì•„ë¹ , ì—„ë§ˆ)">
                <input type="text" id="famName" class="input-field" placeholder="ì´ë¦„ (ì„ íƒ)">
                <input type="text" id="famDesc" class="input-field" placeholder="ìƒíƒœ ë©”ì‹œì§€">
            </div>
            <div class="modal-actions">
                <button class="btn-primary" style="background:var(--bg-main); color:var(--text-secondary);" onclick="closeModal('familyModal')">ì·¨ì†Œ</button>
                <button id="btnSaveFam" class="btn-primary" onclick="saveFamily()">ì¶”ê°€í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCokmBJyH6xGaB42u_ScP6k7ghEVxTZSio", authDomain: "our-family-home.firebaseapp.com", projectId: "our-family-home", storageBucket: "our-family-home.firebasestorage.app", messagingSenderId: "446464856858", appId: "1:446464856858:web:344f2c83aeda0ea9ae52a3" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore();

        /* ì´ë¯¸ì§€ ì••ì¶• */
        function compressImage(f,mW,cb){const r=new FileReader();r.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');let w=i.width,h=i.height;if(w>mW){h*=mW/w;w=mW;}c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);cb(c.toDataURL('image/jpeg',0.8));};i.src=e.target.result;};r.readAsDataURL(f);}

        /* ë°ì´í„° ê´€ë¦¬ & UI ë Œë”ë§ */
        let familyData=[], selectedRole="";
        function loadFamily(){
            db.collection("family_members").orderBy("timestamp").onSnapshot(snap=>{
                familyData=[]; const con=document.getElementById('family-container'); const chips=document.getElementById('writerChips');
                con.innerHTML=""; chips.innerHTML=""; document.getElementById('noFamilyMsg').style.display=snap.empty?'block':'none';
                
                if(snap.empty){
                    chips.innerHTML=`<div class="empty-state" style="padding:20px;font-size:14px;">ê°€ì¡±ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.</div>`;
                }

                snap.forEach(doc=>{
                    const d=doc.data(); familyData.push({id:doc.id,...d});
                    // ê°€ì¡± ì¹´ë“œ ë Œë”ë§ (ê¹¨ì§ ë°©ì§€ ì ìš©)
                    const imgHtml=d.imageUrl?`<img src="${d.imageUrl}" style="width:100%;height:100%;object-fit:cover;" onerror="this.parentElement.innerHTML='<i class=\\'fa-solid fa-user\\'></i>'">`:`<i class="fa-solid fa-user"></i>`;
                    con.innerHTML+=`
                    <div class="member-card">
                        <button class="btn-delete-mem" onclick="delFamily('${doc.id}')"><i class="fa-solid fa-xmark"></i></button>
                        <div class="mem-avatar-large">${imgHtml}</div>
                        <div class="mem-role">${d.role}</div>
                        <div class="mem-name">${d.name||''}</div>
                        <div class="mem-desc">${d.desc||'ë°˜ê°€ì›Œìš”'}</div>
                    </div>`;
                    // ì‘ì„±ì ì¹© ë Œë”ë§
                    const chipImg=d.imageUrl?`<img src="${d.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user"></i>`;
                    chips.innerHTML+=`<input type="radio" name="auth" id="c-${doc.id}" class="writer-radio" value="${d.role}" data-id="${doc.id}" onchange="selAuth(this)"><label for="c-${doc.id}" class="writer-chip"><div class="writer-avatar-small">${chipImg}</div> ${d.role}</label>`;
                });
                con.innerHTML+=`<div class="member-card add-member-card" onclick="openFamModal()"><i class="fa-solid fa-plus-circle" style="font-size:32px;"></i><span>ê°€ì¡± ì¶”ê°€</span></div>`;
                updateHeaderProf();
            });
        }
        function selAuth(rd){ selectedRole=rd.value; updateHeaderProf(); }
        function updateHeaderProf(){ 
            const hp=document.getElementById('headerProfile'); 
            if(!selectedRole){ hp.innerHTML=`<i class="fa-solid fa-user" style="color:var(--text-tertiary);"></i>`; return; } 
            const mem=familyData.find(m=>m.role===selectedRole); 
            if(mem&&mem.imageUrl) hp.innerHTML=`<img src="${mem.imageUrl}" onerror="this.parentElement.innerHTML='<i class=\\'fa-solid fa-user\\'></i>'">`; 
            else hp.innerHTML=`<i class="fa-solid fa-user"></i>`; 
        }

        /* í”¼ë“œ */
        let feedImg=null, postLimit=5, unsubFeed=null;
        function handleImageSelect(e){if(e.target.files[0])compressImage(e.target.files[0],1024,d=>{feedImg=d;document.getElementById('imagePreview').src=d;document.getElementById('imagePreviewBox').style.display='flex';});}
        function clearImage(){feedImg=null;document.getElementById('imageInput').value='';document.getElementById('imagePreviewBox').style.display='none';}
        function addPost(){
            if(!selectedRole) return alert("ì‘ì„±ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); const txt=document.getElementById('postContent').value, btn=document.getElementById('btnPost');
            if(!txt&&!feedImg) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); const mem=familyData.find(m=>m.role===selectedRole); btn.disabled=true; btn.innerHTML="<i class='fa-solid fa-spinner fa-spin'></i> ì—…ë¡œë“œ ì¤‘";
            db.collection("family_posts").add({author:selectedRole,authorImg:mem?mem.imageUrl:null,content:txt,imageUrl:feedImg,likes:0,comments:[],timestamp:firebase.firestore.FieldValue.serverTimestamp()})
            .then(()=>{document.getElementById('postContent').value='';clearImage();btn.disabled=false;btn.innerHTML="ì˜¬ë¦¬ê¸°"; window.scrollTo(0,0);})
            .catch(()=>{alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");btn.disabled=false;btn.innerHTML="ì˜¬ë¦¬ê¸°";});
        }
        function loadFeed(){
            if(unsubFeed)unsubFeed(); document.getElementById('loading-spinner').style.display='block';
            unsubFeed=db.collection("family_posts").orderBy("timestamp","desc").limit(postLimit).onSnapshot(snap=>{
                document.getElementById('loading-spinner').style.display='none'; const con=document.getElementById('feed-container'); con.innerHTML="";
                if(snap.empty){ con.innerHTML=`<div class="empty-state"><i class="fa-regular fa-folder-open"></i><p>ì²« ë²ˆì§¸ ì´ì•¼ê¸°ë¥¼ ì˜¬ë ¤ë³´ì„¸ìš”!</p></div>`; }
                snap.forEach(doc=>renderPost(doc.id,doc.data(),con)); document.getElementById('btnLoadMore').style.display=snap.size>=postLimit?'block':'none';
            });
        }
        function loadMorePosts(){postLimit+=5;loadFeed();}
        function renderPost(id,d,con){
            const pImg=d.authorImg?`<img src="${d.authorImg}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user"></i>`;
            const contentImg=d.imageUrl?`<div class="img-box" style="margin-bottom:16px;"><img src="${d.imageUrl}" onerror="this.parentElement.style.display='none'"></div>`:'';
            let cmts=""; if(d.comments)d.comments.forEach(c=>{ const cImg=c.authorImg?`<img src="${c.authorImg}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user"></i>`; cmts+=`<div class="cmt-item"><div class="cmt-avatar">${cImg}</div><div class="cmt-content"><span class="cmt-author">${c.author}</span><span class="cmt-text">${c.text}</span></div></div>`; });
            let cmtOpts=""; familyData.forEach(m=>{ cmtOpts+=`<option value="${m.role}" ${m.role===selectedRole?'selected':''}>${m.role}</option>`; });
            con.innerHTML+=`
            <div class="card feed-item">
                <div class="feed-header"><div class="feed-profile-wrap"><div class="feed-avatar">${pImg}</div><div class="feed-info"><h4>${d.author}</h4><span>${d.timestamp?new Date(d.timestamp.toDate()).toLocaleDateString():'ë°©ê¸ˆ ì „'}</span></div></div><button onclick="delPost('${id}')" class="btn-icon"><i class="fa-solid fa-ellipsis"></i></button></div>
                <div class="feed-body">${d.content}</div>${contentImg}
                <div class="feed-actions"><button class="action-btn ${d.likes>0?'liked':''}" onclick="likePost('${id}',${d.likes})"><i class="${d.likes>0?'fa-solid':'fa-regular'} fa-heart"></i> ${d.likes||0}</button><button class="action-btn" onclick="toggleCmt('${id}')"><i class="fa-regular fa-comment"></i> ëŒ“ê¸€</button></div>
                <div id="cmt-${id}" class="comment-box"><div style="margin-bottom:16px;max-height:200px;overflow-y:auto;">${cmts}</div><div class="cmt-input-wrap"><select id="cAuth-${id}" class="input-field" style="width:auto;">${cmtOpts}</select><input type="text" id="cInp-${id}" class="input-field" placeholder="ëŒ“ê¸€ ì…ë ¥..." onkeydown="if(event.key==='Enter')addCmt('${id}')"><button class="btn-primary" style="width:auto;" onclick="addCmt('${id}')"><i class="fa-solid fa-arrow-up"></i></button></div></div>
            </div>`;
        }
        function likePost(id,n){db.collection("family_posts").doc(id).update({likes:(n||0)+1});}
        function delPost(id){if(confirm("ê²Œì‹œë¬¼ì„ ì‚­ì œí• ê¹Œìš”?"))db.collection("family_posts").doc(id).delete();}
        function toggleCmt(id){document.getElementById(`cmt-${id}`).classList.toggle('show');}
        function addCmt(id){const r=document.getElementById(`cAuth-${id}`).value,t=document.getElementById(`cInp-${id}`).value; if(!t)return; const m=familyData.find(x=>x.role===r); db.collection("family_posts").doc(id).update({comments:firebase.firestore.FieldValue.arrayUnion({author:r,text:t,authorImg:m?m.imageUrl:null})});}

        /* ìº˜ë¦°ë” */
        let curDate=new Date(), events=[], curModDate=null;
        function loadCal(){
            const y=curDate.getFullYear(), m=curDate.getMonth(); document.getElementById('month-display').innerText=`${y}ë…„ ${m+1}ì›”`;
            const f=new Date(y,m,1), l=new Date(y,m+1,0), con=document.getElementById('calendar-days'); con.innerHTML="";
            for(let i=0;i<f.getDay();i++)con.innerHTML+=`<div></div>`;
            for(let i=1;i<=l.getDate();i++){
                const dStr=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`, evs=events.filter(e=>e.date===dStr), hasEv=evs.length?`<div class="event-marker"></div>`:'', tdy=new Date().toDateString()===new Date(y,m,i).toDateString()?'today':'';
                con.innerHTML+=`<div class="date-cell ${tdy}" onclick="openEvModal('${dStr}')"><span style="font-weight:600;font-size:14px;">${i}</span>${hasEv}</div>`;
            }
        }
        function moveMonth(n){curDate.setMonth(curDate.getMonth()+n);loadCal();}
        function openEvModal(d){curModDate=d; document.getElementById('modalDateDisplay').innerText=d; renderEvList(); document.getElementById('eventModal').style.display='flex'; }
        function renderEvList(){const el=document.getElementById('eventList'); const evs=events.filter(e=>e.date===curModDate); el.innerHTML=evs.length?"": "<li style='color:var(--text-tertiary);text-align:center;padding:10px;'>ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>"; evs.forEach(e=>el.innerHTML+=`<li style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border-color);"><span>${e.title}</span><button class="btn-icon" style="color:#EF4444;padding:4px;" onclick="delEv('${e.id}')"><i class="fa-solid fa-trash"></i></button></li>`); }
        function saveEvent(){const t=document.getElementById('eventTitle').value; if(curModDate&&t) db.collection("family_events").add({date:curModDate,title:t,timestamp:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{document.getElementById('eventTitle').value=''; closeModal('eventModal');});}
        function delEv(id){if(confirm("ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?"))db.collection("family_events").doc(id).delete();}
        db.collection("family_events").orderBy("timestamp").onSnapshot(s=>{events=[];s.forEach(d=>events.push({id:d.id,...d.data()}));loadCal();if(curModDate)renderEvList();});

        /* ê³µí†µ ë° ê¸°íƒ€ */
        let famImg=null; function closeModal(id){ document.getElementById(id).style.display='none'; famImg=null; curModDate=null; }
        function openFamModal(){ document.getElementById('familyModal').style.display='flex'; }
        function handleFamImgSelect(e){if(e.target.files[0])compressImage(e.target.files[0],500,d=>{famImg=d;document.getElementById('famImgPreview').innerHTML=`<img src="${d}" style="width:100%;height:100%;object-fit:cover;" onerror="this.parentElement.innerHTML='<i class=\\'fa-solid fa-user\\'></i>'">`;});}
        function saveFam(){ const r=document.getElementById('famRole').value, n=document.getElementById('famName').value, d=document.getElementById('famDesc').value; if(!r)return alert("ì—­í• ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); const btn=document.getElementById('btnSaveFam'); btn.disabled=true; btn.innerText="ì €ì¥ ì¤‘..."; db.collection("family_members").add({role:r,name:n,desc:d,imageUrl:famImg,timestamp:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{closeModal('familyModal');btn.disabled=false;btn.innerText="ì¶”ê°€í•˜ê¸°";}).catch(()=>{alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");btn.disabled=false;btn.innerText="ì¶”ê°€í•˜ê¸°";}); }
        function delFamily(id){if(confirm("ë©¤ë²„ë¥¼ ì‚­ì œí• ê¹Œìš”?"))db.collection("family_members").doc(id).delete();}
        function handleEnter(e){if(e.key==='Enter'&&!e.isComposing)saveEvent();}
        window.changeTab = function(id, el) { document.querySelectorAll('.tab-content').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); if(el) el.classList.add('active'); window.scrollTo(0,0); }
        loadFeed(); loadCal(); loadFamily();
    </script>
</body>
</html>
