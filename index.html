<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Yummy Family Log</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=DM+Serif+Display&family=Noto+Sans+KR:wght@400;700&family=Nanum+Gothic+Coding&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* [Theme: Retro 3D Cafe] */
        :root {
            --bg-cream: #FFFDF5;
            --text-choco: #4A2c2A;
            --accent-red: #D94844;
            --accent-pink: #FFD1D1;
            --accent-yellow: #FFD56B;
            --border-thick: 2px solid #4A2c2A;
            --shadow-hard: 4px 4px 0px #4A2c2A;
            --radius-L: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-cream); color: var(--text-choco);
            min-height: 100vh; overflow-x: hidden;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        }

        /* ë°°ê²½ 3D ì˜¤ë¸Œì íŠ¸ */
        .floating-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .floater { position: absolute; opacity: 0.8; animation: float3D 6s ease-in-out infinite alternate; }
        .obj-1 { top: 10%; left: 5%; font-size: 40px; color: var(--accent-red); animation-duration: 7s; }
        .obj-2 { top: 20%; right: -5%; font-size: 80px; color: var(--accent-pink); animation-duration: 9s; opacity: 0.5; }
        .obj-3 { bottom: 15%; left: -10%; font-size: 100px; color: var(--accent-yellow); animation-duration: 8s; opacity: 0.6; }
        .obj-4 { bottom: 30%; right: 10%; font-size: 30px; color: var(--accent-red); animation-duration: 6s; }
        @keyframes float3D { 0% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(-30px) rotate(10deg); } }

        .app-layout { max-width: 600px; margin: 0 auto; padding-bottom: 120px; position: relative; }

        /* í—¤ë” */
        .header { 
            padding: 20px 24px; text-align: center; position: sticky; top: 0; z-index: 50;
            background: rgba(255, 253, 245, 0.95); backdrop-filter: blur(5px); border-bottom: var(--border-thick);
        }
        .brand-title { font-family: 'DM Serif Display', serif; font-size: 32px; color: var(--accent-red); text-shadow: 2px 2px 0px var(--text-choco); letter-spacing: 1px; margin-bottom: 5px; }
        .brand-sub { font-family: 'Jua', sans-serif; font-size: 16px; color: var(--text-choco); }
        .my-badge { position: absolute; right: 20px; top: 25px; width: 40px; height: 40px; background: white; border: var(--border-thick); border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; box-shadow: var(--shadow-hard); }
        .my-badge img { width: 100%; height: 100%; object-fit: cover; }

        /* ì˜ìˆ˜ì¦ ìŠ¤íƒ€ì¼ */
        .receipt-paper {
            background: white; width: 90%; margin: 20px auto; padding: 20px;
            border-top: 1px solid #ddd; box-shadow: 0 5px 15px rgba(0,0,0,0.1); position: relative;
            font-family: 'Nanum Gothic Coding', monospace;
        }
        .receipt-paper::before, .receipt-paper::after {
            content: ""; position: absolute; left: 0; width: 100%; height: 10px; background-size: 20px 20px; background-repeat: repeat-x;
        }
        .receipt-paper::before { top: -10px; background-image: radial-gradient(circle at 10px 15px, transparent 10px, white 11px); }
        .receipt-paper::after { bottom: -10px; background-image: radial-gradient(circle at 10px -5px, transparent 10px, white 11px); }
        .receipt-title { text-align: center; font-size: 20px; border-bottom: 2px dashed #444; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; }
        .shop-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ddd; font-size: 16px; }
        .shop-item.checked span { text-decoration: line-through; color: #aaa; }
        .shop-check { width: 20px; height: 20px; border: 2px solid var(--text-choco); border-radius: 4px; margin-right: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .shop-check.on { background: var(--accent-red); }
        .shop-del { color: #aaa; cursor: pointer; padding: 5px; }

        /* ì±—ë´‡ ìŠ¤íƒ€ì¼ (ëª¨ë“  íƒ­ ìœ„ì— ëœ¸) */
        .chatbot-btn {
            position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px;
            background: var(--accent-red); border: var(--border-thick); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 30px; color: white;
            box-shadow: var(--shadow-hard); cursor: pointer; z-index: 999; transition: 0.2s;
        }
        .chatbot-btn:active { transform: translate(2px, 2px); box-shadow: none; }
        
        .chat-window {
            position: fixed; bottom: 170px; right: 20px; width: 320px; height: 480px;
            background: white; border: var(--border-thick); border-radius: 20px;
            display: none; flex-direction: column; z-index: 999; box-shadow: 10px 10px 0px rgba(0,0,0,0.2);
            overflow: hidden; animation: popUp 0.3s;
        }
        .chat-head { background: var(--accent-yellow); padding: 15px; border-bottom: var(--border-thick); font-family: 'Jua'; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #fffdf5; font-size: 14px; }
        .chat-msg { margin-bottom: 10px; max-width: 85%; padding: 10px 14px; border-radius: 12px; line-height: 1.4; border: 1px solid rgba(0,0,0,0.1); word-break: keep-all; }
        .msg-bot { background: white; align-self: flex-start; border-radius: 4px 12px 12px 12px; }
        .msg-user { background: var(--accent-pink); align-self: flex-end; margin-left: auto; border-radius: 12px 12px 4px 12px; }
        
        /* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */
        .typing-indicator { display: inline-block; }
        .typing-indicator span { display: inline-block; width: 6px; height: 6px; background: #aaa; border-radius: 50%; margin: 0 2px; animation: typing 1s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; } .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        .chat-input-area { padding: 10px; border-top: var(--border-thick); display: flex; gap: 5px; background: white; }
        .chat-inp { flex: 1; border: 1px solid #444; border-radius: 20px; padding: 10px; outline: none; }

        /* ê³µí†µ UI */
        .retro-card { background: white; border: var(--border-thick); border-radius: var(--radius-L); padding: 24px; margin: 24px 20px; box-shadow: var(--shadow-hard); position: relative; transition: 0.2s; }
        .btn-pop { background: var(--accent-red); color: white; border: var(--border-thick); padding: 14px 24px; border-radius: 50px; font-family: 'Jua', sans-serif; font-size: 18px; cursor: pointer; box-shadow: var(--shadow-hard); transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; }
        .btn-pop:active { transform: translate(2px, 2px); box-shadow: none; background: #C0392B; }
        .btn-pop:disabled { background: #ccc; border-color: #999; color: #666; cursor: not-allowed; box-shadow: none; transform: translate(2px, 2px); }
        .btn-pop.yellow { background: var(--accent-yellow); color: var(--text-choco); }
        .btn-pop.gray { background: #E0E0E0; color: #555; border-color: #999; box-shadow: 2px 2px 0px #999; }
        .input-retro { width: 100%; background: #FFF; border: var(--border-thick); border-radius: 16px; padding: 14px; font-size: 16px; color: var(--text-choco); outline: none; box-shadow: inset 2px 2px 5px rgba(74, 44, 42, 0.1); }

        /* íƒ­ & ë„¤ë¹„ê²Œì´ì…˜ */
        .tab-section { display: none; } .tab-section.active { display: block; animation: popIn 0.3s; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .nav-dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px; background: var(--text-choco); border-radius: 40px; box-shadow: 0 10px 20px rgba(74, 44, 42, 0.3); display: flex; justify-content: space-around; align-items: center; padding: 0 20px; z-index: 100; border: 2px solid white; }
        .nav-item { color: rgba(255,255,255,0.5); font-size: 24px; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--accent-yellow); transform: translateY(-5px); }

        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ë“¤ */
        .writer-scroll { display: flex; gap: 12px; margin-bottom: 20px; overflow-x: auto; padding: 5px; scrollbar-width: none; }
        .radio-hidden { display: none; }
        .writer-tag { padding: 8px 16px; background: white; border: var(--border-thick); border-radius: 30px; font-family: 'Jua', sans-serif; font-size: 16px; color: var(--text-choco); cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 6px; box-shadow: 2px 2px 0px rgba(74, 44, 42, 0.2); }
        .radio-hidden:checked + .writer-tag { background: var(--accent-red); color: white; box-shadow: var(--shadow-hard); transform: translateY(-2px); }
        .img-preview { width: 100%; border: var(--border-thick); border-radius: 16px; margin-top: 15px; overflow: hidden; position: relative; display: none; background: white; }
        .feed-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px dashed #E5D0C0; padding-bottom: 10px; }
        .feed-profile { display: flex; align-items: center; gap: 10px; }
        .fp-img { width: 45px; height: 45px; border-radius: 50%; border: var(--border-thick); object-fit: cover; background: white; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .feed-photo { padding: 10px; background: white; border: var(--border-thick); transform: rotate(-1deg); margin-bottom: 15px; box-shadow: 3px 3px 0px rgba(0,0,0,0.1); }
        .feed-photo img { width: 100%; border: 1px solid #eee; display: block; }
        .act-btn { padding: 8px 12px; background: var(--bg-cream); border: 2px solid #E5D0C0; border-radius: 12px; font-weight: 700; font-size: 13px; color: var(--text-choco); display: flex; gap: 6px; align-items: center; cursor: pointer; }
        .cmt-area { background: #FFF8E7; border: 2px dashed #E5D0C0; border-radius: 16px; padding: 15px; margin-top: 15px; display: none; }
        .cmt-area.show { display: block; }
        
        .cal-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .cal-title { font-family: 'DM Serif Display', serif; font-size: 32px; color: var(--accent-red); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .date-box { min-height: 70px; background: white; border: 2px solid #E5D0C0; border-radius: 12px; display: flex; flex-direction: column; align-items: center; padding: 5px; cursor: pointer; }
        .date-box.today { background: var(--accent-yellow); border: var(--border-thick); }
        .ev-badge { width: 8px; height: 8px; background: var(--accent-red); border-radius: 50%; border: 1px solid var(--text-choco); margin-top: 4px; }

        .family-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; padding: 0 10px; }
        .mem-card { background: white; border: var(--border-thick); border-radius: 24px; padding: 20px 10px; text-align: center; box-shadow: var(--shadow-hard); position: relative; }
        .mem-pic { width: 80px; height: 80px; border-radius: 50%; border: var(--border-thick); object-fit: cover; margin-bottom: 10px; background: var(--bg-cream); display: flex; align-items: center; justify-content: center; margin-left: auto; margin-right: auto; overflow: hidden; }
        .add-card { border: 2px dashed var(--text-choco); background: rgba(255,255,255,0.5); box-shadow: none; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; min-height: 200px; gap: 10px; }

        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(74, 44, 42, 0.6); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-card { background: var(--bg-cream); width: 85%; max-width: 350px; padding: 25px; border: var(--border-thick); border-radius: var(--radius-L); box-shadow: 8px 8px 0px rgba(0,0,0,0.2); }
        .modal-tit { font-family: 'Jua', sans-serif; font-size: 24px; margin-bottom: 20px; color: var(--text-choco); display:flex; align-items:center; gap:8px;}
        .modal-btns { display: flex; flex-direction: column; gap: 12px; margin-top: 25px; }

        @media (min-width: 768px) {
            .app-layout { padding: 40px; }
            .nav-dock { bottom: auto; top: 50%; left: 40px; transform: translateY(-50%); width: 70px; height: 300px; flex-direction: column; padding: 30px 0; }
            .family-grid { grid-template-columns: repeat(3, 1fr); }
            .chatbot-btn { right: 50px; bottom: 50px; }
            .chat-window { right: 50px; bottom: 120px; }
        }
    </style>
</head>
<body>
    <div class="floating-bg">
        <i class="fa-solid fa-star floater obj-1"></i>
        <i class="fa-solid fa-circle floater obj-2"></i>
        <i class="fa-solid fa-cloud floater obj-3"></i>
        <i class="fa-solid fa-sparkles floater obj-4"></i>
    </div>

    <div class="app-layout">
        <header class="header">
            <div class="brand-title">Yummy Family</div>
            <div class="brand-sub">ìš°ë¦¬ ê°€ì¡±ì˜ ë§›ìˆëŠ” ì¼ìƒ ğŸ’</div>
            <div class="my-badge" id="headerProfile"><i class="fa-solid fa-user"></i></div>
        </header>

        <main id="mainContent">
            <div id="feed" class="tab-section active">
                <div class="retro-card">
                    <div style="font-family:'Jua'; font-size:20px; margin-bottom:15px;">
                        <i class="fa-solid fa-pen-fancy" style="color:var(--accent-red);"></i> ì˜¤ëŠ˜ì˜ ì¶”ì–µ ê¸°ë¡
                    </div>
                    <div class="writer-scroll" id="writerChips">
                        <div style="font-size:14px; color:#aaa; padding:10px;">ë¡œë”© ì¤‘... (ê°€ì¡±ì„ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”!)</div>
                    </div>
                    <textarea id="postContent" class="input-retro" style="min-height:100px; resize:none;" placeholder="ì˜¤ëŠ˜ ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆë‚˜ìš”? ğŸ°"></textarea>
                    <div id="imagePreviewBox" class="img-preview">
                        <img id="imagePreview" src="">
                        <button class="btn-x" onclick="clearImage()"><i class="fa-solid fa-times"></i></button>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                        <label for="imageInput" style="font-size:24px; color:var(--text-choco); cursor:pointer;"><i class="fa-regular fa-image"></i></label>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                        <button id="btnPost" class="btn-pop" style="width:auto; padding:10px 30px;" onclick="addPost()">ì—…ë¡œë“œ!</button>
                    </div>
                </div>
                <div id="feed-container"></div>
                <div style="text-align:center; margin-top:30px; display:none;" id="moreBtnBox">
                    <button class="btn-pop yellow" style="width:auto;" onclick="loadMorePosts()">ë” ë³´ê¸° ğŸ‘‡</button>
                </div>
            </div>

            <div id="calendar" class="tab-section">
                <div class="retro-card">
                    <div class="cal-top">
                        <button class="cal-arrow" onclick="moveMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                        <div id="month-display" class="cal-title"></div>
                        <button class="cal-arrow" onclick="moveMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <div class="cal-grid" style="margin-bottom:10px;">
                        <div class="day-label" style="color:var(--accent-red)">ì¼</div><div class="day-label">ì›”</div><div class="day-label">í™”</div><div class="day-label">ìˆ˜</div><div class="day-label">ëª©</div><div class="day-label">ê¸ˆ</div><div class="day-label">í† </div>
                    </div>
                    <div id="calendar-days" class="cal-grid"></div>
                </div>
            </div>

            <div id="shopping" class="tab-section">
                <div class="receipt-paper">
                    <div class="receipt-title">ğŸ›’ ì¥ë³´ê¸° ë¦¬ìŠ¤íŠ¸</div>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="text" id="shopInput" class="input-retro" placeholder="ì‚´ ê²ƒ ì…ë ¥ (ì˜ˆ: ìš°ìœ )" onkeydown="if(event.key==='Enter')addShopItem()">
                        <button class="btn-pop" style="width:auto;" onclick="addShopItem()">+</button>
                    </div>
                    <div id="shopList"></div>
                    <div style="text-align:center; margin-top:20px; font-size:12px; color:#aaa;">*** THANK YOU ***</div>
                </div>
            </div>

            <div id="family" class="tab-section">
                <div style="text-align:center; margin-bottom:20px; font-family:'Jua'; font-size:28px;">ìš°ë¦¬ ê°€ì¡± ë©¤ë²„ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                <div id="family-container" class="family-grid"></div>
            </div>
        </main>

        <nav class="nav-dock">
            <div class="nav-item active" onclick="changeTab('feed', this)"><i class="fa-solid fa-house"></i></div>
            <div class="nav-item" onclick="changeTab('calendar', this)"><i class="fa-solid fa-calendar-days"></i></div>
            <div class="nav-item" onclick="changeTab('shopping', this)"><i class="fa-solid fa-cart-shopping"></i></div>
            <div class="nav-item" onclick="changeTab('family', this)"><i class="fa-solid fa-users"></i></div>
        </nav>
    </div>

    <div class="chatbot-btn" onclick="toggleChat()"><i class="fa-solid fa-robot"></i></div>
    <div class="chat-window" id="chatWindow">
        <div class="chat-head">ğŸ’ ë§ŒëŠ¥ ì‚´ë¦¼ê¾¼ ì²´ë¦¬ <i class="fa-solid fa-times" style="cursor:pointer;" onclick="toggleChat()"></i></div>
        <div class="chat-body" id="chatBody">
            <div class="chat-msg msg-bot">
                ì•ˆë…•í•˜ì„¸ìš”! ìš°ë¦¬ ê°€ì¡± ì „ìš© AI <b>ì²´ë¦¬</b>ì…ë‹ˆë‹¤! ğŸ’<br><br>
                <b>ì´ëŸ° ê±¸ í•  ìˆ˜ ìˆì–´ìš”!</b><br>
                ğŸ›’ "ê¹€ì¹˜ì°Œê°œ ì¬ë£Œ ë‹´ì•„ì¤˜"<br>
                ğŸ“… "ë‚´ì¼ ì €ë… ì™¸ì‹ ì¼ì • ì¡ì•„ì¤˜"<br>
                ğŸ—‘ï¸ "ë‚´ì¼ ì¼ì • ì‚­ì œí•´ì¤˜"<br>
                â˜€ï¸ "ì—¬ë¦„ì¸ë° ë­ ë¨¹ì„ê¹Œ?"<br>
                âœŒï¸ "ê°€ìœ„ë°”ìœ„ë³´ í•˜ì"<br>
                ğŸ’Š "ê±´ê°• ìƒì‹ ì•Œë ¤ì¤˜"
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-inp" placeholder="ì²´ë¦¬ì—ê²Œ ë¶€íƒí•´ ë³´ì„¸ìš”!" onkeydown="if(event.key==='Enter')sendChat()">
            <button class="btn-pop" style="width:auto; padding:5px 15px; font-size:14px;" onclick="sendChat()">ì „ì†¡</button>
        </div>
    </div>

    <div id="eventModal" class="modal-bg">
        <div class="modal-card">
            <div class="modal-tit">ğŸ“… ì¼ì • ê¸°ë¡</div>
            <p id="modalDateDisplay" style="text-align:center; font-weight:bold; margin-bottom:20px; color:var(--text-choco);"></p>
            <ul id="eventList" style="list-style:none; margin-bottom:20px; padding:0;"></ul>
            <input type="hidden" id="eventDate">
            <input type="text" id="eventTitle" class="input-retro" placeholder="ì¼ì • ë‚´ìš©" onkeydown="if(event.key==='Enter') saveEvent()">
            <div class="modal-btns">
                <button class="btn-pop gray" onclick="closeModal('eventModal')">ë‹«ê¸°</button>
                <button class="btn-pop" onclick="saveEvent()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="familyModal" class="modal-bg">
        <div class="modal-card">
            <div class="modal-tit">ğŸ’ ê°€ì¡± ì¶”ê°€</div>
            <div style="text-align:center; margin-bottom:20px;">
                <label for="famImgInput" style="display:inline-block; cursor:pointer;">
                    <div id="famImgPreview" style="width:100px; height:100px; border-radius:50%; background:var(--bg-cream); border:var(--border-thick); display:flex; align-items:center; justify-content:center; overflow:hidden;">
                        <i class="fa-solid fa-camera" style="font-size:30px; color:var(--text-choco);"></i>
                    </div>
                </label>
                <input type="file" id="famImgInput" accept="image/*" style="display:none;" onchange="handleFamImgSelect(event)">
            </div>
            <input type="text" id="famRole" class="input-retro" placeholder="ì—­í•  (ì˜ˆ: ì•„ë¹ )" style="margin-bottom:10px;">
            <input type="text" id="famName" class="input-retro" placeholder="ì´ë¦„ (ì„ íƒ)" style="margin-bottom:10px;">
            <input type="text" id="famDesc" class="input-retro" placeholder="í•œ ë§ˆë”” ì†Œê°œ">
            <div class="modal-btns">
                <button class="btn-pop gray" onclick="closeModal('familyModal')">ì·¨ì†Œ</button>
                <button id="btnSaveFam" class="btn-pop" onclick="saveFam()">ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCokmBJyH6xGaB42u_ScP6k7ghEVxTZSio",
            authDomain: "our-family-home.firebaseapp.com",
            projectId: "our-family-home",
            storageBucket: "our-family-home.firebasestorage.app",
            messagingSenderId: "446464856858",
            appId: "1:446464856858:web:344f2c83aeda0ea9ae52a3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function compressImage(f,mW,cb){const r=new FileReader();r.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');let w=i.width,h=i.height;if(w>mW){h*=mW/w;w=mW;}c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);cb(c.toDataURL('image/jpeg',0.5));};i.src=e.target.result;};r.readAsDataURL(f);}

        /* ================================
           [AI ì²´ë¦¬ 3.0] ì§€ì‹ ë² ì´ìŠ¤
           ================================ */
        // 1. ë°©ëŒ€í•œ ë ˆì‹œí”¼ ë°ì´í„°
        const recipes = {
            "ë–¡ë³¶ì´": ["ë–¡", "ì–´ë¬µ", "ëŒ€íŒŒ", "ê³ ì¶”ì¥", "ì„¤íƒ•", "ë¼ë©´ì‚¬ë¦¬"],
            "ê¹€ì¹˜ì°Œê°œ": ["ë¬µì€ì§€", "ë¼ì§€ê³ ê¸°", "ë‘ë¶€", "ëŒ€íŒŒ", "ë‹¤ì§„ë§ˆëŠ˜"],
            "ëœì¥ì°Œê°œ": ["ëœì¥", "ì• í˜¸ë°•", "ë‘ë¶€", "ì–‘íŒŒ", "ê°ì", "ì²­ì–‘ê³ ì¶”"],
            "ë¶€ëŒ€ì°Œê°œ": ["í–„", "ì†Œì‹œì§€", "ë² ì´í¬ë“œë¹ˆ", "ê¹€ì¹˜", "ë¼ë©´ì‚¬ë¦¬", "ì¹˜ì¦ˆ"],
            "ë¯¸ì—­êµ­": ["ê±´ë¯¸ì—­", "ì†Œê³ ê¸°(ì–‘ì§€)", "ì°¸ê¸°ë¦„", "êµ­ê°„ì¥", "ë‹¤ì§„ë§ˆëŠ˜"],
            "ì œìœ¡ë³¶ìŒ": ["ë¼ì§€ê³ ê¸°(ì•ë‹¤ë¦¬)", "ê³ ì¶”ì¥", "ê³ ì¶§ê°€ë£¨", "ì–‘íŒŒ", "ëŒ€íŒŒ", "ë‹¹ê·¼"],
            "ë¶ˆê³ ê¸°": ["ì†Œê³ ê¸°(ë¶ˆê³ ê¸°ìš©)", "ê°„ì¥", "ì„¤íƒ•", "ë²„ì„¯", "ë‹¹ë©´", "ì–‘íŒŒ"],
            "ë¹„ë¹”ë°¥": ["ì½©ë‚˜ë¬¼", "ì‹œê¸ˆì¹˜", "ê³ ì‚¬ë¦¬", "ê³„ë€", "ê³ ì¶”ì¥", "ì°¸ê¸°ë¦„"],
            "ì¹´ë ˆ": ["ì¹´ë ˆê°€ë£¨", "ê°ì", "ì–‘íŒŒ", "ë‹¹ê·¼", "ë¼ì§€ê³ ê¸°/ë‹­ê³ ê¸°"],
            "íŒŒìŠ¤íƒ€": ["íŒŒìŠ¤íƒ€ë©´", "í† ë§ˆí† ì†ŒìŠ¤/í¬ë¦¼ì†ŒìŠ¤", "ë§ˆëŠ˜", "ë² ì´ì»¨", "ì–‘íŒŒ", "ë¸Œë¡œì½œë¦¬"],
            "ë¼ë©´": ["ë¼ë©´", "ê³„ë€", "ëŒ€íŒŒ"],
            "ì‚¼ê²¹ì‚´": ["ì‚¼ê²¹ì‚´", "ìƒì¶”", "ê¹»ì", "ìŒˆì¥", "ë§ˆëŠ˜", "ë²„ì„¯"],
            "ê³„ë€ë§ì´": ["ê³„ë€", "ëŒ€íŒŒ", "ë‹¹ê·¼", "ì†Œê¸ˆ"],
            "ë³¶ìŒë°¥": ["ë°¥", "ê³„ë€", "í–„", "ëŒ€íŒŒ", "êµ´ì†ŒìŠ¤"],
            "ë‹­ë³¶ìŒíƒ•": ["ë‹­ê³ ê¸°", "ê°ì", "ë‹¹ê·¼", "ì–‘íŒŒ", "ê³ ì¶”ì¥", "ê³ ì¶§ê°€ë£¨"],
            "ìˆœë‘ë¶€ì°Œê°œ": ["ìˆœë‘ë¶€", "ë°”ì§€ë½", "ê³„ë€", "ëŒ€íŒŒ", "ê³ ì¶”ê¸°ë¦„"],
            "ì˜¤ì§•ì–´ë³¶ìŒ": ["ì˜¤ì§•ì–´", "ì–‘íŒŒ", "ëŒ€íŒŒ", "ë‹¹ê·¼", "ê³ ì¶”ì¥"],
            "ì¡ì±„": ["ë‹¹ë©´", "ì‹œê¸ˆì¹˜", "ë‹¹ê·¼", "ì–‘íŒŒ", "ë²„ì„¯", "ê³ ê¸°"],
            "ê°ˆë¹„ì°œ": ["ê°ˆë¹„", "ë¬´", "ë‹¹ê·¼", "ë°¤", "ëŒ€ì¶”", "ê°„ì¥"],
            "ì½©ë‚˜ë¬¼êµ­": ["ì½©ë‚˜ë¬¼", "ëŒ€íŒŒ", "ë‹¤ì§„ë§ˆëŠ˜", "ìƒˆìš°ì “"],
            "ê°ìì „": ["ê°ì", "ì†Œê¸ˆ", "ì‹ìš©ìœ "],
            "ê¹€ì¹˜ì „": ["ê¹€ì¹˜", "ë¶€ì¹¨ê°€ë£¨", "ì„¤íƒ•", "ì‹ìš©ìœ "],
            "ì–´ë¬µíƒ•": ["ì–´ë¬µ", "ë¬´", "ëŒ€íŒŒ", "ë©¸ì¹˜ìœ¡ìˆ˜", "ê°„ì¥"]
        };

        // 2. ê³„ì ˆ ìŒì‹ ë°ì´í„°
        const seasonalFoods = {
            "ë´„": ["ë´„ë™ê²‰ì ˆì´", "ë‹¬ë˜ëœì¥ì°Œê°œ", "ì‘¥êµ­", "ì­ˆê¾¸ë¯¸ë³¶ìŒ", "ë”¸ê¸°"],
            "ì—¬ë¦„": ["ëƒ‰ë©´", "ì½©êµ­ìˆ˜", "ì‚¼ê³„íƒ•", "ìˆ˜ë°•", "ì˜¤ì´ëƒ‰êµ­", "ë¹„ë¹”ë©´"],
            "ê°€ì„": ["ì „ì–´êµ¬ì´", "ëŒ€í•˜êµ¬ì´", "ê½ƒê²Œíƒ•", "ì†¡í¸", "ê³ êµ¬ë§ˆ"],
            "ê²¨ìš¸": ["êµ°ê³ êµ¬ë§ˆ", "í˜¸ë¹µ", "ì–´ë¬µíƒ•", "ê·¤", "ë™íƒœì°Œê°œ", "ë§Œë‘êµ­"]
        };

        // 3. ì§€ì‹ì°½ê³  (ê±´ê°•, ìœ¡ì•„, ê°ì •)
        const knowledgeBase = {
            health: [
                "í•˜ë£¨ ë¬¼ 8ì”(ì•½ 2L)ì„ ë§ˆì‹œë©´ í”¼ë¶€ë„ ì¢‹ì•„ì§€ê³  ì‹ ì§„ëŒ€ì‚¬ê°€ í™œë°œí•´ì ¸ìš”! ğŸ’§",
                "ì‹ì‚¬ í›„ ë°”ë¡œ ëˆ•ì§€ ë§ê³  20ë¶„ ì •ë„ ê°€ë³ê²Œ ì‚°ì±…í•˜ë©´ ì†Œí™”ì— ì•„ì£¼ ì¢‹ì•„ìš”. ğŸš¶",
                "ì ë“¤ê¸° 1ì‹œê°„ ì „ë¶€í„°ëŠ” ìŠ¤ë§ˆíŠ¸í°ì„ ë©€ë¦¬í•´ì•¼ ê¿€ì ì„ ì˜ ìˆ˜ ìˆëŒ€ìš”. ğŸ˜´",
                "ë¹„íƒ€ë¯¼D í•©ì„±ì„ ìœ„í•´ í•˜ë£¨ 15ë¶„ ì •ë„ í–‡ë³•ì„ ì¬ì–´ì£¼ì„¸ìš”. â˜€ï¸",
                "ìŠ¤íŠ¸ë ˆì¹­ì€ êµ³ì€ ëª¸ì„ í’€ì–´ì£¼ê³  í˜ˆì•¡ìˆœí™˜ì„ ë„ì™€ì¤ë‹ˆë‹¤. ì§€ê¸ˆ ë°”ë¡œ ê¸°ì§€ê°œ ì¼œë³´ì„¸ìš”! ğŸ™†"
            ],
            parenting: [
                "ì•„ì´ì˜ ë§ì„ ëŠì§€ ì•Šê³  ëê¹Œì§€ ë“¤ì–´ì£¼ëŠ” 'ê²½ì²­'ì´ ìµœê³ ì˜ ëŒ€í™”ë²•ì´ì—ìš”. ğŸ‘‚",
                "ê²°ê³¼ë³´ë‹¤ ê³¼ì •ì„ ì¹­ì°¬í•´ì£¼ë©´ ì•„ì´ì˜ ìì¡´ê°ì´ ì‘¥ì‘¥ ìë¼ìš”! ğŸ‘",
                "ì•„ì´ì™€ í•¨ê»˜ ìš”ë¦¬í•˜ê±°ë‚˜ ì²­ì†Œí•˜ëŠ” ê²ƒë„ í›Œë¥­í•œ ë†€ì´ê°€ ë  ìˆ˜ ìˆì–´ìš”. ğŸ§¹",
                "í•˜ë£¨ 10ë¶„ì´ë¼ë„ ì˜¨ì „íˆ ì•„ì´ì—ê²Œë§Œ ì§‘ì¤‘í•˜ëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì„¸ìš”. â¤ï¸"
            ],
            empathy: {
                sad: "ì €ëŸ°, ì†ìƒí•œ ì¼ì´ ìˆìœ¼ì…¨ë‚˜ìš”? ë§›ìˆëŠ” ê±° ë¨¹ê³  ê¸°ìš´ ì°¨ë¦¬ì„¸ìš”! í† ë‹¥í† ë‹¥. ğŸ«",
                tired: "ì˜¤ëŠ˜ í•˜ë£¨ ì •ë§ ê³ ìƒ ë§ìœ¼ì…¨ì–´ìš”. ë”°ëœ»í•œ ë¬¼ë¡œ ìƒ¤ì›Œí•˜ê³  í‘¹ ì‰¬ì„¸ìš”. ğŸ›",
                happy: "ì™€! ì¢‹ì€ ì¼ì´ ìˆìœ¼ì‹ ê°€ ë´ìš”! ì €ê¹Œì§€ ê¸°ë¶„ì´ ì¢‹ì•„ì§€ë„¤ìš”! ğŸ˜†ğŸ‰",
                angry: "í™”ë‚˜ëŠ” ì¼ì€ ìˆ¨ì„ ê¹Šê²Œ ë“¤ì´ë§ˆì‹œê³  ë‚´ì‰¬ì–´ ë³´ì„¸ìš”. í›„~ ğŸ˜¤"
            }
        };

        function toggleChat() { 
            const chatWin = document.getElementById('chatWindow');
            chatWin.style.display = chatWin.style.display === 'flex' ? 'none' : 'flex';
        }

        // ë‚ ì§œ íŒŒì„œ
        function parseDate(text) {
            const today = new Date();
            if(text.includes("ì˜¤ëŠ˜")) return today;
            if(text.includes("ë‚´ì¼")) { today.setDate(today.getDate()+1); return today; }
            if(text.includes("ëª¨ë ˆ")) { today.setDate(today.getDate()+2); return today; }
            return null;
        }

        // ê³„ì ˆ íŒë³„
        function getSeason() {
            const m = new Date().getMonth() + 1;
            if (m >= 3 && m <= 5) return "ë´„";
            if (m >= 6 && m <= 8) return "ì—¬ë¦„";
            if (m >= 9 && m <= 11) return "ê°€ì„";
            return "ê²¨ìš¸";
        }

        function sendChat() {
            const inp = document.getElementById('chatInput');
            const txt = inp.value.trim();
            if(!txt) return;
            
            const body = document.getElementById('chatBody');
            body.innerHTML += `<div class="chat-msg msg-user">${txt}</div>`;
            inp.value = '';
            body.scrollTop = body.scrollHeight;

            const loadingId = "loading-" + Date.now();
            body.innerHTML += `<div class="chat-msg msg-bot typing-indicator" id="${loadingId}"><span></span><span></span><span></span></div>`;
            body.scrollTop = body.scrollHeight;

            setTimeout(() => {
                document.getElementById(loadingId).remove();
                let reply = "ìŒ.. ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ë§ì”€í•´ì£¼ì‹œê² ì–´ìš”? (ì˜ˆ: ë©”ë‰´ ì¶”ì²œ, ì¼ì • ì¶”ê°€)";
                
                // 1. ì¼ìƒ/ê°ì •
                if (txt.includes("ì•ˆë…•")) reply = "ë°˜ê°€ì›Œìš”! ìš°ë¦¬ ê°€ì¡±ì˜ í–‰ë³µ ë„ìš°ë¯¸ ì²´ë¦¬ì…ë‹ˆë‹¤! ğŸ’";
                else if (txt.includes("ì‚¬ë‘í•´")) reply = "ì €ë„ìš”! ìš°ë¦¬ ê°€ì¡± ëª¨ë‘ í–‰ë³µí–ˆìœ¼ë©´ ì¢‹ê² ì–´ìš”! â¤ï¸";
                else if (txt.includes("ê³ ë§ˆì›Œ")) reply = "ë³„ë§ì”€ì„ìš”! ì–¸ì œë“  ë„ì™€ë“œë¦´ê²Œìš”. ğŸ˜Š";
                else if (txt.includes("í˜ë“¤") || txt.includes("ì§€ì³") || txt.includes("í”¼ê³¤")) reply = knowledgeBase.empathy.tired;
                else if (txt.includes("ìŠ¬í¼") || txt.includes("ìš°ìš¸")) reply = knowledgeBase.empathy.sad;
                else if (txt.includes("ê¸°ë¶„ ì¢‹ì•„") || txt.includes("í–‰ë³µ")) reply = knowledgeBase.empathy.happy;
                else if (txt.includes("í™”ë‚˜") || txt.includes("ì§œì¦")) reply = knowledgeBase.empathy.angry;

                // 2. ë¯¸ë‹ˆê²Œì„ (ê°€ìœ„ë°”ìœ„ë³´)
                else if (txt.includes("ê°€ìœ„ë°”ìœ„ë³´")) {
                    const rps = ["ê°€ìœ„ âœŒï¸", "ë°”ìœ„ âœŠ", "ë³´ ğŸ–"];
                    const result = rps[Math.floor(Math.random() * rps.length)];
                    reply = `ì•ˆ ë‚´ë©´ ì§„ ê±°! ê°€ìœ„~ ë°”ìœ„~ <b>${result}</b>!! ì œê°€ ì´ê²¼ë‚˜ìš”? ğŸ˜`;
                }

                // 3. ì§€ì‹ (ê±´ê°•, ìœ¡ì•„)
                else if (txt.includes("ê±´ê°•") || txt.includes("ìƒì‹")) {
                    reply = "ğŸ’ª <b>ì²´ë¦¬ì˜ ê±´ê°• ê¿€íŒ:</b><br>" + knowledgeBase.health[Math.floor(Math.random() * knowledgeBase.health.length)];
                }
                else if (txt.includes("ìœ¡ì•„") || txt.includes("ì•„ì´")) {
                    reply = "ğŸ‘¶ <b>ì²´ë¦¬ì˜ ìœ¡ì•„ ë©”ëª¨:</b><br>" + knowledgeBase.parenting[Math.floor(Math.random() * knowledgeBase.parenting.length)];
                }

                // 4. ë©”ë‰´ ì¶”ì²œ (ê³„ì ˆ/ëœë¤)
                else if (txt.includes("ë©”ë‰´") || txt.includes("ë­ ë¨¹ì§€") || txt.includes("ì¶”ì²œ")) {
                    const season = getSeason();
                    if(txt.includes("ê³„ì ˆ") || txt.includes("ë‚ ì”¨") || Math.random() > 0.5) {
                        const seasonalMenu = seasonalFoods[season];
                        const pick = seasonalMenu[Math.floor(Math.random() * seasonalMenu.length)];
                        reply = `ìš”ì¦˜ ê°™ì€ <b>${season}</b>ì—ëŠ” <b>${pick}</b> ì–´ë– ì„¸ìš”? ì…ë§›ì´ ì‹¹ ëŒ ê±°ì˜ˆìš”! ğŸ˜‹`;
                    } else {
                        const keys = Object.keys(recipes);
                        const pick = keys[Math.floor(Math.random() * keys.length)];
                        reply = `ì˜¤ëŠ˜ì€ <b>${pick}</b> ìš”ë¦¬ì‚¬ê°€ ë˜ì–´ë³´ì„¸ìš”! ğŸ‘¨â€ğŸ³`;
                    }
                }
                
                // 5. ìš”ë¦¬ ì¬ë£Œ & ì¥ë³´ê¸°
                else if ((txt.includes("ë¨¹ì„") || txt.includes("í•´ì¤˜") || txt.includes("ì¶”ê°€")) && (txt.includes("ì¬ë£Œ") || txt.includes("ì¥ë³´ê¸°") || txt.includes("ë‹´ì•„"))) {
                    let foundFood = null;
                    for (const food in recipes) {
                        if (txt.includes(food)) { foundFood = food; break; }
                    }

                    if (foundFood) {
                        const ingredients = recipes[foundFood];
                        ingredients.forEach(item => {
                            db.collection("family_shopping").add({ text: item, checked: false, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                        });
                        reply = `ğŸ“‹ <b>${foundFood}</b> ì ‘ìˆ˜ ì™„ë£Œ!<br>í•„ìš”í•œ ì¬ë£Œ <b>[${ingredients.join(", ")}]</b>ë¥¼ ì¥ë³´ê¸° ëª©ë¡ì— ëª¨ë‘ ë‹´ì•˜ìŠµë‹ˆë‹¤!`;
                    } else {
                        const item = txt.replace("ì¥ë³´ê¸°", "").replace("ì¶”ê°€", "").replace("í•´ì¤˜", "").replace("ë‹´ì•„ì¤˜", "").replace("ì—", "").trim();
                        if(item && item.length > 0 && item.length < 20) {
                             db.collection("family_shopping").add({ text: item, checked: false, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                             reply = `ğŸ›’ <b>${item}</b> ë©”ëª¨í–ˆìŠµë‹ˆë‹¤!`;
                        }
                    }
                }

                // 6. ì¼ì • ì¶”ê°€
                else if ((txt.includes("ì¼ì •") || txt.includes("ì•½ì†")) && (txt.includes("ì¶”ê°€") || txt.includes("ì¡ì•„"))) {
                    const targetDate = parseDate(txt);
                    if(targetDate) {
                        const dStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth()+1).padStart(2,'0')}-${String(targetDate.getDate()).padStart(2,'0')}`;
                        const title = txt.replace("ì¼ì •", "").replace("ì¶”ê°€", "").replace("í•´ì¤˜", "").replace("ì¡ì•„ì¤˜", "").replace("ë‚´ì¼", "").replace("ì˜¤ëŠ˜", "").replace("ëª¨ë ˆ", "").trim();
                        if(title) {
                            db.collection("family_events").add({ date: dStr, title: title, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                            reply = `ğŸ“… <b>${dStr}</b>ì— <b>"${title}"</b> ì¼ì •ì„ ë“±ë¡í–ˆìŠµë‹ˆë‹¤!`;
                        } else {
                            reply = "ì¼ì • ë‚´ìš©ì„ í•¨ê»˜ ë§ì”€í•´ì£¼ì„¸ìš”. (ì˜ˆ: ë‚´ì¼ ì €ë… ì•½ì† ì¶”ê°€í•´ì¤˜)";
                        }
                    } else {
                        reply = "ì–¸ì œ ì¼ì •ì¸ê°€ìš”? (ì˜¤ëŠ˜, ë‚´ì¼, ëª¨ë ˆ ì¤‘ í•˜ë‚˜ë¥¼ ë§í•´ì£¼ì„¸ìš”)";
                    }
                }

                // 7. ì¼ì • ì‚­ì œ
                else if ((txt.includes("ì¼ì •") || txt.includes("ì•½ì†")) && (txt.includes("ì·¨ì†Œ") || txt.includes("ì‚­ì œ") || txt.includes("ì§€ì›Œ"))) {
                    const targetDate = parseDate(txt);
                    if(targetDate) {
                        const dStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth()+1).padStart(2,'0')}-${String(targetDate.getDate()).padStart(2,'0')}`;
                        db.collection("family_events").where("date", "==", dStr).get().then(snap => {
                            if(snap.empty) {
                                body.innerHTML += `<div class="chat-msg msg-bot">ğŸ“… ${dStr}ì—ëŠ” ì¼ì •ì´ ì—†ì–´ìš”.</div>`;
                            } else {
                                let cnt = 0;
                                snap.forEach(doc => {
                                    db.collection("family_events").doc(doc.id).delete();
                                    cnt++;
                                });
                                body.innerHTML += `<div class="chat-msg msg-bot">ğŸ—‘ï¸ ${dStr}ì˜ ì¼ì • ${cnt}ê°œë¥¼ ëª¨ë‘ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.</div>`;
                                body.scrollTop = body.scrollHeight;
                            }
                        });
                        return;
                    } else {
                        reply = "ì–¸ì œ ì¼ì •ì„ ì§€ìš¸ê¹Œìš”? (ì˜ˆ: ë‚´ì¼ ì¼ì • ì‚­ì œ)";
                    }
                }

                body.innerHTML += `<div class="chat-msg msg-bot">${reply}</div>`;
                body.scrollTop = body.scrollHeight;
            }, 700);
        }

        /* --- ì¥ë³´ê¸° --- */
        function loadShopping() {
            db.collection("family_shopping").orderBy("timestamp", "desc").onSnapshot(snap => {
                const list = document.getElementById('shopList');
                list.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const checkedClass = d.checked ? "checked" : "";
                    const checkColor = d.checked ? "on" : "";
                    list.innerHTML += `
                    <div class="shop-item ${checkedClass}">
                        <div style="display:flex; align-items:center;">
                            <div class="shop-check ${checkColor}" onclick="toggleShop('${doc.id}', ${!d.checked})"><i class="fa-solid fa-check" style="color:white; font-size:12px;"></i></div>
                            <span>${d.text}</span>
                        </div>
                        <i class="fa-solid fa-times shop-del" onclick="delShop('${doc.id}')"></i>
                    </div>`;
                });
            });
        }
        function addShopItem() {
            const inp = document.getElementById('shopInput');
            if(inp.value.trim()) {
                db.collection("family_shopping").add({ text: inp.value, checked: false, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                inp.value = '';
            }
        }
        function toggleShop(id, stat) { db.collection("family_shopping").doc(id).update({ checked: stat }); }
        function delShop(id) { if(confirm("ì‚­ì œ?")) db.collection("family_shopping").doc(id).delete(); }

        /* ê¸°ì¡´ ë¡œì§ë“¤ (ê°€ì¡±, í”¼ë“œ, ìº˜ë¦°ë” ë“±ì€ ê·¸ëŒ€ë¡œ ìœ ì§€) */
        let familyData=[], selectedRole="";
        function loadFamily(){
            db.collection("family_members").orderBy("timestamp").onSnapshot(snap=>{
                familyData=[]; const con=document.getElementById('family-container'); const chips=document.getElementById('writerChips');
                con.innerHTML=""; chips.innerHTML=""; 
                if(snap.empty) chips.innerHTML=`<div style="padding:10px;font-size:14px;color:#aaa;">ê°€ì¡±ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”!</div>`;
                snap.forEach(doc=>{
                    const d=doc.data(); familyData.push({id:doc.id,...d});
                    const imgHtml=d.imageUrl?`<img src="${d.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user" style="font-size:30px;"></i>`;
                    con.innerHTML+=`<div class="mem-card"><button class="del-btn" onclick="delFamily('${doc.id}')" style="position:absolute;top:10px;right:10px;border:none;background:none;color:#999;"><i class="fa-solid fa-times"></i></button><div class="mem-pic">${imgHtml}</div><div class="mem-role">${d.role}</div><div class="mem-desc">${d.desc||'Yummy!'}</div></div>`;
                    const chk=selectedRole===d.role?'checked':'';
                    chips.innerHTML+=`<input type="radio" name="auth" id="c-${doc.id}" class="radio-hidden" value="${d.role}" onchange="selAuth(this)" ${chk}><label for="c-${doc.id}" class="writer-tag"><div style="width:24px;height:24px;border-radius:50%;overflow:hidden;background:#eee;border:1px solid #444;display:flex;align-items:center;justify-content:center;">${d.imageUrl?`<img src="${d.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user" style="font-size:12px;"></i>`}</div> ${d.role}</label>`;
                });
                con.innerHTML+=`<div class="mem-card add-card" onclick="openFamModal()"><i class="fa-solid fa-plus-circle" style="font-size:40px;"></i><span style="font-family:'Jua';font-size:18px;">ê°€ì¡± ì¶”ê°€</span></div>`;
                updateHeaderProf();
            });
        }
        function selAuth(rd){ selectedRole=rd.value; updateHeaderProf(); }
        function updateHeaderProf(){ 
            const hp=document.getElementById('headerProfile'); 
            if(!selectedRole){ hp.innerHTML=`<i class="fa-solid fa-user"></i>`; return; }
            const mem=familyData.find(m=>m.role===selectedRole);
            if(mem&&mem.imageUrl) hp.innerHTML=`<img src="${mem.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`;
            else hp.innerHTML=`<i class="fa-solid fa-user"></i>`;
        }

        let feedImg=null;
        function handleImageSelect(e){if(e.target.files[0])compressImage(e.target.files[0],500,d=>{feedImg=d;document.getElementById('imagePreview').src=d;document.getElementById('imagePreviewBox').style.display='block';});}
        function clearImage(){feedImg=null;document.getElementById('imageInput').value='';document.getElementById('imagePreviewBox').style.display='none';}
        function addPost(){
            if(!selectedRole) return alert("ëˆ„ê°€ ê¸€ì„ ì“°ë‚˜ìš”? ê°€ì¡±ì„ ì„ íƒí•´ì£¼ì„¸ìš”!"); const txt=document.getElementById('postContent').value, btn=document.getElementById('btnPost');
            if(!txt&&!feedImg) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); const mem=familyData.find(m=>m.role===selectedRole); btn.disabled=true; btn.innerText="ì €ì¥ ì¤‘...";
            db.collection("family_posts").add({author:selectedRole,authorImg:mem?mem.imageUrl:null,content:txt,imageUrl:feedImg,likes:0,comments:[],timestamp:firebase.firestore.FieldValue.serverTimestamp()})
            .then(()=>{document.getElementById('postContent').value='';clearImage();btn.disabled=false;btn.innerText="ì—…ë¡œë“œ!"; window.scrollTo(0,0);})
            .catch(e=>{alert("ì‹¤íŒ¨!");btn.disabled=false;btn.innerText="ì—…ë¡œë“œ!";});
        }
        function loadFeed(){
            db.collection("family_posts").limit(20).onSnapshot(snap=>{
                const con=document.getElementById('feed-container'); con.innerHTML=""; let posts=[]; snap.forEach(d=>posts.push({id:d.id,...d.data()}));
                posts.sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
                if(posts.length===0) con.innerHTML=`<div style="text-align:center;padding:40px;color:#aaa;">ì²« ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”! ğŸ’</div>`;
                posts.forEach(d=>{
                    const pImg=d.authorImg?`<div class="fp-img"><img src="${d.authorImg}" style="width:100%;height:100%;object-fit:cover;"></div>`:`<div class="fp-img"><i class="fa-solid fa-user"></i></div>`;
                    const iHtml=d.imageUrl?`<div class="feed-photo"><img src="${d.imageUrl}"></div>`:'';
                    let cmts=""; if(d.comments)d.comments.forEach(c=>cmts+=`<div class="cmt-bubble"><b>${c.author}</b>: ${c.text}</div>`);
                    let opts=""; familyData.forEach(m=>opts+=`<option value="${m.role}" ${m.role===selectedRole?'selected':''}>${m.role}</option>`);
                    con.innerHTML+=`<div class="retro-card"><div class="feed-head"><div class="feed-profile">${pImg}<div class="fp-info"><h4>${d.author}</h4><span>${d.timestamp?new Date(d.timestamp.seconds*1000).toLocaleDateString():'ë°©ê¸ˆ'}</span></div></div><button onclick="delPost('${d.id}')" style="border:none;background:none;color:#999;"><i class="fa-solid fa-trash"></i></button></div><div class="feed-text">${d.content}</div>${iHtml}<div class="feed-actions"><button class="act-btn ${d.likes>0?'liked':''}" onclick="likePost('${d.id}',${d.likes})"><i class="fa-solid fa-heart"></i> ${d.likes||0}</button><button class="act-btn" onclick="toggleCmt('${d.id}')"><i class="fa-solid fa-comment"></i> ëŒ“ê¸€</button></div><div id="cmt-${d.id}" class="cmt-area"><div style="margin-bottom:10px;max-height:150px;overflow-y:auto;">${cmts}</div><div class="cmt-inp-box"><select id="cAuth-${d.id}" style="border:1px solid #444;border-radius:5px;">${opts}</select><input type="text" id="cInp-${d.id}" style="flex:1;border:1px solid #444;border-radius:5px;padding:5px;" placeholder="ëŒ“ê¸€..." onkeydown="if(event.key==='Enter')addCmt('${d.id}')"><button class="cmt-send" onclick="addCmt('${d.id}')"><i class="fa-solid fa-arrow-up"></i></button></div></div></div>`;
                });
            });
        }
        function likePost(id,n){db.collection("family_posts").doc(id).update({likes:(n||0)+1});}
        function delPost(id){if(confirm("ì‚­ì œ?"))db.collection("family_posts").doc(id).delete();}
        function toggleCmt(id){document.getElementById(`cmt-${id}`).classList.toggle('show');}
        function addCmt(id){const r=document.getElementById(`cAuth-${id}`).value,t=document.getElementById(`cInp-${id}`).value; if(!t)return; db.collection("family_posts").doc(id).update({comments:firebase.firestore.FieldValue.arrayUnion({author:r,text:t})});}

        let curDate=new Date(), events=[], curModDate=null;
        function loadCal(){
            const y=curDate.getFullYear(), m=curDate.getMonth(); document.getElementById('month-display').innerText=`${m+1}ì›”`;
            const f=new Date(y,m,1), l=new Date(y,m+1,0), con=document.getElementById('calendar-days'); con.innerHTML="";
            for(let i=0;i<f.getDay();i++)con.innerHTML+=`<div></div>`;
            for(let i=1;i<=l.getDate();i++){
                const dStr=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`, evs=events.filter(e=>e.date===dStr), hasEv=evs.length?`<div class="ev-badge"></div>`:'', tdy=new Date().toDateString()===new Date(y,m,i).toDateString()?'today':'';
                con.innerHTML+=`<div class="date-box ${tdy}" onclick="openEvModal('${dStr}')"><span class="date-num">${i}</span>${hasEv}</div>`;
            }
        }
        function moveMonth(n){curDate.setMonth(curDate.getMonth()+n);loadCal();}
        function openEvModal(d){curModDate=d; document.getElementById('modalDateDisplay').innerText=d; renderEvList(); document.getElementById('eventModal').style.display='flex';}
        function renderEvList(){const el=document.getElementById('eventList'), evs=events.filter(e=>e.date===curModDate); el.innerHTML=evs.length?"":"<li style='text-align:center;color:#999;'>ì¼ì • ì—†ìŒ</li>"; evs.forEach(e=>el.innerHTML+=`<li style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #ccc;"><span>${e.title}</span><i class="fa-solid fa-times" style="color:red;cursor:pointer;" onclick="delEv('${e.id}')"></i></li>`);}
        function saveEvent(){const t=document.getElementById('eventTitle').value; if(curModDate&&t) db.collection("family_events").add({date:curModDate,title:t,timestamp:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{document.getElementById('eventTitle').value='';closeModal('eventModal');});}
        function delEv(id){if(confirm("ì‚­ì œ?"))db.collection("family_events").doc(id).delete();}
        db.collection("family_events").onSnapshot(s=>{events=[];s.forEach(d=>events.push({id:d.id,...d.data()}));loadCal();if(curModDate)renderEvList();});

        let famImg=null; function closeModal(id){document.getElementById(id).style.display='none';famImg=null;curModDate=null;}
        function openFamModal(){document.getElementById('familyModal').style.display='flex';}
        function handleFamImgSelect(e){if(e.target.files[0])compressImage(e.target.files[0],500,d=>{famImg=d;document.getElementById('famImgPreview').innerHTML=`<img src="${d}" style="width:100%;height:100%;object-fit:cover;">`;});}
        function saveFam(){
            const r=document.getElementById('famRole').value, n=document.getElementById('famName').value, d=document.getElementById('famDesc').value; if(!r)return alert("ì—­í•  ì…ë ¥!"); const btn=document.getElementById('btnSaveFam'); btn.disabled=true; btn.innerText="ì €ì¥ ì¤‘...";
            db.collection("family_members").add({role:r,name:n,desc:d,imageUrl:famImg,timestamp:firebase.firestore.FieldValue.serverTimestamp()})
            .then(()=>{closeModal('familyModal');btn.disabled=false;btn.innerText="ì¶”ê°€";document.getElementById('famRole').value='';document.getElementById('famName').value='';document.getElementById('famDesc').value='';document.getElementById('famImgInput').value='';document.getElementById('famImgPreview').innerHTML=`<i class="fa-solid fa-camera" style="font-size:30px;color:var(--text-choco);"></i>`;})
            .catch(e=>{alert("ì˜¤ë¥˜!");btn.disabled=false;btn.innerText="ì¶”ê°€";});
        }
        function delFamily(id){if(confirm("ì‚­ì œ?"))db.collection("family_members").doc(id).delete();}

        window.changeTab=function(id,el){document.querySelectorAll('.tab-section').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));if(el)el.classList.add('active');window.scrollTo(0,0);}
        
        loadFeed(); loadCal(); loadFamily(); loadShopping();
    </script>
</body>
</html>
