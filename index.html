<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Yummy Family Log</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=DM+Serif+Display&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* [Theme: Retro 3D Cafe] */
        :root {
            /* Palette based on 'Yummy Yummy' image */
            --bg-cream: #FFFDF5; /* ë”°ëœ»í•œ í¬ë¦¼ìƒ‰ */
            --text-choco: #4A2c2A; /* ì§„í•œ ì´ˆì½œë¦¿ìƒ‰ í…ìŠ¤íŠ¸ */
            --accent-red: #D94844; /* ì²´ë¦¬ ë ˆë“œ */
            --accent-pink: #FFD1D1;
            --accent-yellow: #FFD56B;
            
            /* UI Elements */
            --border-thick: 2px solid #4A2c2A;
            --shadow-hard: 4px 4px 0px #4A2c2A; /* ë ˆíŠ¸ë¡œí•œ í•˜ë“œ ì‰ë„ìš° */
            --radius-L: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-cream); 
            color: var(--text-choco);
            min-height: 100vh; overflow-x: hidden;
            /* ì¢…ì´ ì§ˆê° ì˜¤ë²„ë ˆì´ */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        }

        /* --- [ë°°ê²½ 3D ë‘¥ë‘¥ ë– ë‹¤ë‹ˆëŠ” ì˜¤ë¸Œì íŠ¸] --- */
        .floating-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden;
            perspective: 1000px; pointer-events: none;
        }
        .floater {
            position: absolute; opacity: 0.8;
            animation: float3D 6s ease-in-out infinite alternate;
        }
        /* ì²´ë¦¬, ë³„, êµ¬ë¦„ ë“± */
        .obj-1 { top: 10%; left: 5%; font-size: 40px; color: var(--accent-red); animation-duration: 7s; } /* ë³„ */
        .obj-2 { top: 20%; right: -5%; font-size: 80px; color: var(--accent-pink); animation-duration: 9s; animation-delay: 1s; opacity: 0.5; } /* ì› */
        .obj-3 { bottom: 15%; left: -10%; font-size: 100px; color: var(--accent-yellow); animation-duration: 8s; animation-delay: -2s; opacity: 0.6; } /* êµ¬ë¦„ */
        .obj-4 { bottom: 30%; right: 10%; font-size: 30px; color: var(--accent-red); animation-duration: 6s; } /* ë°˜ì§ì„ */
        
        @keyframes float3D {
            0% { transform: translateY(0) rotate(0deg) translateZ(0); }
            100% { transform: translateY(-30px) rotate(10deg) translateZ(50px); }
        }

        /* ë ˆì´ì•„ì›ƒ */
        .app-layout { max-width: 600px; margin: 0 auto; padding-bottom: 120px; position: relative; }

        /* í—¤ë”: Yummy ìŠ¤íƒ€ì¼ */
        .header { 
            padding: 30px 24px; text-align: center;
            position: sticky; top: 0; z-index: 50;
            background: rgba(255, 253, 245, 0.9); backdrop-filter: blur(5px);
            border-bottom: var(--border-thick);
        }
        .brand-title {
            font-family: 'DM Serif Display', serif; /* ë ˆíŠ¸ë¡œ ì˜ë¬¸ í°íŠ¸ */
            font-size: 36px; color: var(--accent-red);
            text-shadow: 2px 2px 0px var(--text-choco); /* ê¸€ì ì…ì²´ê° */
            letter-spacing: 1px; margin-bottom: 5px;
        }
        .brand-sub { font-family: 'Jua', sans-serif; font-size: 16px; color: var(--text-choco); }

        .my-badge {
            position: absolute; right: 20px; top: 30px;
            width: 45px; height: 45px; background: white; border: var(--border-thick); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            box-shadow: var(--shadow-hard); transition: 0.2s;
        }
        .my-badge:active { transform: translate(2px, 2px); box-shadow: none; }

        /* --- [UI ì»´í¬ë„ŒíŠ¸: ë ˆíŠ¸ë¡œ íŒ] --- */
        /* ì¹´ë“œ: ìŠ¤í‹°ì»¤ ëŠë‚Œ */
        .retro-card {
            background: white; border: var(--border-thick); border-radius: var(--radius-L);
            padding: 24px; margin: 24px 20px;
            box-shadow: var(--shadow-hard); position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        /* í˜¸ë²„/í„°ì¹˜ ì‹œ ê¾¹ ëˆŒë¦¬ëŠ” íš¨ê³¼ */
        .retro-card:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px var(--text-choco); }

        /* ë²„íŠ¼: ì•Œì•½ ëª¨ì–‘ + í•˜ë“œ ì‰ë„ìš° */
        .btn-pop {
            background: var(--accent-red); color: white; border: var(--border-thick);
            padding: 12px 24px; border-radius: 50px;
            font-family: 'Jua', sans-serif; font-size: 18px; cursor: pointer;
            box-shadow: var(--shadow-hard); transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%;
        }
        .btn-pop:hover { transform: translateY(-2px); }
        .btn-pop:active { transform: translate(2px, 2px); box-shadow: none; background: #C0392B; }
        .btn-pop.yellow { background: var(--accent-yellow); color: var(--text-choco); }

        /* ì…ë ¥ì°½ */
        .input-retro {
            width: 100%; background: #FFF; border: var(--border-thick); border-radius: 16px;
            padding: 14px; font-size: 16px; color: var(--text-choco); outline: none; font-family: 'Noto Sans KR', sans-serif;
            box-shadow: inset 2px 2px 5px rgba(74, 44, 42, 0.1);
        }
        .input-retro:focus { background: #FFF0F0; }

        /* íƒ­ ì „í™˜ */
        .tab-section { display: none; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .tab-section.active { display: block; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* --- [1] í”¼ë“œ (ìŠ¤í¬ë©ë¶ ìŠ¤íƒ€ì¼) --- */
        .writer-scroll { display: flex; gap: 12px; margin-bottom: 20px; overflow-x: auto; padding: 5px; scrollbar-width: none; }
        .writer-scroll::-webkit-scrollbar { display: none; }
        .radio-hidden { display: none; }
        .writer-tag {
            padding: 8px 16px; background: white; border: var(--border-thick); border-radius: 30px;
            font-family: 'Jua', sans-serif; font-size: 16px; color: var(--text-choco); cursor: pointer;
            transition: 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 6px;
            box-shadow: 2px 2px 0px rgba(74, 44, 42, 0.2);
        }
        .radio-hidden:checked + .writer-tag {
            background: var(--accent-red); color: white; box-shadow: var(--shadow-hard); transform: translateY(-2px);
        }

        .img-preview { width: 100%; border: var(--border-thick); border-radius: 16px; margin-top: 15px; overflow: hidden; position: relative; display: none; background: white; }
        .img-preview img { width: 100%; display: block; }
        .btn-x { position: absolute; top: 10px; right: 10px; background: var(--text-choco); color: white; width: 30px; height: 30px; border-radius: 50%; border: none; font-weight: bold; cursor: pointer; }

        /* í”¼ë“œ ì•„ì´í…œ */
        .feed-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px dashed #E5D0C0; padding-bottom: 10px; }
        .feed-profile { display: flex; align-items: center; gap: 10px; }
        .fp-img { width: 45px; height: 45px; border-radius: 50%; border: var(--border-thick); object-fit: cover; background: white; }
        .fp-info h4 { font-family: 'Jua', sans-serif; font-size: 18px; margin: 0; }
        .fp-info span { font-size: 12px; opacity: 0.7; }
        
        .feed-photo { 
            padding: 10px; background: white; border: var(--border-thick); 
            transform: rotate(-1deg); margin-bottom: 15px; box-shadow: 3px 3px 0px rgba(0,0,0,0.1);
        }
        .feed-photo img { width: 100%; border: 1px solid #eee; display: block; }
        .feed-text { font-size: 16px; line-height: 1.6; margin-bottom: 15px; white-space: pre-wrap; }

        .feed-actions { display: flex; gap: 10px; }
        .act-btn { 
            padding: 8px 12px; background: var(--bg-cream); border: 2px solid #E5D0C0; border-radius: 12px; 
            font-weight: 700; font-size: 13px; color: var(--text-choco); display: flex; gap: 6px; align-items: center; cursor: pointer; transition: 0.2s;
        }
        .act-btn.liked { background: var(--accent-pink); border-color: var(--accent-red); color: var(--accent-red); }
        .act-btn:active { transform: scale(0.95); }

        /* ëŒ“ê¸€ */
        .cmt-area { background: #FFF8E7; border: 2px dashed #E5D0C0; border-radius: 16px; padding: 15px; margin-top: 15px; display: none; }
        .cmt-bubble { background: white; padding: 8px 12px; border: 1px solid #E5D0C0; border-radius: 12px; margin-bottom: 8px; font-size: 14px; }
        .cmt-inp-box { display: flex; gap: 8px; margin-top: 10px; }
        .cmt-send { width: 35px; height: 35px; background: var(--text-choco); color: white; border-radius: 50%; border: none; cursor: pointer; }

        /* --- [2] ìº˜ë¦°ë” (íƒìƒ ë‹¬ë ¥) --- */
        .cal-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .cal-title { font-family: 'DM Serif Display', serif; font-size: 32px; color: var(--accent-red); }
        .cal-arrow { width: 40px; height: 40px; background: white; border: var(--border-thick); border-radius: 50%; cursor: pointer; font-size: 18px; box-shadow: 2px 2px 0px var(--text-choco); transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .cal-arrow:active { transform: translate(2px, 2px); box-shadow: none; }

        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .day-label { font-family: 'Jua', sans-serif; color: var(--text-choco); margin-bottom: 5px; }
        .date-box { 
            min-height: 70px; background: white; border: 2px solid #E5D0C0; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; padding: 5px; cursor: pointer; transition: 0.2s;
        }
        .date-box:hover { border-color: var(--accent-red); transform: translateY(-3px); }
        .date-box.today { background: var(--accent-yellow); border: var(--border-thick); box-shadow: var(--shadow-hard); }
        .date-num { font-family: 'Jua', sans-serif; font-size: 16px; }
        .ev-badge { width: 8px; height: 8px; background: var(--accent-red); border-radius: 50%; border: 1px solid var(--text-choco); margin-top: 4px; }

        /* --- [3] ê°€ì¡± (í¬í† ì¹´ë“œ) --- */
        .family-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; padding: 0 10px; }
        .mem-card { 
            background: white; border: var(--border-thick); border-radius: 24px; padding: 20px 10px; text-align: center; 
            box-shadow: var(--shadow-hard); position: relative; transition: 0.2s;
        }
        .mem-card:hover { transform: translateY(-5px); }
        .mem-pic { width: 80px; height: 80px; border-radius: 50%; border: var(--border-thick); object-fit: cover; margin-bottom: 10px; background: var(--bg-cream); }
        .mem-role { font-family: 'Jua', sans-serif; font-size: 22px; color: var(--text-choco); }
        .mem-desc { font-size: 12px; background: var(--accent-pink); padding: 4px 8px; border-radius: 10px; border: 1px solid var(--text-choco); display: inline-block; margin-top: 5px; font-weight: 700; }
        .del-btn { position: absolute; top: 10px; right: 10px; color: #aaa; background: none; border: none; cursor: pointer; }
        
        .add-card { border: 2px dashed var(--text-choco); background: rgba(255,255,255,0.5); box-shadow: none; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; min-height: 200px; color: var(--text-choco); gap: 10px; }
        .add-card:hover { background: white; border-style: solid; }

        /* ë„¤ë¹„ê²Œì´ì…˜ (ë ˆíŠ¸ë¡œ ë…) */
        .nav-dock {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px;
            background: var(--text-choco); border-radius: 40px; box-shadow: 0 10px 20px rgba(74, 44, 42, 0.3);
            display: flex; justify-content: space-around; align-items: center; padding: 0 20px; z-index: 100;
            border: 2px solid white;
        }
        .nav-item { color: rgba(255,255,255,0.5); font-size: 24px; cursor: pointer; transition: 0.3s; position: relative; }
        .nav-item.active { color: var(--accent-yellow); transform: translateY(-5px); }
        .nav-item.active::after { content:''; position:absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background: var(--accent-yellow); border-radius: 50%; }

        /* ëª¨ë‹¬ */
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(74, 44, 42, 0.6); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-card { background: var(--bg-cream); width: 85%; max-width: 350px; padding: 25px; border: var(--border-thick); border-radius: var(--radius-L); box-shadow: 8px 8px 0px rgba(0,0,0,0.2); animation: popUp 0.3s; }
        .modal-tit { font-family: 'Jua', sans-serif; font-size: 24px; text-align: center; margin-bottom: 20px; color: var(--accent-red); }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }

        @media (min-width: 768px) {
            .app-layout { padding: 40px; }
            .nav-dock { bottom: auto; top: 50%; left: 40px; transform: translateY(-50%); width: 70px; height: 300px; flex-direction: column; padding: 30px 0; }
            .nav-item.active { transform: translateX(5px); }
            .nav-item.active::after { bottom: auto; left: -10px; top: 50%; transform: translateY(-50%); }
            .family-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="floating-bg">
        <i class="fa-solid fa-star floater obj-1"></i>
        <i class="fa-solid fa-circle floater obj-2"></i>
        <i class="fa-solid fa-cloud floater obj-3"></i>
        <i class="fa-solid fa-sparkles floater obj-4"></i>
    </div>

    <div class="app-layout">
        <header class="header">
            <div class="brand-title">Yummy Family</div>
            <div class="brand-sub">ìš°ë¦¬ ê°€ì¡±ì˜ ë§›ìˆëŠ” ì¼ìƒ ğŸ’</div>
            <div class="my-badge" id="headerProfile">
                <i class="fa-solid fa-user" style="color:var(--text-choco);"></i>
            </div>
        </header>

        <main id="mainContent">
            <div id="feed" class="tab-section active">
                <div class="retro-card">
                    <div style="font-family:'Jua'; font-size:20px; margin-bottom:15px; color:var(--text-choco);">
                        <i class="fa-solid fa-pen-fancy" style="color:var(--accent-red);"></i> ì˜¤ëŠ˜ì˜ ì¶”ì–µ ê¸°ë¡í•˜ê¸°
                    </div>
                    
                    <div class="writer-scroll" id="writerChips">
                        <div style="font-size:14px; color:#aaa; padding:10px;">ê°€ì¡±ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”!</div>
                    </div>
                    
                    <textarea id="postContent" class="input-retro" style="min-height:100px; resize:none;" placeholder="ì˜¤ëŠ˜ ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆë‚˜ìš”? ğŸ°"></textarea>
                    
                    <div id="imagePreviewBox" class="img-preview">
                        <img id="imagePreview" src="">
                        <button class="btn-x" onclick="clearImage()"><i class="fa-solid fa-times"></i></button>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                        <label for="imageInput" style="font-size:24px; color:var(--text-choco); cursor:pointer;"><i class="fa-regular fa-image"></i></label>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                        <button id="btnPost" class="btn-pop" style="width:auto; padding:10px 30px;" onclick="addPost()">ì—…ë¡œë“œ!</button>
                    </div>
                </div>

                <div id="loading-spinner" style="text-align:center; padding:40px; color:var(--accent-red); display:none;">
                    <i class="fa-solid fa-cookie fa-spin" style="font-size:30px;"></i> êµ½ëŠ” ì¤‘...
                </div>
                
                <div id="feed-container"></div>
                
                <div style="text-align:center; margin-top:30px;">
                    <button id="btnLoadMore" class="btn-pop yellow" style="display:none; margin:0 auto; width:auto;" onclick="loadMorePosts()">ë” ë³´ê¸° ğŸ‘‡</button>
                </div>
            </div>

            <div id="calendar" class="tab-section">
                <div class="retro-card">
                    <div class="cal-top">
                        <button class="cal-arrow" onclick="moveMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                        <div id="month-display" class="cal-title"></div>
                        <button class="cal-arrow" onclick="moveMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <div class="cal-grid" style="margin-bottom:10px;">
                        <div class="day-label" style="color:var(--accent-red)">SUN</div><div class="day-label">MON</div><div class="day-label">TUE</div><div class="day-label">WED</div><div class="day-label">THU</div><div class="day-label">FRI</div><div class="day-label">SAT</div>
                    </div>
                    <div id="calendar-days" class="cal-grid"></div>
                </div>
            </div>

            <div id="family" class="tab-section">
                <div style="text-align:center; margin-bottom:20px; font-family:'Jua'; font-size:28px; color:var(--text-choco);">
                    ìš°ë¦¬ ê°€ì¡± ë©¤ë²„ë“¤ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦
                </div>
                <div id="family-container" class="family-grid"></div>
                <div id="noFamilyMsg" style="text-align:center; padding:50px; color:#aaa; display:none; font-family:'Jua';">
                    ì•„ì§ ê°€ì¡±ì´ ì—†ì–´ìš”! ì¶”ê°€í•´ì£¼ì„¸ìš” ğŸ’
                </div>
            </div>
        </main>

        <nav class="nav-dock">
            <div class="nav-item active" onclick="changeTab('feed', this)">
                <i class="fa-solid fa-house"></i>
            </div>
            <div class="nav-item" onclick="changeTab('calendar', this)">
                <i class="fa-solid fa-calendar-days"></i>
            </div>
            <div class="nav-item" onclick="changeTab('family', this)">
                <i class="fa-solid fa-users"></i>
            </div>
        </nav>
    </div>

    <div id="eventModal" class="modal-bg">
        <div class="modal-card">
            <div class="modal-tit">ğŸ“… ì¼ì • ê¸°ë¡</div>
            <p id="modalDateDisplay" style="text-align:center; font-weight:bold; margin-bottom:20px; color:var(--text-choco);"></p>
            <ul id="eventList" style="list-style:none; margin-bottom:20px; color:var(--text-choco);"></ul>
            <input type="hidden" id="eventDate">
            <input type="text" id="eventTitle" class="input-retro" placeholder="ì¼ì • ë‚´ìš©" onkeydown="handleEnter(event)">
            <div class="modal-btns">
                <button class="btn-pop" style="background:#ddd; color:#555; border-color:#999; box-shadow:none;" onclick="closeModal('eventModal')">ë‹«ê¸°</button>
                <button class="btn-pop" onclick="saveEvent()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="familyModal" class="modal-bg">
        <div class="modal-card">
            <div class="modal-tit">ğŸ’ ê°€ì¡± ì¶”ê°€</div>
            <div style="text-align:center; margin-bottom:20px;">
                <label for="famImgInput" style="display:inline-block; cursor:pointer;">
                    <div id="famImgPreview" style="width:100px; height:100px; border-radius:50%; background:var(--bg-cream); border:var(--border-thick); display:flex; align-items:center; justify-content:center; overflow:hidden;">
                        <i class="fa-solid fa-camera" style="font-size:30px; color:var(--text-choco);"></i>
                    </div>
                </label>
                <input type="file" id="famImgInput" accept="image/*" style="display:none;" onchange="handleFamImgSelect(event)">
            </div>
            <input type="text" id="famRole" class="input-retro" placeholder="ì—­í•  (ì˜ˆ: ì•„ë¹ )" style="margin-bottom:10px;">
            <input type="text" id="famName" class="input-retro" placeholder="ì´ë¦„ (ì„ íƒ)" style="margin-bottom:10px;">
            <input type="text" id="famDesc" class="input-retro" placeholder="í•œ ë§ˆë”” ì†Œê°œ">
            <div class="modal-btns">
                <button class="btn-pop" style="background:#ddd; color:#555; border-color:#999; box-shadow:none;" onclick="closeModal('familyModal')">ì·¨ì†Œ</button>
                <button id="btnSaveFam" class="btn-pop" onclick="saveFamily()">ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCokmBJyH6xGaB42u_ScP6k7ghEVxTZSio", authDomain: "our-family-home.firebaseapp.com", projectId: "our-family-home", storageBucket: "our-family-home.firebasestorage.app", messagingSenderId: "446464856858", appId: "1:446464856858:web:344f2c83aeda0ea9ae52a3" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore();
        function compressImage(f,mW,cb){const r=new FileReader();r.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');let w=i.width,h=i.height;if(w>mW){h*=mW/w;w=mW;}c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);cb(c.toDataURL('image/jpeg',0.8));};i.src=e.target.result;};r.readAsDataURL(f);}

        let familyData=[], selectedRole="";
        function loadFamily(){
            db.collection("family_members").orderBy("timestamp").onSnapshot(snap=>{
                familyData=[]; const con=document.getElementById('family-container'); const chips=document.getElementById('writerChips');
                con.innerHTML=""; chips.innerHTML=""; document.getElementById('noFamilyMsg').style.display=snap.empty?'block':'none';
                if(snap.empty) chips.innerHTML=`<div style="font-size:14px;color:#aaa;padding:10px;">ê°€ì¡±ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”!</div>`;
                snap.forEach(doc=>{
                    const d=doc.data(); familyData.push({id:doc.id,...d});
                    const imgHtml=d.imageUrl?`<img src="${d.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user" style="font-size:24px;color:#4A2c2A;"></i>`;
                    con.innerHTML+=`<div class="mem-card"><button class="del-btn" onclick="delFamily('${doc.id}')"><i class="fa-solid fa-times"></i></button><div class="mem-pic" style="display:flex;align-items:center;justify-content:center;overflow:hidden;">${imgHtml}</div><div class="mem-role">${d.role}</div><div class="mem-desc">${d.desc||'Yummy!'}</div></div>`;
                    chips.innerHTML+=`<input type="radio" name="auth" id="c-${doc.id}" class="radio-hidden" value="${d.role}" data-id="${doc.id}" onchange="selAuth(this)"><label for="c-${doc.id}" class="writer-tag"><div style="width:20px;height:20px;border-radius:50%;overflow:hidden;background:#eee;border:1px solid #444;display:flex;align-items:center;justify-content:center;">${d.imageUrl?`<img src="${d.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user" style="font-size:10px;"></i>`}</div> ${d.role}</label>`;
                });
                con.innerHTML+=`<div class="mem-card add-card" onclick="openFamModal()"><i class="fa-solid fa-plus-circle" style="font-size:40px;"></i><span style="font-family:'Jua';font-size:18px;">ê°€ì¡± ì¶”ê°€</span></div>`;
                updateHeaderProf();
            });
        }
        function selAuth(rd){ selectedRole=rd.value; updateHeaderProf(); }
        function updateHeaderProf(){ const hp=document.getElementById('headerProfile'); if(!selectedRole){ hp.innerHTML=`<i class="fa-solid fa-user" style="color:#aaa;"></i>`; return; } const mem=familyData.find(m=>m.role===selectedRole); if(mem&&mem.imageUrl) hp.innerHTML=`<img src="${mem.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`; else hp.innerHTML=`<i class="fa-solid fa-user" style="color:var(--text-choco);"></i>`; }

        let feedImg=null, postLimit=5, unsubFeed=null;
        function handleImageSelect(e){if(e.target.files[0])compressImage(e.target.files[0],1024,d=>{feedImg=d;document.getElementById('imagePreview').src=d;document.getElementById('imagePreviewBox').style.display='block';});}
        function clearImage(){feedImg=null;document.getElementById('imageInput').value='';document.getElementById('imagePreviewBox').style.display='none';}
        function addPost(){
            if(!selectedRole) return alert("ëˆ„ê°€ ì“°ë‚˜ìš”? ìœ„ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”!"); const txt=document.getElementById('postContent').value, btn=document.getElementById('btnPost');
            if(!txt&&!feedImg) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); const mem=familyData.find(m=>m.role===selectedRole); btn.disabled=true; btn.innerText="ì €ì¥ ì¤‘...";
            db.collection("family_posts").add({author:selectedRole,authorImg:mem?mem.imageUrl:null,content:txt,imageUrl:feedImg,likes:0,comments:[],timestamp:firebase.firestore.FieldValue.serverTimestamp()})
            .then(()=>{document.getElementById('postContent').value='';clearImage();btn.disabled=false;btn.innerText="ì—…ë¡œë“œ!"; window.scrollTo(0,0);})
            .catch(()=>{alert("ì˜¤ë¥˜ ë°œìƒ!");btn.disabled=false;btn.innerText="ì—…ë¡œë“œ!";});
        }
        function loadFeed(){
            if(unsubFeed)unsubFeed(); document.getElementById('loading-spinner').style.display='block';
            unsubFeed=db.collection("family_posts").orderBy("timestamp","desc").limit(postLimit).onSnapshot(snap=>{
                document.getElementById('loading-spinner').style.display='none'; const con=document.getElementById('feed-container'); con.innerHTML="";
                snap.forEach(doc=>renderPost(doc.id,doc.data(),con)); document.getElementById('btnLoadMore').style.display=snap.size>=postLimit?'block':'none';
            });
        }
        function loadMorePosts(){postLimit+=5;loadFeed();}
        function renderPost(id,d,con){
            const pImg=d.authorImg?`<img src="${d.authorImg}" class="fp-img">`:`<div class="fp-img" style="display:flex;align-items:center;justify-content:center;"><i class="fa-solid fa-user"></i></div>`;
            const contentImg=d.imageUrl?`<div class="feed-photo"><img src="${d.imageUrl}"></div>`:'';
            let cmts=""; if(d.comments)d.comments.forEach(c=>{ cmts+=`<div class="cmt-bubble"><b>${c.author}</b>: ${c.text}</div>`; });
            let cmtOpts=""; familyData.forEach(m=>{ cmtOpts+=`<option value="${m.role}" ${m.role===selectedRole?'selected':''}>${m.role}</option>`; });
            con.innerHTML+=`
            <div class="retro-card">
                <div class="feed-head"><div class="feed-profile">${pImg}<div class="fp-info"><h4>${d.author}</h4><span>${d.timestamp?new Date(d.timestamp.toDate()).toLocaleDateString():'ë°©ê¸ˆ'}</span></div></div><button onclick="delPost('${id}')" style="border:none;background:none;color:#999;"><i class="fa-solid fa-trash"></i></button></div>
                <div class="feed-text">${d.content}</div>${contentImg}
                <div class="feed-actions"><button class="act-btn ${d.likes>0?'liked':''}" onclick="likePost('${id}',${d.likes})"><i class="fa-solid fa-heart"></i> ${d.likes||0}</button><button class="act-btn" onclick="toggleCmt('${id}')"><i class="fa-solid fa-comment"></i> ëŒ“ê¸€</button></div>
                <div id="cmt-${id}" class="cmt-area"><div style="margin-bottom:10px;max-height:150px;overflow-y:auto;">${cmts}</div><div class="cmt-inp-box"><select id="cAuth-${id}" style="border:1px solid #444;border-radius:5px;">${cmtOpts}</select><input type="text" id="cInp-${id}" style="flex:1;border:1px solid #444;border-radius:5px;padding:5px;" placeholder="ëŒ“ê¸€..." onkeydown="if(event.key==='Enter')addCmt('${id}')"><button class="cmt-send" onclick="addCmt('${id}')"><i class="fa-solid fa-arrow-up"></i></button></div></div>
            </div>`;
        }
        function likePost(id,n){db.collection("family_posts").doc(id).update({likes:(n||0)+1});}
        function delPost(id){if(confirm("ì‚­ì œí• ê¹Œìš”?"))db.collection("family_posts").doc(id).delete();}
        function toggleCmt(id){document.getElementById(`cmt-${id}`).classList.toggle('show');}
        function addCmt(id){const r=document.getElementById(`cAuth-${id}`).value,t=document.getElementById(`cInp-${id}`).value; if(!t)return; const m=familyData.find(x=>x.role===r); db.collection("family_posts").doc(id).update({comments:firebase.firestore.FieldValue.arrayUnion({author:r,text:t,authorImg:m?m.imageUrl:null})});}

        let curDate=new Date(), events=[], curModDate=null;
        function loadCal(){
            const y=curDate.getFullYear(), m=curDate.getMonth(); document.getElementById('month-display').innerText=`${m+1}ì›”`;
            const f=new Date(y,m,1), l=new Date(y,m+1,0), con=document.getElementById('calendar-days'); con.innerHTML="";
            for(let i=0;i<f.getDay();i++)con.innerHTML+=`<div></div>`;
            for(let i=1;i<=l.getDate();i++){
                const dStr=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`, evs=events.filter(e=>e.date===dStr), hasEv=evs.length?`<div class="ev-badge"></div>`:'', tdy=new Date().toDateString()===new Date(y,m,i).toDateString()?'today':'';
                con.innerHTML+=`<div class="date-box ${tdy}" onclick="openEvModal('${dStr}')"><span class="date-num">${i}</span>${hasEv}</div>`;
            }
        }
        function moveMonth(n){curDate.setMonth(curDate.getMonth()+n);loadCal();}
        function openEvModal(d){curModDate=d; document.getElementById('modalDateDisplay').innerText=d; renderEvList(); document.getElementById('eventModal').style.display='flex'; }
        function renderEvList(){const el=document.getElementById('eventList'); const evs=events.filter(e=>e.date===curModDate); el.innerHTML=evs.length?"": "<li style='text-align:center;color:#999;'>ì¼ì • ì—†ìŒ</li>"; evs.forEach(e=>el.innerHTML+=`<li style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #ccc;"><span>${e.title}</span><i class="fa-solid fa-times" style="color:red;cursor:pointer;" onclick="delEv('${e.id}')"></i></li>`); }
        function saveEvent(){const t=document.getElementById('eventTitle').value; if(curModDate&&t) db.collection("family_events").add({date:curModDate,title:t,timestamp:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{document.getElementById('eventTitle').value=''; closeModal('eventModal');});}
        function delEv(id){if(confirm("ì‚­ì œ?"))db.collection("family_events").doc(id).delete();}
        db.collection("family_events").orderBy("timestamp").onSnapshot(s=>{events=[];s.forEach(d=>events.push({id:d.id,...d.data()}));loadCal();if(curModDate)renderEvList();});

        let famImg=null; function closeModal(id){ document.getElementById(id).style.display='none'; famImg=null; curModDate=null; }
        function openFamModal(){ document.getElementById('familyModal').style.display='flex'; }
        function handleFamImgSelect(e){if(e.target.files[0])compressImage(e.target.files[0],500,d=>{famImg=d;document.getElementById('famImgPreview').innerHTML=`<img src="${d}" style="width:100%;height:100%;object-fit:cover;">`;});}
        function saveFam(){ const r=document.getElementById('famRole').value, n=document.getElementById('famName').value, d=document.getElementById('famDesc').value; if(!r)return alert("ì—­í•  ì…ë ¥!"); const btn=document.getElementById('btnSaveFam'); btn.disabled=true; btn.innerText="ì €ì¥ ì¤‘..."; db.collection("family_members").add({role:r,name:n,desc:d,imageUrl:famImg,timestamp:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{closeModal('familyModal');btn.disabled=false;btn.innerText="ì¶”ê°€";}).catch(()=>{alert("ì˜¤ë¥˜!");btn.disabled=false;btn.innerText="ì¶”ê°€";}); }
        function delFamily(id){if(confirm("ì‚­ì œ?"))db.collection("family_members").doc(id).delete();}
        function handleEnter(e){if(e.key==='Enter'&&!e.isComposing)saveEvent();}
        window.changeTab = function(id, el) { document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); if(el) el.classList.add('active'); window.scrollTo(0,0); }
        loadFeed(); loadCal(); loadFamily();
    </script>
</body>
</html>
