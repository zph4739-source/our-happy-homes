<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Yummy Family Log</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=DM+Serif+Display&family=Noto+Sans+KR:wght@400;700&family=Nanum+Gothic+Coding&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root{--bg-cream:#FFFDF5;--text-choco:#4A2c2A;--accent-red:#D94844;--accent-pink:#FFD1D1;--accent-yellow:#FFD56B;--border-thick:2px solid #4A2c2A;--shadow-hard:4px 4px 0px #4A2c2A;--radius-L:20px;}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
        body{font-family:'Noto Sans KR',sans-serif;background-color:var(--bg-cream);color:var(--text-choco);min-height:100vh;overflow-x:hidden;padding-bottom:120px;}
        .app-layout{max-width:600px;margin:0 auto;padding-bottom:120px;position:relative;}
        .header{padding:20px 24px;text-align:center;position:sticky;top:0;z-index:50;background:rgba(255,253,245,0.95);backdrop-filter:blur(5px);border-bottom:var(--border-thick);}
        .brand-title{font-family:'DM Serif Display',serif;font-size:32px;color:var(--accent-red);text-shadow:2px 2px 0px var(--text-choco);letter-spacing:1px;margin-bottom:5px;}
        .brand-sub{font-family:'Jua',sans-serif;font-size:16px;color:var(--text-choco);}
        .my-badge{position:absolute;right:20px;top:25px;width:40px;height:40px;background:white;border:var(--border-thick);border-radius:50%;display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow:var(--shadow-hard);}
        .my-badge img{width:100%;height:100%;object-fit:cover;}
        .retro-card{background:white;border:var(--border-thick);border-radius:var(--radius-L);padding:24px;margin:24px 20px;box-shadow:var(--shadow-hard);position:relative;transition:0.2s;}
        .btn-pop{background:var(--accent-red);color:white;border:var(--border-thick);padding:14px 24px;border-radius:50px;font-family:'Jua',sans-serif;font-size:18px;cursor:pointer;box-shadow:var(--shadow-hard);transition:0.2s;display:flex;align-items:center;justify-content:center;gap:8px;width:100%;}
        .btn-pop:active{transform:translate(2px,2px);box-shadow:none;background:#C0392B;}
        .btn-pop.yellow{background:var(--accent-yellow);color:var(--text-choco);}
        .btn-pop.gray{background:#E0E0E0;color:#555;border-color:#999;box-shadow:2px 2px 0px #999;}
        .input-retro{width:100%;background:#FFF;border:var(--border-thick);border-radius:16px;padding:14px;font-size:16px;color:var(--text-choco);outline:none;box-shadow:inset 2px 2px 5px rgba(74,44,42,0.1);}
        .tab-section{display:none;}.tab-section.active{display:block;animation:popIn 0.3s;}
        @keyframes popIn{from{opacity:0;transform:scale(0.95);}to{opacity:1;transform:scale(1);}}
        .nav-dock{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:92%;max-width:440px;height:70px;background:var(--text-choco);border-radius:40px;box-shadow:0 10px 20px rgba(74,44,42,0.3);display:flex;justify-content:space-around;align-items:center;padding:0 15px;z-index:100;border:2px solid white;}
        .nav-item{color:rgba(255,255,255,0.5);font-size:22px;cursor:pointer;transition:0.3s;}
        .nav-item.active{color:var(--accent-yellow);transform:translateY(-5px);}
        .receipt-paper{background:white;width:90%;margin:20px auto;padding:20px;border-top:1px solid #ddd;box-shadow:0 5px 15px rgba(0,0,0,0.1);position:relative;font-family:'Nanum Gothic Coding',monospace;}
        .receipt-paper::before{content:"";position:absolute;top:-10px;left:0;width:100%;height:10px;background:radial-gradient(circle at 10px 15px,transparent 10px,white 11px);background-size:20px 20px;}
        .receipt-paper::after{content:"";position:absolute;bottom:-10px;left:0;width:100%;height:10px;background:radial-gradient(circle at 10px -5px,transparent 10px,white 11px);background-size:20px 20px;}
        .receipt-title{text-align:center;font-size:20px;border-bottom:2px dashed #444;padding-bottom:10px;margin-bottom:15px;font-weight:bold;}
        .shop-input-area{display:flex;gap:10px;margin-bottom:15px;}
        .shop-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #ddd;font-size:16px;}
        .shop-check{width:20px;height:20px;border:2px solid var(--text-choco);border-radius:4px;margin-right:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
        .shop-check.on{background:var(--accent-red);}
        .shop-del{color:#aaa;cursor:pointer;padding:5px;}
        .chatbot-btn{position:fixed;bottom:100px;right:20px;width:60px;height:60px;background:var(--accent-red);border:var(--border-thick);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:30px;color:white;box-shadow:var(--shadow-hard);cursor:pointer;z-index:999;transition:0.2s;}
        .chatbot-btn:active{transform:translate(2px,2px);box-shadow:none;}
        .chat-window{position:fixed;bottom:170px;right:20px;width:320px;height:480px;background:white;border:var(--border-thick);border-radius:20px;display:none;flex-direction:column;z-index:999;box-shadow:10px 10px 0px rgba(0,0,0,0.2);overflow:hidden;}
        .chat-head{background:var(--accent-yellow);padding:15px;border-bottom:var(--border-thick);font-family:'Jua';font-size:18px;display:flex;justify-content:space-between;align-items:center;}
        .chat-body{flex:1;padding:15px;overflow-y:auto;background:#fffdf5;font-size:14px;}
        .chat-msg{margin-bottom:10px;max-width:85%;padding:10px 14px;border-radius:12px;line-height:1.4;border:1px solid rgba(0,0,0,0.1);word-break:keep-all;}
        .msg-bot{background:white;border-radius:4px 12px 12px 12px;}
        .msg-user{background:var(--accent-pink);margin-left:auto;border-radius:12px 12px 4px 12px;}
        .chat-input-area{padding:10px;border-top:var(--border-thick);display:flex;gap:5px;background:white;}
        .chat-inp{flex:1;border:1px solid #444;border-radius:20px;padding:10px;outline:none;}
        .typing-indicator span{display:inline-block;width:6px;height:6px;background:#aaa;border-radius:50%;margin:0 2px;animation:typing 1s infinite;}
        .typing-indicator span:nth-child(2){animation-delay:0.2s;}.typing-indicator span:nth-child(3){animation-delay:0.4s;}
        @keyframes typing{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}
        .writer-scroll{display:flex;gap:12px;margin-bottom:20px;overflow-x:auto;padding:5px;scrollbar-width:none;}
        .writer-scroll::-webkit-scrollbar{display:none;}
        .radio-hidden{display:none;}
        .writer-tag{padding:8px 16px;background:white;border:var(--border-thick);border-radius:30px;font-family:'Jua',sans-serif;font-size:16px;color:var(--text-choco);cursor:pointer;white-space:nowrap;display:flex;align-items:center;gap:6px;box-shadow:2px 2px 0px rgba(74,44,42,0.2);}
        .radio-hidden:checked+.writer-tag{background:var(--accent-red);color:white;box-shadow:var(--shadow-hard);transform:translateY(-2px);}
        .img-preview{width:100%;border:var(--border-thick);border-radius:16px;margin-top:15px;overflow:hidden;position:relative;display:none;background:white;}
        .feed-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;border-bottom:2px dashed #E5D0C0;padding-bottom:10px;}
        .feed-profile{display:flex;align-items:center;gap:10px;}
        .fp-img{width:45px;height:45px;border-radius:50%;border:var(--border-thick);background:white;display:flex;align-items:center;justify-content:center;overflow:hidden;}
        .feed-photo{padding:10px;background:white;border:var(--border-thick);transform:rotate(-1deg);margin-bottom:15px;box-shadow:3px 3px 0px rgba(0,0,0,0.1);}
        .feed-photo img{width:100%;border:1px solid #eee;display:block;}
        .act-btn{padding:8px 12px;background:var(--bg-cream);border:2px solid #E5D0C0;border-radius:12px;font-weight:700;font-size:13px;color:var(--text-choco);display:flex;gap:6px;align-items:center;cursor:pointer;transition:0.2s;}
        .act-btn.liked{color:var(--accent-red);border-color:var(--accent-red);}
        .heart-pop{animation:heartPop 0.4s ease;}
        @keyframes heartPop{0%{transform:scale(1);}50%{transform:scale(1.4);}100%{transform:scale(1);}}
        .like-profiles{display:flex;align-items:center;gap:6px;margin:10px 0 0 0;padding:0 0 16px 0;flex-wrap:wrap;}
        .like-profiles .like-avatar{width:24px;height:24px;border-radius:50%;border:2px solid var(--accent-red);overflow:hidden;display:flex;align-items:center;justify-content:center;background:white;flex-shrink:0;}
        .like-profiles .like-avatar img{width:100%;height:100%;object-fit:cover;display:block;}
        .like-profiles .like-text{font-size:12px;color:#888;margin-left:2px;}
        .feed-bottom-pad{padding-bottom:16px;}
        .cmt-area{background:#FAFAFA;border-top:1px solid #E5D0C0;border-radius:0 0 16px 16px;padding:0;margin-top:15px;display:none;overflow:hidden;}
        .cmt-area.show{display:block;}
        .cmt-list{max-height:300px;overflow-y:auto;padding:12px 16px;}
        .cmt-list::-webkit-scrollbar{width:4px;}.cmt-list::-webkit-scrollbar-thumb{background:#ddd;border-radius:4px;}
        .cmt-single{display:flex;align-items:flex-start;gap:10px;padding:10px 0;position:relative;}
        .cmt-single:not(:last-child){border-bottom:1px solid #f0e8df;}
        .cmt-avatar{width:32px;height:32px;min-width:32px;border-radius:50%;border:1.5px solid #E5D0C0;overflow:hidden;display:flex;align-items:center;justify-content:center;background:white;}
        .cmt-avatar img{width:100%;height:100%;object-fit:cover;}
        .cmt-body{flex:1;}
        .cmt-author{font-weight:700;font-size:13px;color:var(--text-choco);margin-right:6px;}
        .cmt-text{font-size:13px;color:#333;line-height:1.5;}
        .cmt-del{position:absolute;right:0;top:12px;border:none;background:none;color:#ccc;cursor:pointer;font-size:12px;padding:4px;}
        .cmt-del:hover{color:var(--accent-red);}
        .cmt-input-bar{display:flex;align-items:center;gap:8px;padding:10px 16px;border-top:1px solid #eee;background:white;}
        .cmt-input-bar .cmt-my-avatar{width:28px;height:28px;min-width:28px;border-radius:50%;border:1.5px solid #E5D0C0;overflow:hidden;display:flex;align-items:center;justify-content:center;background:white;}
        .cmt-input-bar .cmt-my-avatar img{width:100%;height:100%;object-fit:cover;}
        .cmt-input-bar input{flex:1;border:none;outline:none;font-size:14px;padding:8px 0;background:transparent;color:var(--text-choco);}
        .cmt-input-bar input::placeholder{color:#bbb;}
        .cmt-send-btn{border:none;background:none;color:var(--accent-red);font-weight:700;font-size:14px;cursor:pointer;font-family:'Jua',sans-serif;padding:4px 8px;}
        .cal-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
        .cal-title{font-family:'DM Serif Display',serif;font-size:32px;color:var(--accent-red);}
        .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;text-align:center;}
        .date-box{min-height:70px;background:white;border:2px solid #E5D0C0;border-radius:12px;display:flex;flex-direction:column;align-items:center;padding:5px;cursor:pointer;}
        .date-box.today{background:var(--accent-yellow);border:var(--border-thick);}
        .ev-badge{width:8px;height:8px;background:var(--accent-red);border-radius:50%;border:1px solid var(--text-choco);margin-top:4px;}
        .family-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;padding:0 10px;}
        .mem-card{background:white;border:var(--border-thick);border-radius:24px;padding:20px 10px;text-align:center;box-shadow:var(--shadow-hard);position:relative;}
        .mem-pic{width:80px;height:80px;border-radius:50%;border:var(--border-thick);margin-bottom:10px;background:var(--bg-cream);display:flex;align-items:center;justify-content:center;margin-left:auto;margin-right:auto;overflow:hidden;}
        .add-card{border:2px dashed var(--text-choco);background:rgba(255,255,255,0.5);box-shadow:none;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;min-height:200px;gap:10px;}
        .modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(74,44,42,0.6);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(3px);}
        .modal-card{background:var(--bg-cream);width:85%;max-width:350px;padding:25px;border:var(--border-thick);border-radius:var(--radius-L);box-shadow:8px 8px 0px rgba(0,0,0,0.2);}
        .modal-tit{font-family:'Jua',sans-serif;font-size:24px;margin-bottom:20px;color:var(--text-choco);display:flex;align-items:center;gap:8px;}
        .modal-btns{display:flex;flex-direction:column;gap:12px;margin-top:25px;}
        .cache-badge{display:inline-block;font-size:10px;background:var(--accent-yellow);color:var(--text-choco);padding:2px 6px;border-radius:8px;margin-left:4px;font-weight:bold;}
        .fallback-badge{display:inline-block;font-size:10px;background:#E0E0E0;color:#666;padding:2px 6px;border-radius:8px;margin-left:4px;font-weight:bold;}
        /* â•â•â• ê²Œì„ ì„¹ì…˜ â•â•â• */
        .game-card{background:linear-gradient(135deg,#1a1a2e,#16213e);border:var(--border-thick);border-radius:var(--radius-L);padding:25px;margin:20px;box-shadow:var(--shadow-hard);color:white;cursor:pointer;transition:0.3s;position:relative;overflow:hidden;}
        .game-card:active{transform:translate(2px,2px);box-shadow:none;}
        .game-card .game-icon{font-size:48px;margin-bottom:10px;}
        .game-card h3{font-family:'Jua';font-size:22px;color:#f5c518;margin-bottom:5px;}
        .game-card p{font-size:13px;color:#aaa;line-height:1.5;}
        .game-card .badge{position:absolute;top:15px;right:15px;background:#e94560;color:white;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;}
        .game-section-title{text-align:center;font-family:'Jua';font-size:28px;margin:20px 0 5px;color:var(--text-choco);}
        .game-section-sub{text-align:center;font-size:13px;color:#999;margin-bottom:15px;}
        /* ìƒíƒœ í‘œì‹œ */
        .ai-status{font-size:11px;color:#999;text-align:center;padding:4px;margin-top:-5px;}
        @media(min-width:768px){.app-layout{padding:40px;}.nav-dock{bottom:auto;top:50%;left:40px;transform:translateY(-50%);width:70px;height:380px;flex-direction:column;padding:30px 0;}.family-grid{grid-template-columns:repeat(3,1fr);}.chatbot-btn{right:50px;bottom:50px;}.chat-window{right:50px;bottom:120px;}}
    </style>
</head>
<body>
<div class="app-layout">
    <header class="header">
        <div class="brand-title">Yummy Family</div>
        <div class="brand-sub">ìš°ë¦¬ ê°€ì¡±ì˜ ë§›ìˆëŠ” ì¼ìƒ ğŸ’</div>
        <div class="my-badge" id="headerProfile"><i class="fa-solid fa-user"></i></div>
    </header>
    <main>
        <div id="feed" class="tab-section active">
            <div class="retro-card">
                <div style="font-family:'Jua';font-size:20px;margin-bottom:15px;"><i class="fa-solid fa-pen-fancy" style="color:var(--accent-red);"></i> ì˜¤ëŠ˜ì˜ ì¶”ì–µ ê¸°ë¡</div>
                <div class="writer-scroll" id="writerChips"><div style="font-size:14px;color:#aaa;padding:10px;">ë¡œë”© ì¤‘...</div></div>
                <textarea id="postContent" class="input-retro" style="min-height:100px;resize:none;" placeholder="ì˜¤ëŠ˜ ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆë‚˜ìš”? ğŸ°"></textarea>
                <div id="imagePreviewBox" class="img-preview"><img id="imagePreview" src=""><button onclick="clearImage()" style="position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.5);color:white;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;"><i class="fa-solid fa-times"></i></button></div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:20px;">
                    <label for="imageInput" style="font-size:24px;color:var(--text-choco);cursor:pointer;"><i class="fa-regular fa-image"></i></label>
                    <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
                    <button id="btnPost" class="btn-pop" style="width:auto;padding:10px 30px;" onclick="addPost()">ì—…ë¡œë“œ!</button>
                </div>
            </div>
            <div id="feed-container"></div>
        </div>
        <div id="calendar" class="tab-section">
            <div class="retro-card">
                <div class="cal-top"><button onclick="moveMonth(-1)" style="border:none;background:none;font-size:20px;cursor:pointer;color:var(--text-choco);"><i class="fa-solid fa-chevron-left"></i></button><div id="month-display" class="cal-title"></div><button onclick="moveMonth(1)" style="border:none;background:none;font-size:20px;cursor:pointer;color:var(--text-choco);"><i class="fa-solid fa-chevron-right"></i></button></div>
                <div class="cal-grid" style="margin-bottom:10px;"><div style="color:var(--accent-red)">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div></div>
                <div id="calendar-days" class="cal-grid"></div>
            </div>
        </div>
        <div id="shopping" class="tab-section">
            <div class="receipt-paper">
                <div class="receipt-title">ğŸ›’ ì¥ë³´ê¸° ë¦¬ìŠ¤íŠ¸</div>
                <div class="shop-input-area"><input type="text" id="shopInput" class="input-retro" placeholder="ì‚´ ê²ƒ ì…ë ¥" onkeydown="if(event.key==='Enter')addShopItem()"><button class="btn-pop" style="width:auto;" onclick="addShopItem()">+</button></div>
                <div id="shopList"></div>
                <div style="text-align:center;margin-top:20px;font-size:12px;color:#aaa;">*** THANK YOU ***</div>
            </div>
        </div>
        <div id="games" class="tab-section">
            <div class="game-section-title">ğŸ® ê°€ì¡± ê²Œì„</div>
            <div class="game-section-sub">ê°€ì¡±ë“¤ê³¼ í•¨ê»˜ ì¦ê¸°ëŠ” ë³´ë“œê²Œì„!</div>
            <div class="game-card" onclick="window.open('burumable.html','_blank')">
                <div class="badge">ë©€í‹°í”Œë ˆì´</div>
                <div class="game-icon">ğŸ²</div>
                <h3>ë¶€ë£¨ë§ˆë¸”</h3>
                <p>ì„¸ê³„ ì—¬í–‰ ë³´ë“œê²Œì„! ë•…ì„ ì‚¬ê³  í˜¸í…”ì„ ì§“ì.<br>2~6ëª… / í•œ ê¸°ê¸° or ì˜¨ë¼ì¸</p>
            </div>
            <div class="game-card" style="opacity:0.5;cursor:default;" onclick="alert('ê³§ ì¶”ê°€ë©ë‹ˆë‹¤!')">
                <div class="badge" style="background:#666;">ì¤€ë¹„ì¤‘</div>
                <div class="game-icon">ğŸƒ</div>
                <h3>ì¹´ë“œ ê²Œì„</h3>
                <p>ê³§ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤!</p>
            </div>
        </div>
        <div id="family" class="tab-section">
            <div style="text-align:center;margin-bottom:20px;font-family:'Jua';font-size:28px;">ìš°ë¦¬ ê°€ì¡± ë©¤ë²„ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
            <div id="family-container" class="family-grid"></div>
        </div>
    </main>
    <nav class="nav-dock">
        <div class="nav-item active" onclick="changeTab('feed',this)"><i class="fa-solid fa-house"></i></div>
        <div class="nav-item" onclick="changeTab('calendar',this)"><i class="fa-solid fa-calendar-days"></i></div>
        <div class="nav-item" onclick="changeTab('shopping',this)"><i class="fa-solid fa-cart-shopping"></i></div>
        <div class="nav-item" onclick="changeTab('games',this)"><i class="fa-solid fa-gamepad"></i></div>
        <div class="nav-item" onclick="changeTab('family',this)"><i class="fa-solid fa-users"></i></div>
    </nav>
</div>
<div class="chatbot-btn" onclick="toggleChat()"><i class="fa-solid fa-robot"></i></div>
<div class="chat-window" id="chatWindow">
    <div class="chat-head">ğŸ’ AI ì²´ë¦¬ <i class="fa-solid fa-times" style="cursor:pointer;" onclick="toggleChat()"></i></div>
    <div class="chat-body" id="chatBody"><div class="chat-msg msg-bot">ì•ˆë…•í•˜ì„¸ìš”! ê°€ì¡± AI <b>ì²´ë¦¬</b>ì…ë‹ˆë‹¤! ğŸ’<br>ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!</div></div>
    <div class="chat-input-area"><input type="text" id="chatInput" class="chat-inp" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeydown="if(event.key==='Enter')sendChat()"><button class="btn-pop" style="width:auto;padding:5px 15px;font-size:14px;" onclick="sendChat()">ì „ì†¡</button></div>
</div>
<div id="eventModal" class="modal-bg"><div class="modal-card"><div class="modal-tit">ğŸ“… ì¼ì • ê¸°ë¡</div><p id="modalDateDisplay" style="text-align:center;font-weight:bold;margin-bottom:20px;"></p><ul id="eventList" style="list-style:none;margin-bottom:20px;padding:0;"></ul><input type="text" id="eventTitle" class="input-retro" placeholder="ì¼ì • ë‚´ìš©" onkeydown="if(event.key==='Enter')saveEvent()"><div class="modal-btns"><button class="btn-pop gray" onclick="closeModal('eventModal')">ë‹«ê¸°</button><button class="btn-pop" onclick="saveEvent()">ì €ì¥</button></div></div></div>
<div id="familyModal" class="modal-bg"><div class="modal-card"><div class="modal-tit">ğŸ’ ê°€ì¡± ì¶”ê°€</div><div style="text-align:center;margin-bottom:20px;"><label for="famImgInput" style="display:inline-block;cursor:pointer;"><div id="famImgPreview" style="width:100px;height:100px;border-radius:50%;background:var(--bg-cream);border:var(--border-thick);display:flex;align-items:center;justify-content:center;overflow:hidden;"><i class="fa-solid fa-camera" style="font-size:30px;color:var(--text-choco);"></i></div></label><input type="file" id="famImgInput" accept="image/*" style="display:none;" onchange="handleFamImgSelect(event)"></div><input type="text" id="famRole" class="input-retro" placeholder="ì—­í•  (ì˜ˆ: ì•„ë¹ )" style="margin-bottom:10px;"><input type="text" id="famName" class="input-retro" placeholder="ì´ë¦„ (ì„ íƒ)" style="margin-bottom:10px;"><input type="text" id="famDesc" class="input-retro" placeholder="í•œ ë§ˆë”” ì†Œê°œ"><div class="modal-btns"><button class="btn-pop gray" onclick="closeModal('familyModal')">ì·¨ì†Œ</button><button id="btnSaveFam" class="btn-pop" onclick="saveFam()">ì¶”ê°€</button></div></div></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ”‘ API í‚¤ 5ê°œ + ìŠ¤ë§ˆíŠ¸ ë¡œí…Œì´ì…˜
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const KEYS=[
    "AIzaSyAuzBdkXCbdjPoiCFmW0dUL9UFL09YTa1o",
    "AIzaSyCk7LCh4S5Nm7zonT51CCo2N9ZJR89njWc",
    "AIzaSyAk0pxk3wAoDKUJ47gNXMGpnBJKoQVLG-c",
    "AIzaSyCV8ofHR6abxlHPvSCwVNzjHB_4vFlwljA",
    "AIzaSyBGVXpnb6jnUSbAQHTh9YixzVHhSkCJseI"
];
let _ki=0;
// ì‹¤íŒ¨í•œ í‚¤ ì¿¨ë‹¤ìš´ (í‚¤ë³„ ë§ˆì§€ë§‰ ì‹¤íŒ¨ ì‹œê°)
const keyCooldown={};
const COOLDOWN_MS=60000; // ì‹¤íŒ¨ í›„ 1ë¶„ê°„ í•´ë‹¹ í‚¤ ê±´ë„ˆëœ€

function getAvailableKey(){
    const now=Date.now();
    for(let i=0;i<KEYS.length;i++){
        const idx=(_ki+i)%KEYS.length;
        const lastFail=keyCooldown[idx]||0;
        if(now-lastFail>COOLDOWN_MS){
            _ki=(idx+1)%KEYS.length;
            return{key:KEYS[idx],idx};
        }
    }
    // ëª¨ë“  í‚¤ ì¿¨ë‹¤ìš´ ì¤‘ì´ë©´ ê°€ì¥ ì˜¤ë˜ëœ ê²ƒ ì‚¬ìš©
    _ki=(_ki+1)%KEYS.length;
    return{key:KEYS[_ki],idx:_ki};
}

function markKeyFailed(idx){keyCooldown[idx]=Date.now();}
function markKeySuccess(idx){delete keyCooldown[idx];}

/* â•â•â• â˜… ìˆ˜ì •ëœ ëª¨ë¸ ëª©ë¡ â•â•â•
   gemini-2.5-flash â†’ ì¡´ì¬í•˜ì§€ ì•Šì•„ì„œ 404 ë°œìƒí–ˆìŒ!
   ì•ˆì •ì ìœ¼ë¡œ ì¡´ì¬í•˜ëŠ” ëª¨ë¸ë§Œ ì‚¬ìš© */
const MODELS=["gemini-1.5-flash","gemini-1.5-flash-8b","gemini-pro"];

/* â•â•â• Firebase â•â•â• */
const firebaseConfig={apiKey:"AIzaSyCokmBJyH6xGaB42u_ScP6k7ghEVxTZSio",authDomain:"our-family-home.firebaseapp.com",projectId:"our-family-home",storageBucket:"our-family-home.firebasestorage.app",messagingSenderId:"446464856858",appId:"1:446464856858:web:344f2c83aeda0ea9ae52a3"};
firebase.initializeApp(firebaseConfig);const db=firebase.firestore();

function compressImage(f,mW,cb){const r=new FileReader();r.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');let w=i.width,h=i.height;if(w>mW){h*=mW/w;w=mW;}c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);cb(c.toDataURL('image/jpeg',0.5));};i.src=e.target.result;};r.readAsDataURL(f);}

/* â•â•â• ğŸ§  Fallback AI (ê°•í™”) â•â•â• */
const recipes={"ë–¡ë³¶ì´":["ë–¡","ì–´ë¬µ","ëŒ€íŒŒ","ê³ ì¶”ì¥","ì„¤íƒ•","ë¬¼"],"ê¹€ì¹˜ì°Œê°œ":["ê¹€ì¹˜","ë¼ì§€ê³ ê¸°","ë‘ë¶€","ëŒ€íŒŒ","ê³ ì¶§ê°€ë£¨"],"ëœì¥ì°Œê°œ":["ëœì¥","í˜¸ë°•","ë‘ë¶€","ì–‘íŒŒ","ì²­ì–‘ê³ ì¶”"],"ë¯¸ì—­êµ­":["ë¯¸ì—­","ì†Œê³ ê¸°","ì°¸ê¸°ë¦„","êµ­ê°„ì¥","ë‹¤ì§„ë§ˆëŠ˜"],"ì¹´ë ˆ":["ì¹´ë ˆê°€ë£¨","ê°ì","ë‹¹ê·¼","ì–‘íŒŒ","ì‹ìš©ìœ "],"ë¼ë©´":["ë¼ë©´","ê³„ë€","íŒŒ","ë–¡(ì„ íƒ)"],"ë¹„ë¹”ë°¥":["ì½©ë‚˜ë¬¼","ì‹œê¸ˆì¹˜","ê³ ì¶”ì¥","ê³„ë€","ì°¸ê¸°ë¦„","ë‹¹ê·¼"],"ë¶ˆê³ ê¸°":["ì†Œê³ ê¸°","ì–‘íŒŒ","ë°°","ê°„ì¥","ì„¤íƒ•","ì°¸ê¸°ë¦„","ë§ˆëŠ˜"],"ì¡ì±„":["ë‹¹ë©´","ì‹œê¸ˆì¹˜","ë‹¹ê·¼","ì–‘íŒŒ","ë²„ì„¯","ê°„ì¥","ì°¸ê¸°ë¦„"],"ê³„ë€ë§ì´":["ê³„ë€","íŒŒ","ë‹¹ê·¼","ì†Œê¸ˆ","ì‹ìš©ìœ "],"ê¹€ë°¥":["ë°¥","ê¹€","ë‹¨ë¬´ì§€","ë‹¹ê·¼","ì‹œê¸ˆì¹˜","ê³„ë€","í–„"],"íŒŒìŠ¤íƒ€":["íŒŒìŠ¤íƒ€ë©´","ì˜¬ë¦¬ë¸Œì˜¤ì¼","ë§ˆëŠ˜","ì–‘íŒŒ","í† ë§ˆí† ì†ŒìŠ¤"],"ë³¶ìŒë°¥":["ë°¥","ê³„ë€","íŒŒ","ë‹¹ê·¼","ê°„ì¥","ì°¸ê¸°ë¦„"],"ë‹­ë³¶ìŒíƒ•":["ë‹­","ê°ì","ë‹¹ê·¼","ì–‘íŒŒ","ê³ ì¶”ì¥","ê°„ì¥","ê³ ì¶§ê°€ë£¨"],"ìƒŒë“œìœ„ì¹˜":["ì‹ë¹µ","ì–‘ìƒì¶”","í† ë§ˆí† ","ì¹˜ì¦ˆ","í–„","ë§ˆìš”ë„¤ì¦ˆ"],"ì œìœ¡ë³¶ìŒ":["ë¼ì§€ê³ ê¸°","ì–‘íŒŒ","íŒŒ","ê³ ì¶”ì¥","ê³ ì¶§ê°€ë£¨","ê°„ì¥"],"ì˜¤ë¯€ë¼ì´ìŠ¤":["ë°¥","ê³„ë€","ì–‘íŒŒ","ë‹¹ê·¼","ì¼€ì²©","ë²„í„°"],"ì½©ë‚˜ë¬¼êµ­":["ì½©ë‚˜ë¬¼","íŒŒ","ë§ˆëŠ˜","êµ­ê°„ì¥","ì†Œê¸ˆ"],"ìˆœë‘ë¶€ì°Œê°œ":["ìˆœë‘ë¶€","ê³ ì¶§ê°€ë£¨","ê³„ë€","íŒŒ","ìƒˆìš°ì “"],"ê°ìì „":["ê°ì","ë¶€ì¹¨ê°€ë£¨","ì‹ìš©ìœ ","ì†Œê¸ˆ"]};
const mealTips={ì•„ì¹¨:["í† ìŠ¤íŠ¸ & ê³„ë€í”„ë¼ì´ â˜€ï¸","ì£½ í•œ ê·¸ë¦‡! ğŸ¥£","ì‹œë¦¬ì–¼! ğŸ¥›","ìƒŒë“œìœ„ì¹˜ ğŸ¥ª","ë°”ë‚˜ë‚˜ ìŠ¤ë¬´ë””! ğŸŒ"],ì ì‹¬:["ë¹„ë¹”ë°¥! ğŸš","ì¹¼êµ­ìˆ˜! ğŸœ","ê¹€ì¹˜ë³¶ìŒë°¥! ğŸ³","ëˆê¹ŒìŠ¤! ğŸ·","ëƒ‰ë©´! ğŸ§Š"],ì €ë…:["ì‚¼ê²¹ì‚´! ğŸ¥©","ì°Œê°œ! ğŸ²","ì¹˜í‚¨! ğŸ—","íŒŒìŠ¤íƒ€! ğŸ","ì´ˆë°¥! ğŸ£"],ì•¼ì‹:["ë¼ë©´! ğŸœ","ì¹˜í‚¨! ğŸ—","ë–¡ë³¶ì´! ğŸŒ¶ï¸","í”¼ì! ğŸ•","ì¡±ë°œ! ğŸ·"],ê°„ì‹:["ê³¼ì¼! ğŸ","ë–¡! ğŸ¡","ì¿ í‚¤! ğŸª","ì•„ì´ìŠ¤í¬ë¦¼! ğŸ¦","ê³ êµ¬ë§ˆ! ğŸ "]};
const chat={hi:["ì•ˆë…•! ì˜¤ëŠ˜ë„ í™”ì´íŒ…! ğŸ’ª","ë°˜ê°€ì›Œ~ ğŸ’","ê¸°ë¶„ ì–´ë•Œ? ğŸ˜Š"],thx:["ë³„ë§ì”€ì„! ğŸ˜Š","ë„ì›€ ëë‹¤ë‹ˆ! ğŸ’","ì–¸ì œë“ ~ âœ¨"],mood:["ë‚˜ëŠ” í•­ìƒ ì¢‹ì§€! ğŸ’","ì—ë„ˆì§€ 100%! âš¡","ì—´ì‹¬íˆ ì¤‘~ ğŸ’ª"],bored:["ë³´ë“œê²Œì„! ğŸ²","ê°™ì´ ìš”ë¦¬! ğŸ‘¨â€ğŸ³","ì‚°ì±…! ğŸ“¸","ë„·í”Œë¦­ìŠ¤! ğŸ¬"],love:["ì‚¬ë‘í•´~ â¤ï¸","ê°€ì¡± í™”ì´íŒ…! ğŸ’•","ì‚¬ë‘ ë„˜ì³! ğŸ¥°"],gn:["ì˜ ì~ ğŸŒ™","ìˆ˜ê³ í–ˆì–´! â­","ì¢‹ì€ í•˜ë£¨! ğŸ’¤"],gm:["ì¢‹ì€ ì•„ì¹¨! â˜€ï¸","ì•„ì¹¨ ë­ ë¨¹ì„ê¹Œ? ğŸ³","êµ¿ëª¨ë‹~ ğŸŒ…"],tired:["ì¢€ ì‰¬ì–´~ ğŸ’†","ë”°ëœ»í•œ ì°¨? â˜•","ì¼ì° ì! ğŸ˜´"],hungry:["ë­ ë¨¹ê³  ì‹¶ì–´? ğŸ¤”","ê°„ì‹ë¶€í„°! ğŸª","ì¥ë³´ê¸°ì— ì¶”ê°€? ğŸ›’"]};
const facts=["ğŸ’ í† ë§ˆí† ëŠ” ê³¼ì¼!","ğŸ’ ê¿€ì€ ì ˆëŒ€ ì•ˆ ìƒí•´!","ğŸ’ ë°”ë‚˜ë‚˜ëŠ” ë² ë¦¬ë¥˜!","ğŸ’ ë‹¹ê·¼ì€ ì›ë˜ ë³´ë¼ìƒ‰!","ğŸ’ ì´ˆì½œë¦¿ì´ ì˜›ë‚ ì—” í™”í!","ğŸ’ ìˆ˜ë°•ì€ 92%ê°€ ë¬¼!","ğŸ’ ì‚¬ê³¼ëŠ” ì¥ë¯¸ê³¼!","ğŸ’ ë”¸ê¸° ê²‰ ì”¨ê°€ ì§„ì§œ ì—´ë§¤!"];
function pick(a){return a[Math.floor(Math.random()*a.length)];}
function fallbackAI(text){
    const t=text.toLowerCase().trim();let reply=null,action=null;
    for(const food in recipes){if(t.includes(food)){if(t.match(/ì¬ë£Œ|ì¥ë³´ê¸°|ì¶”ê°€|ë‹´ì•„|ë§Œë“¤|ì‚¬ì•¼/)){action={action:"add_shopping_multi",items:recipes[food]};reply=`ğŸ‘¨â€ğŸ³ <b>${food}</b> ì¬ë£Œ ì¥ë³´ê¸°ì— ë‹´ì•˜ì–´!\nğŸ›’ ${recipes[food].join(", ")}`;}else{reply=`<b>${food}</b> ì¬ë£Œ: ${recipes[food].join(", ")}\n\nì¥ë³´ê¸°ì— ë‹´ì„ê¹Œ? "${food} ì¬ë£Œ ì¶”ê°€"ë¼ê³  í•´ë´!`;}break;}}
    if(!reply&&!action&&t.match(/ì¥ë³´ê¸°|ë‹´ì•„|ì‚¬ì•¼/)){const item=t.replace(/ì¥ë³´ê¸°|ì¶”ê°€|í•´ì¤˜|ë‹´ì•„ì¤˜|ë‹´ì•„|ì—|ì‚¬ì•¼|ì¢€|í• |ë¦¬ìŠ¤íŠ¸/g,"").trim();if(item){action={action:"add_shopping",item};reply=`ğŸ›’ <b>${item}</b> ì¶”ê°€!`;}}
    if(!reply&&t.includes("ì¼ì •")){const td=new Date();let date=td.toISOString().split('T')[0];if(t.includes("ë‚´ì¼")){td.setDate(td.getDate()+1);date=td.toISOString().split('T')[0];}if(t.includes("ëª¨ë ˆ")){td.setDate(td.getDate()+2);date=td.toISOString().split('T')[0];}const title=t.replace(/ì¼ì •|ì¶”ê°€|í•´ì¤˜|ë‚´ì¼|ì˜¤ëŠ˜|ëª¨ë ˆ|ë“±ë¡|ì—/g,"").trim();if(title){action={action:"add_event",date,title};reply=`ğŸ“… <b>${date}</b>ì— <b>${title}</b> ë“±ë¡!`;}}
    if(!reply){const h=new Date().getHours();if(t.match(/ë­ ë¨¹|ë­ë¨¹|ë©”ë‰´|ì¶”ì²œ|ë°°ê³ /)){let m="ì ì‹¬";if(h<10)m="ì•„ì¹¨";else if(h<14)m="ì ì‹¬";else if(h<18)m="ê°„ì‹";else if(h<21)m="ì €ë…";else m="ì•¼ì‹";if(t.includes("ì•„ì¹¨"))m="ì•„ì¹¨";if(t.includes("ì ì‹¬"))m="ì ì‹¬";if(t.includes("ì €ë…"))m="ì €ë…";if(t.includes("ì•¼ì‹"))m="ì•¼ì‹";if(t.includes("ê°„ì‹"))m="ê°„ì‹";reply=`${pick(mealTips[m])}\n\në ˆì‹œí”¼ í•„ìš”í•˜ë©´ ìŒì‹ ì´ë¦„ ë§í•´ë´!`;}}
    if(!reply){if(t.match(/ì•ˆë…•|í•˜ì´|í—¬ë¡œ|hi|hello/))reply=pick(chat.hi);else if(t.match(/ê³ ë§ˆ|ê°ì‚¬|ã„±ã……|ë•¡í/))reply=pick(chat.thx);else if(t.match(/ì–´ë•Œ|ê¸°ë¶„|ì˜ ì§€ë‚´/))reply=pick(chat.mood);else if(t.match(/ì‹¬ì‹¬|ì§€ë£¨/))reply=pick(chat.bored);else if(t.match(/ì‚¬ë‘|ì¢‹ì•„/))reply=pick(chat.love);else if(t.match(/ì˜ ì|êµ¿ë‚˜ì‡/))reply=pick(chat.gn);else if(t.match(/ì¢‹ì€ ì•„ì¹¨|êµ¿ëª¨ë‹/))reply=pick(chat.gm);else if(t.match(/í”¼ê³¤|í˜ë“¤|ì§€ì³¤/))reply=pick(chat.tired);else if(t.match(/ë°°ê³ |hungry|ë°¥/))reply=pick(chat.hungry);else if(t.match(/ë„ì›€|ë„ì™€|ê¸°ëŠ¥/))reply="í•  ìˆ˜ ìˆëŠ” ê²ƒë“¤! ğŸ‘‡\n\nğŸ³ \"ë–¡ë³¶ì´ ì¬ë£Œ ì¶”ê°€\"\nğŸ“… \"ë‚´ì¼ ë³‘ì› ì¼ì • ì¶”ê°€\"\nğŸ›’ \"ìš°ìœ  ì¥ë³´ê¸° ì¶”ê°€\"\nğŸ½ï¸ \"ì €ë… ë­ ë¨¹ì§€?\"";}
    if(!reply)reply=pick(["ìŒ~ ì˜ ëª¨ë¥´ê² ì–´! ğŸ¤” 'ë„ì›€ë§' ì³ë´!",`ëŒ€ì‹ ! ${pick(facts)}`,`ê·¸ê±´ ì–´ë µë‹¤~ ğŸ˜… ìš”ë¦¬ë‚˜ ì¼ì • ë¬¼ì–´ë´!`,`ëª¨ë¥´ê² ì–´! ğŸ™ˆ ${pick(facts)}`]);
    return{text:reply,action};
}

/* â•â•â• ğŸ’¾ ìºì‹± â•â•â• */
function cacheKey(t){return t.toLowerCase().replace(/[^ê°€-í£a-z0-9]/g,'').substring(0,50);}
async function getCache(t){const k=cacheKey(t);if(!k)return null;try{const s=await db.collection("ai_cache").doc(k).get();if(s.exists){const d=s.data();if(Date.now()-(d.timestamp?.toMillis?.()||0)<86400000)return d.response;}}catch(e){}return null;}
async function setCache(t,r){const k=cacheKey(t);if(!k||k.length<3)return;try{await db.collection("ai_cache").doc(k).set({query:t,response:r,timestamp:firebase.firestore.FieldValue.serverTimestamp()});}catch(e){}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ¤– AI ì±„íŒ… - ê°•í™”ëœ ì—ëŸ¬ í•¸ë“¤ë§
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sendChat(){
    const input=document.getElementById('chatInput'),text=input.value.trim();
    if(!text)return;
    appendMsg(text,'user');input.value='';
    const lid=appendLoading();
    
    // 1) ìºì‹œ ì²´í¬
    try{
        const cached=await getCache(text);
        if(cached){document.getElementById(lid)?.remove();appendMsg(cached+' <span class="cache-badge">âš¡ìºì‹œ</span>','bot');handleActions(cached);return;}
    }catch(e){/* cache miss, continue */}
    
    const sys=`ë„ˆëŠ” 'ì²´ë¦¬'ë¼ëŠ” ê°€ì¡± AI ë¹„ì„œì•¼. ì¹œê·¼í•œ ë°˜ë§, ì´ëª¨ì§€ ì‚¬ìš©. [ê¸°ëŠ¥] 1.ì¼ì •:{"action":"add_event","date":"YYYY-MM-DD","title":"ë‚´ìš©"}(ì˜¤ëŠ˜:${new Date().toISOString().split('T')[0]}) 2.ì¥ë³´ê¸°:{"action":"add_shopping","item":"ë¬¼ê±´"} 3.ì—¬ëŸ¬ê°œ:{"action":"add_shopping_multi","items":["a","b"]} 4.ê·¸ì™¸:í…ìŠ¤íŠ¸. ì§§ê³  ê°„ê²°í•˜ê²Œ ë‹µí•´!`;
    
    let aiText="",ok=false,lastError="";
    
    // 2) ëª¨ë¸ Ã— í‚¤ ì¡°í•© ì‹œë„ (429ì‹œ 2ì´ˆ ëŒ€ê¸° í›„ ë‹¤ìŒ í‚¤)
    for(const model of MODELS){
        if(ok)break;
        for(let attempt=0;attempt<KEYS.length;attempt++){
            const{key,idx}=getAvailableKey();
            try{
                const controller=new AbortController();
                const timeout=setTimeout(()=>controller.abort(),10000);
                
                const r=await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`,
                    {method:'POST',headers:{'Content-Type':'application/json'},
                     signal:controller.signal,
                     body:JSON.stringify({contents:[{role:"user",parts:[{text:sys+"\nUser: "+text}]}]})}
                );
                clearTimeout(timeout);
                
                if(r.status===429){
                    markKeyFailed(idx);
                    lastError="429";
                    await new Promise(r=>setTimeout(r,3000)); // 3ì´ˆ ëŒ€ê¸°
                    continue;
                }
                if(r.status===403){
                    markKeyFailed(idx);
                    lastError="403";
                    continue;
                }
                if(r.status===404||r.status===400){
                    lastError=String(r.status);
                    break; // ì´ ëª¨ë¸ ì•ˆë¨ â†’ ë‹¤ìŒ ëª¨ë¸ë¡œ
                }
                if(!r.ok){
                    markKeyFailed(idx);
                    lastError=String(r.status);
                    continue;
                }
                
                const d=await r.json();
                if(d.candidates&&d.candidates[0]&&d.candidates[0].content){
                    aiText=d.candidates[0].content.parts[0].text;
                    markKeySuccess(idx);
                    ok=true;
                    break;
                } else {
                    lastError="empty";
                    continue;
                }
            }catch(e){
                if(e.name==='AbortError'){lastError="timeout";}
                else{lastError=e.message;}
                markKeyFailed(idx);
                continue;
            }
        }
    }
    
    document.getElementById(lid)?.remove();
    
    // 3) ì„±ê³µ ì‹œ
    if(ok&&aiText){
        setCache(text,aiText);
        handleActions(aiText);
        appendMsg(aiText,'bot');
        return;
    }
    
    // 4) ì „ë¶€ ì‹¤íŒ¨ â†’ Fallback AI
    console.warn(`[ì²´ë¦¬] API ëª¨ë‘ ì‹¤íŒ¨ (ë§ˆì§€ë§‰: ${lastError}), ì˜¤í”„ë¼ì¸ ëª¨ë“œ`);
    const fb=fallbackAI(text);
    aiText=fb.text;
    if(fb.action)execAction(fb.action);
    appendMsg(aiText+' <span class="fallback-badge">ğŸ’ì˜¤í”„ë¼ì¸</span>','bot');
}

function handleActions(t){if(!t.includes('{"action"'))return;try{const m=t.match(/\{"action":[^}]*\]/)||t.match(/\{"action":[^}]*\}/);if(m)execAction(JSON.parse(m[0]));}catch(e){}}
function execAction(c){if(c.action==='add_event')db.collection("family_events").add({date:c.date,title:c.title,timestamp:firebase.firestore.FieldValue.serverTimestamp()});else if(c.action==='add_shopping')db.collection("family_shopping").add({text:c.item,checked:false,timestamp:firebase.firestore.FieldValue.serverTimestamp()});else if(c.action==='add_shopping_multi')c.items.forEach(i=>db.collection("family_shopping").add({text:i,checked:false,timestamp:firebase.firestore.FieldValue.serverTimestamp()}));}
function appendMsg(t,s){const b=document.getElementById('chatBody');b.innerHTML+=`<div class="chat-msg msg-${s}">${marked.parse(t)}</div>`;b.scrollTop=b.scrollHeight;}
function appendLoading(){const id='l'+Date.now();document.getElementById('chatBody').innerHTML+=`<div class="chat-msg msg-bot typing-indicator" id="${id}"><span></span><span></span><span></span></div>`;const b=document.getElementById('chatBody');b.scrollTop=b.scrollHeight;return id;}
function toggleChat(){const w=document.getElementById('chatWindow');w.style.display=w.style.display==='flex'?'none':'flex';}

/* â•â•â• ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± â•â•â• */
let familyData=[],selectedRole="",familyLoaded=false,pendingPosts=null;
function loadFamily(){
    db.collection("family_members").orderBy("timestamp").onSnapshot(snap=>{
        familyData=[];const con=document.getElementById('family-container'),chips=document.getElementById('writerChips');
        con.innerHTML="";chips.innerHTML="";
        if(snap.empty)chips.innerHTML=`<div style="padding:10px;font-size:14px;color:#aaa;">ê°€ì¡±ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”!</div>`;
        snap.forEach(doc=>{const d=doc.data();familyData.push({id:doc.id,...d});
            const img=d.imageUrl?`<img src="${d.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user" style="font-size:30px;"></i>`;
            con.innerHTML+=`<div class="mem-card"><button onclick="delFamily('${doc.id}')" style="position:absolute;top:10px;right:10px;border:none;background:none;color:#999;cursor:pointer;"><i class="fa-solid fa-times"></i></button><div class="mem-pic">${img}</div><div class="mem-role">${d.role}</div><div class="mem-desc">${d.desc||'Yummy!'}</div></div>`;
            const chk=selectedRole===d.role?'checked':'';
            chips.innerHTML+=`<input type="radio" name="auth" id="c-${doc.id}" class="radio-hidden" value="${d.role}" onchange="selAuth(this)" ${chk}><label for="c-${doc.id}" class="writer-tag"><div style="width:24px;height:24px;border-radius:50%;overflow:hidden;background:#eee;border:1px solid #444;display:flex;align-items:center;justify-content:center;">${d.imageUrl?`<img src="${d.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user" style="font-size:12px;"></i>`}</div> ${d.role}</label>`;
        });
        con.innerHTML+=`<div class="mem-card add-card" onclick="openFamModal()"><i class="fa-solid fa-plus-circle" style="font-size:40px;"></i><span style="font-family:'Jua';font-size:18px;">ê°€ì¡± ì¶”ê°€</span></div>`;
        updateHeaderProf();updateCommentAvatars();
        familyLoaded=true;
        if(pendingPosts){renderFeed(pendingPosts);pendingPosts=null;}
    });
}
function selAuth(rd){selectedRole=rd.value;updateHeaderProf();updateCommentAvatars();}
function updateHeaderProf(){const hp=document.getElementById('headerProfile');if(!selectedRole){hp.innerHTML=`<i class="fa-solid fa-user"></i>`;return;}const m=familyData.find(x=>x.role===selectedRole);hp.innerHTML=m&&m.imageUrl?`<img src="${m.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user"></i>`;}
function updateCommentAvatars(){const h=getMyAvatarHtml();document.querySelectorAll('.cmt-my-avatar').forEach(el=>{el.innerHTML=h;});}
function getMemberImg(role){const m=familyData.find(x=>x.role===role);return m&&m.imageUrl?`<img src="${m.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user" style="font-size:14px;color:#bbb;"></i>`;}
function getMyAvatarHtml(){return selectedRole?getMemberImg(selectedRole):`<i class="fa-solid fa-user" style="font-size:12px;color:#bbb;"></i>`;}

/* â•â•â• ğŸ“° í”¼ë“œ â•â•â• */
let feedImg=null;
function handleImageSelect(e){if(e.target.files[0])compressImage(e.target.files[0],500,d=>{feedImg=d;document.getElementById('imagePreview').src=d;document.getElementById('imagePreviewBox').style.display='block';});}
function clearImage(){feedImg=null;document.getElementById('imageInput').value='';document.getElementById('imagePreviewBox').style.display='none';}
function addPost(){
    if(!selectedRole)return alert("ê°€ì¡±ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
    const txt=document.getElementById('postContent').value,btn=document.getElementById('btnPost');
    if(!txt&&!feedImg)return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    const mem=familyData.find(m=>m.role===selectedRole);btn.disabled=true;btn.innerText="ì €ì¥ ì¤‘...";
    db.collection("family_posts").add({author:selectedRole,authorImg:mem?mem.imageUrl:null,content:txt,imageUrl:feedImg,likedBy:[],likedByData:[],comments:[],timestamp:firebase.firestore.FieldValue.serverTimestamp()})
    .then(()=>{document.getElementById('postContent').value='';clearImage();btn.disabled=false;btn.innerText="ì—…ë¡œë“œ!";window.scrollTo(0,0);})
    .catch(()=>{alert("ì‹¤íŒ¨!");btn.disabled=false;btn.innerText="ì—…ë¡œë“œ!";});
}
function likePost(id,likedByDataArr){
    if(!selectedRole)return alert("í”„ë¡œí•„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
    const likedByData=likedByDataArr||[];
    const already=likedByData.find(x=>x.role===selectedRole);
    const mem=familyData.find(m=>m.role===selectedRole);
    const myImg=mem?mem.imageUrl||null:null;
    if(already){
        db.collection("family_posts").doc(id).update({likedBy:firebase.firestore.FieldValue.arrayRemove(selectedRole),likedByData:firebase.firestore.FieldValue.arrayRemove(already)});
    }else{
        db.collection("family_posts").doc(id).update({likedBy:firebase.firestore.FieldValue.arrayUnion(selectedRole),likedByData:firebase.firestore.FieldValue.arrayUnion({role:selectedRole,img:myImg})});
        const b=document.querySelector(`[data-like-id="${id}"]`);if(b){b.classList.add('heart-pop');setTimeout(()=>b.classList.remove('heart-pop'),400);}
    }
}
function renderFeed(posts){
    const con=document.getElementById('feed-container');con.innerHTML="";
    if(!posts.length){con.innerHTML=`<div style="text-align:center;padding:40px;color:#aaa;">ì²« ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”! ğŸ’</div>`;return;}
    posts.forEach(d=>{
        let authorImgUrl=d.authorImg;if(!authorImgUrl){const mem=familyData.find(m=>m.role===d.author);if(mem)authorImgUrl=mem.imageUrl;}
        const pImg=authorImgUrl?`<div class="fp-img"><img src="${authorImgUrl}" style="width:100%;height:100%;object-fit:cover;"></div>`:`<div class="fp-img"><i class="fa-solid fa-user"></i></div>`;
        const iHtml=d.imageUrl?`<div class="feed-photo"><img src="${d.imageUrl}"></div>`:'';
        const likedBy=d.likedBy||[],likedByData=d.likedByData||[],lc=likedBy.length,iL=selectedRole&&likedBy.includes(selectedRole);
        let lpH='';
        if(lc>0){lpH='<div class="like-profiles">';
            if(likedByData.length>0){likedByData.slice(0,8).forEach(ld=>{if(ld.img)lpH+=`<div class="like-avatar"><img src="${ld.img}"></div>`;else{const mem=familyData.find(m=>m.role===ld.role);lpH+=mem&&mem.imageUrl?`<div class="like-avatar"><img src="${mem.imageUrl}"></div>`:`<div class="like-avatar"><i class="fa-solid fa-user" style="font-size:10px;color:#bbb;"></i></div>`;}});}
            else{likedBy.slice(0,8).forEach(role=>{const mem=familyData.find(m=>m.role===role);lpH+=mem&&mem.imageUrl?`<div class="like-avatar"><img src="${mem.imageUrl}"></div>`:`<div class="like-avatar"><i class="fa-solid fa-user" style="font-size:10px;color:#bbb;"></i></div>`;});}
            lpH+=`<span class="like-text"><b>${likedBy.join(', ')}</b>ë‹˜ì´ ì¢‹ì•„í•©ë‹ˆë‹¤</span></div>`;}
        let cmH='';if(d.comments&&d.comments.length>0)d.comments.forEach((c,i)=>{cmH+=`<div class="cmt-single"><div class="cmt-avatar">${getMemberImg(c.author)}</div><div class="cmt-body"><span class="cmt-author">${c.author}</span><span class="cmt-text">${c.text}</span></div><button class="cmt-del" onclick="delComment('${d.id}',${i})"><i class="fa-solid fa-times"></i></button></div>`;});
        const ts=d.timestamp?new Date(d.timestamp.seconds*1000).toLocaleDateString('ko-KR',{month:'long',day:'numeric'}):'ë°©ê¸ˆ';
        con.innerHTML+=`<div class="retro-card" style="padding-bottom:0;overflow:hidden;"><div class="feed-head"><div class="feed-profile">${pImg}<div><h4 style="font-size:15px;">${d.author}</h4><span style="font-size:12px;color:#999;">${ts}</span></div></div><button onclick="delPost('${d.id}')" style="border:none;background:none;color:#bbb;cursor:pointer;"><i class="fa-solid fa-trash" style="font-size:14px;"></i></button></div><div style="margin-bottom:12px;font-size:15px;line-height:1.6;">${d.content}</div>${iHtml}<div style="display:flex;gap:12px;padding:8px 0;"><button class="act-btn ${iL?'liked':''}" data-like-id="${d.id}" onclick='likePost("${d.id}",${JSON.stringify(likedByData)})'><i class="${iL?'fa-solid fa-heart':'fa-regular fa-heart'}" style="font-size:18px;"></i> ${lc||''}</button><button class="act-btn" onclick="toggleCmt('${d.id}')"><i class="fa-regular fa-comment" style="font-size:18px;"></i> ${d.comments?d.comments.length:''}</button></div>${lpH}${lc===0?'<div class="feed-bottom-pad"></div>':''}<div id="cmt-${d.id}" class="cmt-area"><div class="cmt-list">${cmH||'<div style="text-align:center;padding:20px;color:#ccc;font-size:13px;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ì–´ìš”</div>'}</div><div class="cmt-input-bar"><div class="cmt-my-avatar">${getMyAvatarHtml()}</div><input type="text" id="cInp-${d.id}" placeholder="ëŒ“ê¸€ ë‹¬ê¸°..." onkeydown="if(event.key==='Enter')addCmt('${d.id}')"><button class="cmt-send-btn" onclick="addCmt('${d.id}')">ê²Œì‹œ</button></div></div></div>`;
    });
}
function loadFeed(){db.collection("family_posts").limit(20).onSnapshot(snap=>{let posts=[];snap.forEach(d=>{const data=d.data();if(!data.likedBy)data.likedBy=[];if(!data.likedByData)data.likedByData=[];posts.push({id:d.id,...data});});posts.sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));if(!familyLoaded){pendingPosts=posts;return;}renderFeed(posts);});}
function delPost(id){if(confirm("ì‚­ì œí• ê¹Œìš”?"))db.collection("family_posts").doc(id).delete();}
function toggleCmt(id){document.getElementById(`cmt-${id}`).classList.toggle('show');}
function addCmt(id){if(!selectedRole)return alert("í”„ë¡œí•„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");const t=document.getElementById(`cInp-${id}`).value.trim();if(!t)return;db.collection("family_posts").doc(id).update({comments:firebase.firestore.FieldValue.arrayUnion({author:selectedRole,text:t,time:Date.now()})});document.getElementById(`cInp-${id}`).value='';}
function delComment(pid,idx){if(!confirm("ì‚­ì œ?"))return;db.collection("family_posts").doc(pid).get().then(doc=>{if(doc.exists){const c=doc.data().comments||[];c.splice(idx,1);db.collection("family_posts").doc(pid).update({comments:c});}});}

/* ìº˜ë¦°ë” */
let curDate=new Date(),events=[],curModDate=null;
function loadCal(){const y=curDate.getFullYear(),m=curDate.getMonth();document.getElementById('month-display').innerText=`${m+1}ì›”`;const f=new Date(y,m,1),l=new Date(y,m+1,0),con=document.getElementById('calendar-days');con.innerHTML="";for(let i=0;i<f.getDay();i++)con.innerHTML+=`<div></div>`;for(let i=1;i<=l.getDate();i++){const dS=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`,hE=events.filter(e=>e.date===dS).length?`<div class="ev-badge"></div>`:'',td=new Date().toDateString()===new Date(y,m,i).toDateString()?'today':'';con.innerHTML+=`<div class="date-box ${td}" onclick="openEvModal('${dS}')"><span>${i}</span>${hE}</div>`;}}
function moveMonth(n){curDate.setMonth(curDate.getMonth()+n);loadCal();}
function openEvModal(d){curModDate=d;document.getElementById('modalDateDisplay').innerText=d;renderEvList();document.getElementById('eventModal').style.display='flex';}
function renderEvList(){const el=document.getElementById('eventList'),evs=events.filter(e=>e.date===curModDate);el.innerHTML=evs.length?"":"<li style='text-align:center;color:#999;'>ì¼ì • ì—†ìŒ</li>";evs.forEach(e=>el.innerHTML+=`<li style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #ccc;"><span>${e.title}</span><i class="fa-solid fa-times" style="color:red;cursor:pointer;" onclick="delEv('${e.id}')"></i></li>`);}
function saveEvent(){const t=document.getElementById('eventTitle').value;if(curModDate&&t)db.collection("family_events").add({date:curModDate,title:t,timestamp:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{document.getElementById('eventTitle').value='';closeModal('eventModal');});}
function delEv(id){if(confirm("ì‚­ì œ?"))db.collection("family_events").doc(id).delete();}
db.collection("family_events").onSnapshot(s=>{events=[];s.forEach(d=>events.push({id:d.id,...d.data()}));loadCal();if(curModDate)renderEvList();});
let famImg=null;
function closeModal(id){document.getElementById(id).style.display='none';famImg=null;curModDate=null;}
function openFamModal(){document.getElementById('familyModal').style.display='flex';}
function handleFamImgSelect(e){if(e.target.files[0])compressImage(e.target.files[0],500,d=>{famImg=d;document.getElementById('famImgPreview').innerHTML=`<img src="${d}" style="width:100%;height:100%;object-fit:cover;">`;});}
function saveFam(){const r=document.getElementById('famRole').value,n=document.getElementById('famName').value,d=document.getElementById('famDesc').value;if(!r)return alert("ì—­í•  ì…ë ¥!");const btn=document.getElementById('btnSaveFam');btn.disabled=true;btn.innerText="ì €ì¥ ì¤‘...";db.collection("family_members").add({role:r,name:n,desc:d,imageUrl:famImg,timestamp:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{closeModal('familyModal');btn.disabled=false;btn.innerText="ì¶”ê°€";document.getElementById('famRole').value='';document.getElementById('famName').value='';document.getElementById('famDesc').value='';document.getElementById('famImgInput').value='';document.getElementById('famImgPreview').innerHTML=`<i class="fa-solid fa-camera" style="font-size:30px;color:var(--text-choco);"></i>`;}).catch(()=>{alert("ì˜¤ë¥˜!");btn.disabled=false;btn.innerText="ì¶”ê°€";});}
function delFamily(id){if(confirm("ì‚­ì œ?"))db.collection("family_members").doc(id).delete();}
function loadShopping(){db.collection("family_shopping").orderBy("timestamp","desc").onSnapshot(snap=>{const list=document.getElementById('shopList');list.innerHTML="";snap.forEach(doc=>{const d=doc.data();list.innerHTML+=`<div class="shop-item"><div style="display:flex;align-items:center;"><div class="shop-check ${d.checked?'on':''}" onclick="toggleShop('${doc.id}',${!d.checked})"><i class="fa-solid fa-check" style="color:white;font-size:12px;"></i></div><span style="${d.checked?'text-decoration:line-through;color:#aaa;':''}">${d.text}</span></div><i class="fa-solid fa-times shop-del" onclick="delShop('${doc.id}')"></i></div>`;});});}
function addShopItem(){const inp=document.getElementById('shopInput');if(inp.value.trim()){db.collection("family_shopping").add({text:inp.value,checked:false,timestamp:firebase.firestore.FieldValue.serverTimestamp()});inp.value='';}}
function toggleShop(id,s){db.collection("family_shopping").doc(id).update({checked:s});}
function delShop(id){if(confirm("ì‚­ì œ?"))db.collection("family_shopping").doc(id).delete();}
window.changeTab=function(id,el){document.querySelectorAll('.tab-section').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));if(el)el.classList.add('active');window.scrollTo(0,0);}
loadFamily();loadFeed();loadCal();loadShopping();
</script>
</body>
</html>
