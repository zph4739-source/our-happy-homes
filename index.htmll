<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Yummy Family Log</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=DM+Serif+Display&family=Noto+Sans+KR:wght@400;700&family=Nanum+Gothic+Coding&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg-cream: #FFFDF5; --text-choco: #4A2c2A;
            --accent-red: #D94844; --accent-pink: #FFD1D1; --accent-yellow: #FFD56B;
            --border-thick: 2px solid #4A2c2A; --shadow-hard: 4px 4px 0px #4A2c2A;
            --radius-L: 20px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-cream); color: var(--text-choco); min-height: 100vh; overflow-x: hidden; padding-bottom: 120px; }
        .app-layout { max-width: 600px; margin: 0 auto; padding-bottom: 120px; position: relative; }
        .header { padding: 20px 24px; text-align: center; position: sticky; top: 0; z-index: 50; background: rgba(255, 253, 245, 0.95); backdrop-filter: blur(5px); border-bottom: var(--border-thick); }
        .brand-title { font-family: 'DM Serif Display', serif; font-size: 32px; color: var(--accent-red); text-shadow: 2px 2px 0px var(--text-choco); letter-spacing: 1px; margin-bottom: 5px; }
        .brand-sub { font-family: 'Jua', sans-serif; font-size: 16px; color: var(--text-choco); }
        .my-badge { position: absolute; right: 20px; top: 25px; width: 40px; height: 40px; background: white; border: var(--border-thick); border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; box-shadow: var(--shadow-hard); }
        .my-badge img { width: 100%; height: 100%; object-fit: cover; }
        .retro-card { background: white; border: var(--border-thick); border-radius: var(--radius-L); padding: 24px; margin: 24px 20px; box-shadow: var(--shadow-hard); position: relative; transition: 0.2s; }
        .btn-pop { background: var(--accent-red); color: white; border: var(--border-thick); padding: 14px 24px; border-radius: 50px; font-family: 'Jua', sans-serif; font-size: 18px; cursor: pointer; box-shadow: var(--shadow-hard); transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; }
        .btn-pop:active { transform: translate(2px, 2px); box-shadow: none; background: #C0392B; }
        .btn-pop.yellow { background: var(--accent-yellow); color: var(--text-choco); }
        .btn-pop.gray { background: #E0E0E0; color: #555; border-color: #999; box-shadow: 2px 2px 0px #999; }
        .input-retro { width: 100%; background: #FFF; border: var(--border-thick); border-radius: 16px; padding: 14px; font-size: 16px; color: var(--text-choco); outline: none; box-shadow: inset 2px 2px 5px rgba(74, 44, 42, 0.1); }
        .tab-section { display: none; } .tab-section.active { display: block; animation: popIn 0.3s; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .nav-dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px; background: var(--text-choco); border-radius: 40px; box-shadow: 0 10px 20px rgba(74, 44, 42, 0.3); display: flex; justify-content: space-around; align-items: center; padding: 0 20px; z-index: 100; border: 2px solid white; }
        .nav-item { color: rgba(255,255,255,0.5); font-size: 24px; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--accent-yellow); transform: translateY(-5px); }
        .receipt-paper { background: white; width: 90%; margin: 20px auto; padding: 20px; border-top: 1px solid #ddd; box-shadow: 0 5px 15px rgba(0,0,0,0.1); position: relative; font-family: 'Nanum Gothic Coding', monospace; }
        .receipt-paper::before { content: ""; position: absolute; top: -10px; left: 0; width: 100%; height: 10px; background: radial-gradient(circle at 10px 15px, transparent 10px, white 11px); background-size: 20px 20px; }
        .receipt-paper::after { content: ""; position: absolute; bottom: -10px; left: 0; width: 100%; height: 10px; background: radial-gradient(circle at 10px -5px, transparent 10px, white 11px); background-size: 20px 20px; }
        .receipt-title { text-align: center; font-size: 20px; border-bottom: 2px dashed #444; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; }
        .shop-input-area { display: flex; gap: 10px; margin-bottom: 15px; }
        .shop-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ddd; font-size: 16px; }
        .shop-check { width: 20px; height: 20px; border: 2px solid var(--text-choco); border-radius: 4px; margin-right: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .shop-check.on { background: var(--accent-red); }
        .shop-del { color: #aaa; cursor: pointer; padding: 5px; }
        .chatbot-btn { position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px; background: var(--accent-red); border: var(--border-thick); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; box-shadow: var(--shadow-hard); cursor: pointer; z-index: 999; transition: 0.2s; }
        .chatbot-btn:active { transform: translate(2px, 2px); box-shadow: none; }
        .chat-window { position: fixed; bottom: 170px; right: 20px; width: 320px; height: 480px; background: white; border: var(--border-thick); border-radius: 20px; display: none; flex-direction: column; z-index: 999; box-shadow: 10px 10px 0px rgba(0,0,0,0.2); overflow: hidden; }
        .chat-head { background: var(--accent-yellow); padding: 15px; border-bottom: var(--border-thick); font-family: 'Jua'; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #fffdf5; font-size: 14px; }
        .chat-msg { margin-bottom: 10px; max-width: 85%; padding: 10px 14px; border-radius: 12px; line-height: 1.4; border: 1px solid rgba(0,0,0,0.1); word-break: keep-all; }
        .msg-bot { background: white; align-self: flex-start; border-radius: 4px 12px 12px 12px; }
        .msg-user { background: var(--accent-pink); align-self: flex-end; margin-left: auto; border-radius: 12px 12px 4px 12px; }
        .chat-input-area { padding: 10px; border-top: var(--border-thick); display: flex; gap: 5px; background: white; }
        .chat-inp { flex: 1; border: 1px solid #444; border-radius: 20px; padding: 10px; outline: none; }
        .typing-indicator span { display: inline-block; width: 6px; height: 6px; background: #aaa; border-radius: 50%; margin: 0 2px; animation: typing 1s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; } .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .writer-scroll { display: flex; gap: 12px; margin-bottom: 20px; overflow-x: auto; padding: 5px; scrollbar-width: none; }
        .writer-scroll::-webkit-scrollbar { display: none; }
        .radio-hidden { display: none; }
        .writer-tag { padding: 8px 16px; background: white; border: var(--border-thick); border-radius: 30px; font-family: 'Jua', sans-serif; font-size: 16px; color: var(--text-choco); cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 6px; box-shadow: 2px 2px 0px rgba(74, 44, 42, 0.2); }
        .radio-hidden:checked + .writer-tag { background: var(--accent-red); color: white; box-shadow: var(--shadow-hard); transform: translateY(-2px); }
        .img-preview { width: 100%; border: var(--border-thick); border-radius: 16px; margin-top: 15px; overflow: hidden; position: relative; display: none; background: white; }
        .feed-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px dashed #E5D0C0; padding-bottom: 10px; }
        .feed-profile { display: flex; align-items: center; gap: 10px; }
        .fp-img { width: 45px; height: 45px; border-radius: 50%; border: var(--border-thick); background: white; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .feed-photo { padding: 10px; background: white; border: var(--border-thick); transform: rotate(-1deg); margin-bottom: 15px; box-shadow: 3px 3px 0px rgba(0,0,0,0.1); }
        .feed-photo img { width: 100%; border: 1px solid #eee; display: block; }
        .act-btn { padding: 8px 12px; background: var(--bg-cream); border: 2px solid #E5D0C0; border-radius: 12px; font-weight: 700; font-size: 13px; color: var(--text-choco); display: flex; gap: 6px; align-items: center; cursor: pointer; transition: 0.2s; }
        .act-btn.liked { color: var(--accent-red); border-color: var(--accent-red); }
        .heart-pop { animation: heartPop 0.4s ease; }
        @keyframes heartPop { 0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); } }
        .like-profiles { display: flex; align-items: center; gap: 4px; margin-top: 8px; flex-wrap: wrap; padding-bottom: 10px; }
        .like-profiles .like-avatar { width: 22px; height: 22px; border-radius: 50%; border: 1.5px solid var(--accent-red); overflow: hidden; display: flex; align-items: center; justify-content: center; background: white; }
        .like-profiles .like-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .like-profiles .like-text { font-size: 12px; color: #888; margin-left: 4px; }
        .cmt-area { background: #FAFAFA; border-top: 1px solid #E5D0C0; border-radius: 0 0 16px 16px; padding: 0; margin-top: 15px; display: none; overflow: hidden; }
        .cmt-area.show { display: block; }
        .cmt-list { max-height: 300px; overflow-y: auto; padding: 12px 16px; }
        .cmt-list::-webkit-scrollbar { width: 4px; }
        .cmt-list::-webkit-scrollbar-thumb { background: #ddd; border-radius: 4px; }
        .cmt-single { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; position: relative; }
        .cmt-single:not(:last-child) { border-bottom: 1px solid #f0e8df; }
        .cmt-avatar { width: 32px; height: 32px; min-width: 32px; border-radius: 50%; border: 1.5px solid #E5D0C0; overflow: hidden; display: flex; align-items: center; justify-content: center; background: white; }
        .cmt-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .cmt-body { flex: 1; }
        .cmt-author { font-weight: 700; font-size: 13px; color: var(--text-choco); margin-right: 6px; }
        .cmt-text { font-size: 13px; color: #333; line-height: 1.5; }
        .cmt-del { position: absolute; right: 0; top: 12px; border: none; background: none; color: #ccc; cursor: pointer; font-size: 12px; padding: 4px; }
        .cmt-del:hover { color: var(--accent-red); }
        .cmt-input-bar { display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-top: 1px solid #eee; background: white; }
        .cmt-input-bar .cmt-my-avatar { width: 28px; height: 28px; min-width: 28px; border-radius: 50%; border: 1.5px solid #E5D0C0; overflow: hidden; display: flex; align-items: center; justify-content: center; background: white; }
        .cmt-input-bar .cmt-my-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .cmt-input-bar input { flex: 1; border: none; outline: none; font-size: 14px; padding: 8px 0; background: transparent; color: var(--text-choco); }
        .cmt-input-bar input::placeholder { color: #bbb; }
        .cmt-send-btn { border: none; background: none; color: var(--accent-red); font-weight: 700; font-size: 14px; cursor: pointer; font-family: 'Jua', sans-serif; padding: 4px 8px; }
        .cal-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .cal-title { font-family: 'DM Serif Display', serif; font-size: 32px; color: var(--accent-red); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .date-box { min-height: 70px; background: white; border: 2px solid #E5D0C0; border-radius: 12px; display: flex; flex-direction: column; align-items: center; padding: 5px; cursor: pointer; }
        .date-box.today { background: var(--accent-yellow); border: var(--border-thick); }
        .ev-badge { width: 8px; height: 8px; background: var(--accent-red); border-radius: 50%; border: 1px solid var(--text-choco); margin-top: 4px; }
        .family-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; padding: 0 10px; }
        .mem-card { background: white; border: var(--border-thick); border-radius: 24px; padding: 20px 10px; text-align: center; box-shadow: var(--shadow-hard); position: relative; }
        .mem-pic { width: 80px; height: 80px; border-radius: 50%; border: var(--border-thick); margin-bottom: 10px; background: var(--bg-cream); display: flex; align-items: center; justify-content: center; margin-left: auto; margin-right: auto; overflow: hidden; }
        .add-card { border: 2px dashed var(--text-choco); background: rgba(255,255,255,0.5); box-shadow: none; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; min-height: 200px; gap: 10px; }
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(74, 44, 42, 0.6); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-card { background: var(--bg-cream); width: 85%; max-width: 350px; padding: 25px; border: var(--border-thick); border-radius: var(--radius-L); box-shadow: 8px 8px 0px rgba(0,0,0,0.2); }
        .modal-tit { font-family: 'Jua', sans-serif; font-size: 24px; margin-bottom: 20px; color: var(--text-choco); display:flex; align-items:center; gap:8px;}
        .modal-btns { display: flex; flex-direction: column; gap: 12px; margin-top: 25px; }
        .cache-badge { display: inline-block; font-size: 10px; background: var(--accent-yellow); color: var(--text-choco); padding: 2px 6px; border-radius: 8px; margin-left: 4px; font-weight: bold; }
        @media (min-width: 768px) {
            .app-layout { padding: 40px; }
            .nav-dock { bottom: auto; top: 50%; left: 40px; transform: translateY(-50%); width: 70px; height: 300px; flex-direction: column; padding: 30px 0; }
            .family-grid { grid-template-columns: repeat(3, 1fr); }
            .chatbot-btn { right: 50px; bottom: 50px; }
            .chat-window { right: 50px; bottom: 120px; }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <header class="header">
            <div class="brand-title">Yummy Family</div>
            <div class="brand-sub">ìš°ë¦¬ ê°€ì¡±ì˜ ë§›ìˆëŠ” ì¼ìƒ ğŸ’</div>
            <div class="my-badge" id="headerProfile"><i class="fa-solid fa-user"></i></div>
        </header>
        <main id="mainContent">
            <div id="feed" class="tab-section active">
                <div class="retro-card">
                    <div style="font-family:'Jua'; font-size:20px; margin-bottom:15px;"><i class="fa-solid fa-pen-fancy" style="color:var(--accent-red);"></i> ì˜¤ëŠ˜ì˜ ì¶”ì–µ ê¸°ë¡</div>
                    <div class="writer-scroll" id="writerChips"><div style="font-size:14px; color:#aaa; padding:10px;">ë¡œë”© ì¤‘...</div></div>
                    <textarea id="postContent" class="input-retro" style="min-height:100px; resize:none;" placeholder="ì˜¤ëŠ˜ ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆë‚˜ìš”? ğŸ°"></textarea>
                    <div id="imagePreviewBox" class="img-preview"><img id="imagePreview" src=""><button class="btn-x" onclick="clearImage()"><i class="fa-solid fa-times"></i></button></div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                        <label for="imageInput" style="font-size:24px; color:var(--text-choco); cursor:pointer;"><i class="fa-regular fa-image"></i></label>
                        <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
                        <button id="btnPost" class="btn-pop" style="width:auto; padding:10px 30px;" onclick="addPost()">ì—…ë¡œë“œ!</button>
                    </div>
                </div>
                <div id="feed-container"></div>
            </div>
            <div id="calendar" class="tab-section">
                <div class="retro-card">
                    <div class="cal-top">
                        <button class="cal-arrow" onclick="moveMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                        <div id="month-display" class="cal-title"></div>
                        <button class="cal-arrow" onclick="moveMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <div class="cal-grid" style="margin-bottom:10px;"><div class="day-label" style="color:var(--accent-red)">ì¼</div><div class="day-label">ì›”</div><div class="day-label">í™”</div><div class="day-label">ìˆ˜</div><div class="day-label">ëª©</div><div class="day-label">ê¸ˆ</div><div class="day-label">í† </div></div>
                    <div id="calendar-days" class="cal-grid"></div>
                </div>
            </div>
            <div id="shopping" class="tab-section">
                <div class="receipt-paper">
                    <div class="receipt-title">ğŸ›’ ì¥ë³´ê¸° ë¦¬ìŠ¤íŠ¸</div>
                    <div class="shop-input-area">
                        <input type="text" id="shopInput" class="input-retro" placeholder="ì‚´ ê²ƒ ì…ë ¥ (ì˜ˆ: ìš°ìœ )" onkeydown="if(event.key==='Enter')addShopItem()">
                        <button class="btn-pop" style="width:auto;" onclick="addShopItem()">+</button>
                    </div>
                    <div id="shopList"></div>
                    <div style="text-align:center; margin-top:20px; font-size:12px; color:#aaa;">*** THANK YOU ***</div>
                </div>
            </div>
            <div id="family" class="tab-section">
                <div style="text-align:center; margin-bottom:20px; font-family:'Jua'; font-size:28px;">ìš°ë¦¬ ê°€ì¡± ë©¤ë²„ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                <div id="family-container" class="family-grid"></div>
            </div>
        </main>
        <nav class="nav-dock">
            <div class="nav-item active" onclick="changeTab('feed', this)"><i class="fa-solid fa-house"></i></div>
            <div class="nav-item" onclick="changeTab('calendar', this)"><i class="fa-solid fa-calendar-days"></i></div>
            <div class="nav-item" onclick="changeTab('shopping', this)"><i class="fa-solid fa-cart-shopping"></i></div>
            <div class="nav-item" onclick="changeTab('family', this)"><i class="fa-solid fa-users"></i></div>
        </nav>
    </div>

    <div class="chatbot-btn" onclick="toggleChat()"><i class="fa-solid fa-robot"></i></div>
    <div class="chat-window" id="chatWindow">
        <div class="chat-head">ğŸ’ AI ì²´ë¦¬ <i class="fa-solid fa-times" style="cursor:pointer;" onclick="toggleChat()"></i></div>
        <div class="chat-body" id="chatBody">
            <div class="chat-msg msg-bot">ì•ˆë…•í•˜ì„¸ìš”! ìš°ë¦¬ ê°€ì¡± ì „ìš© AI <b>ì²´ë¦¬</b>ì…ë‹ˆë‹¤! ğŸ’<br>ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-inp" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeydown="if(event.key==='Enter')sendChat()">
            <button class="btn-pop" style="width:auto; padding:5px 15px; font-size:14px;" onclick="sendChat()">ì „ì†¡</button>
        </div>
    </div>

    <div id="eventModal" class="modal-bg"><div class="modal-card">
        <div class="modal-tit">ğŸ“… ì¼ì • ê¸°ë¡</div>
        <p id="modalDateDisplay" style="text-align:center; font-weight:bold; margin-bottom:20px;"></p>
        <ul id="eventList" style="list-style:none; margin-bottom:20px; padding:0;"></ul>
        <input type="hidden" id="eventDate">
        <input type="text" id="eventTitle" class="input-retro" placeholder="ì¼ì • ë‚´ìš©" onkeydown="if(event.key==='Enter') saveEvent()">
        <div class="modal-btns"><button class="btn-pop gray" onclick="closeModal('eventModal')">ë‹«ê¸°</button><button class="btn-pop" onclick="saveEvent()">ì €ì¥</button></div>
    </div></div>

    <div id="familyModal" class="modal-bg"><div class="modal-card">
        <div class="modal-tit">ğŸ’ ê°€ì¡± ì¶”ê°€</div>
        <div style="text-align:center; margin-bottom:20px;">
            <label for="famImgInput" style="display:inline-block; cursor:pointer;">
                <div id="famImgPreview" style="width:100px;height:100px;border-radius:50%;background:var(--bg-cream);border:var(--border-thick);display:flex;align-items:center;justify-content:center;overflow:hidden;"><i class="fa-solid fa-camera" style="font-size:30px;color:var(--text-choco);"></i></div>
            </label>
            <input type="file" id="famImgInput" accept="image/*" style="display:none;" onchange="handleFamImgSelect(event)">
        </div>
        <input type="text" id="famRole" class="input-retro" placeholder="ì—­í•  (ì˜ˆ: ì•„ë¹ )" style="margin-bottom:10px;">
        <input type="text" id="famName" class="input-retro" placeholder="ì´ë¦„ (ì„ íƒ)" style="margin-bottom:10px;">
        <input type="text" id="famDesc" class="input-retro" placeholder="í•œ ë§ˆë”” ì†Œê°œ">
        <div class="modal-btns"><button class="btn-pop gray" onclick="closeModal('familyModal')">ì·¨ì†Œ</button><button id="btnSaveFam" class="btn-pop" onclick="saveFam()">ì¶”ê°€</button></div>
    </div></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ”‘ API í‚¤ ë¡œí…Œì´ì…˜ ì‹œìŠ¤í…œ (3ê°œ í‚¤)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GEMINI_API_KEYS = [
    "AIzaSyDCJvEiVEYrCI5x7_YDOipEG5mUFZVKmkI",
    "AIzaSyA8W6gw7yle9T1lypOIHZZazSFzlICtJDw",
    "AIzaSyCp2RHsM2tbI3DU6Ltu2bIg2hIBIxRwDOE"
];
let currentKeyIndex = 0;
function getNextKey() {
    const key = GEMINI_API_KEYS[currentKeyIndex];
    currentKeyIndex = (currentKeyIndex + 1) % GEMINI_API_KEYS.length;
    return key;
}

const firebaseConfig = {
    apiKey: "AIzaSyCokmBJyH6xGaB42u_ScP6k7ghEVxTZSio",
    authDomain: "our-family-home.firebaseapp.com",
    projectId: "our-family-home",
    storageBucket: "our-family-home.firebasestorage.app",
    messagingSenderId: "446464856858",
    appId: "1:446464856858:web:344f2c83aeda0ea9ae52a3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function compressImage(f,mW,cb){const r=new FileReader();r.onload=e=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');let w=i.width,h=i.height;if(w>mW){h*=mW/w;w=mW;}c.width=w;c.height=h;c.getContext('2d').drawImage(i,0,0,w,h);cb(c.toDataURL('image/jpeg',0.5));};i.src=e.target.result;};r.readAsDataURL(f);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ§  ê°•í™”ëœ ì˜¤í”„ë¼ì¸ Fallback AI
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const recipes = {
    "ë–¡ë³¶ì´":["ë–¡","ì–´ë¬µ","ëŒ€íŒŒ","ê³ ì¶”ì¥","ì„¤íƒ•","ë¬¼"],
    "ê¹€ì¹˜ì°Œê°œ":["ê¹€ì¹˜","ë¼ì§€ê³ ê¸°","ë‘ë¶€","ëŒ€íŒŒ","ê³ ì¶§ê°€ë£¨"],
    "ëœì¥ì°Œê°œ":["ëœì¥","í˜¸ë°•","ë‘ë¶€","ì–‘íŒŒ","ì²­ì–‘ê³ ì¶”"],
    "ë¯¸ì—­êµ­":["ë¯¸ì—­","ì†Œê³ ê¸°","ì°¸ê¸°ë¦„","êµ­ê°„ì¥","ë‹¤ì§„ë§ˆëŠ˜"],
    "ì¹´ë ˆ":["ì¹´ë ˆê°€ë£¨","ê°ì","ë‹¹ê·¼","ì–‘íŒŒ","ì‹ìš©ìœ "],
    "ë¼ë©´":["ë¼ë©´","ê³„ë€","íŒŒ","ë–¡(ì„ íƒ)"],
    "ë¹„ë¹”ë°¥":["ì½©ë‚˜ë¬¼","ì‹œê¸ˆì¹˜","ê³ ì¶”ì¥","ê³„ë€","ì°¸ê¸°ë¦„","ë‹¹ê·¼"],
    "ë¶ˆê³ ê¸°":["ì†Œê³ ê¸°","ì–‘íŒŒ","ë°°","ê°„ì¥","ì„¤íƒ•","ì°¸ê¸°ë¦„","ë§ˆëŠ˜"],
    "ì¡ì±„":["ë‹¹ë©´","ì‹œê¸ˆì¹˜","ë‹¹ê·¼","ì–‘íŒŒ","ë²„ì„¯","ê°„ì¥","ì°¸ê¸°ë¦„"],
    "ê³„ë€ë§ì´":["ê³„ë€","íŒŒ","ë‹¹ê·¼","ì†Œê¸ˆ","ì‹ìš©ìœ "],
    "ê¹€ë°¥":["ë°¥","ê¹€","ë‹¨ë¬´ì§€","ë‹¹ê·¼","ì‹œê¸ˆì¹˜","ê³„ë€","í–„"],
    "íŒŒìŠ¤íƒ€":["íŒŒìŠ¤íƒ€ë©´","ì˜¬ë¦¬ë¸Œì˜¤ì¼","ë§ˆëŠ˜","ì–‘íŒŒ","í† ë§ˆí† ì†ŒìŠ¤"],
    "ë³¶ìŒë°¥":["ë°¥","ê³„ë€","íŒŒ","ë‹¹ê·¼","ê°„ì¥","ì°¸ê¸°ë¦„"],
    "ë‹­ë³¶ìŒíƒ•":["ë‹­","ê°ì","ë‹¹ê·¼","ì–‘íŒŒ","ê³ ì¶”ì¥","ê°„ì¥","ê³ ì¶§ê°€ë£¨"],
    "ìƒŒë“œìœ„ì¹˜":["ì‹ë¹µ","ì–‘ìƒì¶”","í† ë§ˆí† ","ì¹˜ì¦ˆ","í–„","ë§ˆìš”ë„¤ì¦ˆ"],
    "ëœì¥êµ­":["ëœì¥","ë‘ë¶€","íŒŒ","í˜¸ë°•","ë©¸ì¹˜ìœ¡ìˆ˜"],
    "ì½©ë‚˜ë¬¼êµ­":["ì½©ë‚˜ë¬¼","íŒŒ","ë§ˆëŠ˜","êµ­ê°„ì¥","ì†Œê¸ˆ"],
    "ì œìœ¡ë³¶ìŒ":["ë¼ì§€ê³ ê¸°","ì–‘íŒŒ","íŒŒ","ê³ ì¶”ì¥","ê³ ì¶§ê°€ë£¨","ê°„ì¥"],
    "ì˜¤ë¯€ë¼ì´ìŠ¤":["ë°¥","ê³„ë€","ì–‘íŒŒ","ë‹¹ê·¼","ì¼€ì²©","ë²„í„°"],
    "ì°Œê°œ":["ê¹€ì¹˜","ë‘ë¶€","ë¼ì§€ê³ ê¸°","íŒŒ","ê³ ì¶§ê°€ë£¨"]
};

const mealSuggestions = {
    ì•„ì¹¨: ["í† ìŠ¤íŠ¸ & ê³„ë€í”„ë¼ì´ â˜€ï¸", "ì£½ í•œ ê·¸ë¦‡ ì–´ë•Œìš”? ğŸ¥£", "ì‹œë¦¬ì–¼ì´ë‚˜ ì˜¤íŠ¸ë°€! ğŸ¥›", "ê°„ë‹¨í•˜ê²Œ ìƒŒë“œìœ„ì¹˜ ğŸ¥ª", "ë°”ë‚˜ë‚˜ ìŠ¤ë¬´ë”” ì¶”ì²œ! ğŸŒ"],
    ì ì‹¬: ["ë¹„ë¹”ë°¥ ì–´ë•Œ? ğŸš", "ì¹¼êµ­ìˆ˜ ë¨¹ìœ¼ëŸ¬ ê°€ì! ğŸœ", "ê¹€ì¹˜ë³¶ìŒë°¥ ê°„ë‹¨í•˜ê²Œ! ğŸ³", "ëˆê¹ŒìŠ¤ ì–´ë•Œìš”? ğŸ·", "ëƒ‰ë©´ ì‹œì›í•˜ê²Œ! ğŸ§Š"],
    ì €ë…: ["ì‚¼ê²¹ì‚´ êµ¬ì›Œë¨¹ì! ğŸ¥©", "ì°Œê°œ ë“ì´ë©´ ë”±ì´ì§€! ğŸ²", "ì¹˜í‚¨ ì‹œí‚¬ê¹Œ? ğŸ—", "íŒŒìŠ¤íƒ€ ë§Œë“¤ì–´ë³¼ê¹Œ? ğŸ", "ì´ˆë°¥ ì–´ë•Œìš”? ğŸ£"],
    ì•¼ì‹: ["ë¼ë©´ ë¨¹ì! ğŸœ", "ì¹˜í‚¨ ì–´ë•Œ? ğŸ—", "ë–¡ë³¶ì´ ë•¡ê¸°ì§€? ğŸŒ¶ï¸", "í”¼ì ì‹œí‚¤ì! ğŸ•", "ì¡±ë°œ ì–´ë•Œìš”? ğŸ·"],
    ê°„ì‹: ["ê³¼ì¼ ê¹ì•„ë¨¹ì! ğŸ", "ë–¡ ë¨¹ì„ê¹Œ? ğŸ¡", "ì¿ í‚¤ êµ¬ì›Œë³¼ê¹Œ? ğŸª", "ì•„ì´ìŠ¤í¬ë¦¼! ğŸ¦", "ê³ êµ¬ë§ˆ ì°Œì! ğŸ "]
};

const generalChat = {
    greetings: ["ì•ˆë…•! ì˜¤ëŠ˜ í•˜ë£¨ë„ í™”ì´íŒ…! ğŸ’ª", "ë°˜ê°€ì›Œìš”~ ë­ ë„ì™€ì¤„ê¹Œ? ğŸ’", "í—¤ì´! ì˜¤ëŠ˜ ê¸°ë¶„ ì–´ë•Œ? ğŸ˜Š"],
    thanks: ["ë³„ë§ì”€ì„ìš”! ë” í•„ìš”í•œ ê±° ìˆì–´? ğŸ˜Š", "ë„ì›€ì´ ëë‹¤ë‹ˆ ê¸°ë»! ğŸ’", "ì–¸ì œë“  ë¶ˆëŸ¬ì¤˜~ âœ¨"],
    howAreYou: ["ë‚˜ëŠ” í•­ìƒ ì¢‹ì§€! ğŸ’ ë„ˆëŠ” ì–´ë•Œ?", "ì²´ë¦¬ëŠ” ì–¸ì œë‚˜ ì—ë„ˆì§€ ì¶©ì „ 100%! âš¡", "ì˜¤ëŠ˜ë„ ì—´ì‹¬íˆ ì¼í•˜ê³  ìˆì–´ìš”~ ğŸ’ª"],
    weather: ["ì˜¤ëŠ˜ ë‚ ì”¨ ì¢‹ìœ¼ë©´ ì‚°ì±… ì–´ë•Œìš”? ğŸŒ¤ï¸", "ë¹„ ì˜¤ë©´ ì§‘ì—ì„œ ì˜í™” ë³´ëŠ” ê²ƒë„ ì¢‹ì§€! ğŸ¬", "ì¶”ìš°ë©´ ë”°ëœ»í•œ êµ­ë¬¼ ìš”ë¦¬ ì¶”ì²œ! ğŸ²"],
    bored: ["ê°€ì¡±ì´ë‘ ë³´ë“œê²Œì„ ì–´ë•Œ? ğŸ²", "ê°™ì´ ìš”ë¦¬ ë§Œë“¤ì–´ë³´ëŠ” ê±´? ğŸ‘¨â€ğŸ³", "ì‚°ì±…í•˜ë©´ì„œ ì‚¬ì§„ ì°ì–´ë´! ğŸ“¸", "ë„·í”Œë¦­ìŠ¤ ì¶”ì²œì‘ ì°¾ì•„ë³¼ê¹Œ? ğŸ¬"],
    compliment: ["ì—í—¤~ ê³ ë§ˆì›Œ! ğŸ’âœ¨", "ì¹­ì°¬ì€ ì²´ë¦¬ë¥¼ ì¶¤ì¶”ê²Œ í•´ìš”! ğŸ’ƒ", "ë„ˆë„ ìµœê³ ì•¼! ğŸ‘"],
    love: ["ì‚¬ë‘í•´ìš”~ ê°€ì¡±ì´ ìµœê³ ì•¼! â¤ï¸", "ìš°ë¦¬ ê°€ì¡± í™”ì´íŒ…! ğŸ’•", "ê°€ì¡± ì‚¬ë‘ì´ ë„˜ì¹˜ë„¤ìš”! ğŸ¥°"],
    goodnight: ["ì˜ ììš”~ ì¢‹ì€ ê¿ˆ ê¿”! ğŸŒ™", "ì˜¤ëŠ˜ í•˜ë£¨ ìˆ˜ê³ í–ˆì–´! í‘¹ ì‰¬ì–´~ â­", "ë‚´ì¼ë„ ì¢‹ì€ í•˜ë£¨ ë˜ê¸¸! ğŸ’¤"],
    goodmorning: ["ì¢‹ì€ ì•„ì¹¨! â˜€ï¸ ì˜¤ëŠ˜ë„ í™œê¸°ì°¨ê²Œ!", "ì¼ì–´ë‚¬ì–´? ì•„ì¹¨ ë­ ë¨¹ì„ê¹Œ? ğŸ³", "êµ¿ëª¨ë‹~ ì˜¤ëŠ˜ ë­ í•  ê±°ì•¼? ğŸŒ…"],
    tired: ["ì¢€ ì‰¬ì–´~ ê±´ê°•ì´ ìµœê³ ì•¼! ğŸ’†", "ë”°ëœ»í•œ ì°¨ í•œ ì” ì–´ë•Œ? â˜•", "ì˜¤ëŠ˜ ì¼ì° ìëŠ” ê±´ ì–´ë•Œ? ğŸ˜´"],
    hungry: ["ë­ ë¨¹ê³  ì‹¶ì–´? ì¶”ì²œí•´ì¤„ê¹Œ? ğŸ¤”", "ë°°ê³ í”„ë©´ ì¼ë‹¨ ê°„ì‹ë¶€í„°! ğŸª", "ì¥ë³´ê¸° ë¦¬ìŠ¤íŠ¸ì— ë­ ì¶”ê°€í• ê¹Œ? ğŸ›’"],
    exercise: ["ìŠ¤íŠ¸ë ˆì¹­ë¶€í„° ì‹œì‘í•´ë´! ğŸ§˜", "ê°€ì¡±ì´ë‘ ê°™ì´ ì‚°ì±… ì–´ë•Œ? ğŸš¶", "í™ˆíŠ¸ë ˆì´ë‹ 30ë¶„ ë„ì „! ğŸ’ª"],
    cleaning: ["ì˜¤ëŠ˜ ëŒ€ì²­ì†Œ í•˜ëŠ” ê±´ ì–´ë•Œ? ğŸ§¹", "ì •ë¦¬í•˜ë©´ ë§ˆìŒë„ ê¹¨ë—í•´ì ¸! âœ¨", "ìŒì•… í‹€ê³  ì²­ì†Œí•˜ë©´ ê¸ˆë°©ì´ì•¼! ğŸµ"]
};

const funFacts = [
    "ğŸ’ ì²´ë¦¬ íŒ©íŠ¸: í† ë§ˆí† ëŠ” ê³¼ì¼ì´ë˜ìš”! ğŸ…",
    "ğŸ’ ì²´ë¦¬ íŒ©íŠ¸: ê¿€ì€ ì ˆëŒ€ ìƒí•˜ì§€ ì•ŠëŠ”ëŒ€ìš”! ğŸ¯",
    "ğŸ’ ì²´ë¦¬ íŒ©íŠ¸: ë°”ë‚˜ë‚˜ëŠ” ì‚¬ì‹¤ ë² ë¦¬ë¥˜ë˜ìš”! ğŸŒ",
    "ğŸ’ ì²´ë¦¬ íŒ©íŠ¸: ë”¸ê¸° ê²‰ì— ë³´ì´ëŠ” ì”¨ê°€ ì§„ì§œ ì—´ë§¤ë˜ìš”! ğŸ“",
    "ğŸ’ ì²´ë¦¬ íŒ©íŠ¸: ë‹¹ê·¼ì€ ì›ë˜ ë³´ë¼ìƒ‰ì´ì—ˆëŒ€ìš”! ğŸ¥•",
    "ğŸ’ ì²´ë¦¬ íŒ©íŠ¸: íŒŒì¸ì• í”Œì€ ë‹¤ ìë¼ëŠ” ë° 2ë…„ ê±¸ë¦°ëŒ€ìš”! ğŸ",
    "ğŸ’ ì²´ë¦¬ íŒ©íŠ¸: ì´ˆì½œë¦¿ì€ ì˜›ë‚ ì— í™”íë¡œ ì“°ì˜€ëŒ€ìš”! ğŸ«",
    "ğŸ’ ì²´ë¦¬ íŒ©íŠ¸: ìˆ˜ë°•ì€ 92%ê°€ ë¬¼ì´ë˜ìš”! ğŸ‰"
];

function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function fallbackAI(text) {
    const t = text.toLowerCase().trim();
    let reply = null;
    let action = null;

    // 1. ë ˆì‹œí”¼ & ì¥ë³´ê¸°
    for (const food in recipes) {
        if (t.includes(food)) {
            if (t.includes("ì¬ë£Œ") || t.includes("ì¥ë³´ê¸°") || t.includes("ì¶”ê°€") || t.includes("ë‹´ì•„") || t.includes("ë§Œë“¤")) {
                action = { action: "add_shopping_multi", items: recipes[food] };
                reply = `ğŸ‘¨â€ğŸ³ <b>${food}</b> ì¬ë£Œë¥¼ ì¥ë³´ê¸°ì— ë‹´ì•˜ì–´!\nğŸ›’ ${recipes[food].join(", ")}`;
            } else {
                reply = `<b>${food}</b> ë§Œë“¤ë ¤ë©´ ì´ëŸ° ì¬ë£Œê°€ í•„ìš”í•´!\nğŸ“ ${recipes[food].join(", ")}\n\nì¥ë³´ê¸°ì— ë‹´ì„ê¹Œ? "${food} ì¬ë£Œ ì¶”ê°€"ë¼ê³  ë§í•´ë´!`;
            }
            break;
        }
    }

    // 2. ì¥ë³´ê¸° ë‹¨ì¼ ì•„ì´í…œ
    if (!reply && !action && (t.includes("ì¥ë³´ê¸°") || t.includes("ë‹´ì•„") || t.includes("ì‚¬ì•¼"))) {
        const item = t.replace(/ì¥ë³´ê¸°|ì¶”ê°€|í•´ì¤˜|ë‹´ì•„ì¤˜|ë‹´ì•„|ì—|ì‚¬ì•¼|ì¢€|í• |ë¦¬ìŠ¤íŠ¸/g, "").trim();
        if (item) { action = { action: "add_shopping", item }; reply = `ğŸ›’ <b>${item}</b> ì¥ë³´ê¸°ì— ì¶”ê°€í–ˆì–´!`; }
    }

    // 3. ì¼ì •
    if (!reply && t.includes("ì¼ì •")) {
        const today = new Date(); let date = today.toISOString().split('T')[0];
        if (t.includes("ë‚´ì¼")) { today.setDate(today.getDate()+1); date = today.toISOString().split('T')[0]; }
        if (t.includes("ëª¨ë ˆ")) { today.setDate(today.getDate()+2); date = today.toISOString().split('T')[0]; }
        const title = t.replace(/ì¼ì •|ì¶”ê°€|í•´ì¤˜|ë‚´ì¼|ì˜¤ëŠ˜|ëª¨ë ˆ|ë“±ë¡|ì—/g, "").trim();
        if (title) { action = { action: "add_event", date, title }; reply = `ğŸ“… <b>${date}</b>ì— <b>${title}</b> ë“±ë¡í–ˆì–´!`; }
    }

    // 4. ë°¥/ë©”ë‰´ ì¶”ì²œ
    if (!reply) {
        const hour = new Date().getHours();
        if (t.includes("ë­ ë¨¹") || t.includes("ë­ë¨¹") || t.includes("ë©”ë‰´") || t.includes("ì¶”ì²œ")) {
            let meal = "ì ì‹¬";
            if (hour < 10) meal = "ì•„ì¹¨"; else if (hour < 14) meal = "ì ì‹¬"; else if (hour < 18) meal = "ê°„ì‹"; else if (hour < 21) meal = "ì €ë…"; else meal = "ì•¼ì‹";
            if (t.includes("ì•„ì¹¨")) meal = "ì•„ì¹¨"; if (t.includes("ì ì‹¬")) meal = "ì ì‹¬"; if (t.includes("ì €ë…")) meal = "ì €ë…"; if (t.includes("ì•¼ì‹")) meal = "ì•¼ì‹"; if (t.includes("ê°„ì‹")) meal = "ê°„ì‹";
            reply = `${pick(mealSuggestions[meal])}\n\në ˆì‹œí”¼ê°€ í•„ìš”í•˜ë©´ ìŒì‹ ì´ë¦„ì„ ë§í•´ë´!`;
        }
    }

    // 5. ì¼ë°˜ ëŒ€í™”
    if (!reply) {
        if (t.match(/ì•ˆë…•|í•˜ì´|í—¬ë¡œ|hi|hello/)) reply = pick(generalChat.greetings);
        else if (t.match(/ê³ ë§ˆ|ê°ì‚¬|ã„±ã……|ë•¡í|thank/)) reply = pick(generalChat.thanks);
        else if (t.match(/ì–´ë•Œ|ê¸°ë¶„|ì˜ ì§€ë‚´|how are/)) reply = pick(generalChat.howAreYou);
        else if (t.match(/ë‚ ì”¨/)) reply = pick(generalChat.weather);
        else if (t.match(/ì‹¬ì‹¬|ì§€ë£¨|í•  ê²Œ ì—†/)) reply = pick(generalChat.bored);
        else if (t.match(/ì˜í–ˆ|ìµœê³ |ëŒ€ë‹¨|ë©‹ì ¸|ì¹­ì°¬/)) reply = pick(generalChat.compliment);
        else if (t.match(/ì‚¬ë‘|ì¢‹ì•„í•´/)) reply = pick(generalChat.love);
        else if (t.match(/ì˜ ì|êµ¿ë‚˜ì‡|good night/)) reply = pick(generalChat.goodnight);
        else if (t.match(/ì¢‹ì€ ì•„ì¹¨|êµ¿ëª¨ë‹|good morning/)) reply = pick(generalChat.goodmorning);
        else if (t.match(/í”¼ê³¤|í˜ë“¤|ì§€ì³¤/)) reply = pick(generalChat.tired);
        else if (t.match(/ë°°ê³ |ë°° ê³ |hungry|ë°¥/)) reply = pick(generalChat.hungry);
        else if (t.match(/ìš´ë™|í—¬ìŠ¤|ë‹¤ì´ì–´íŠ¸/)) reply = pick(generalChat.exercise);
        else if (t.match(/ì²­ì†Œ|ì •ë¦¬|ë¹¨ë˜/)) reply = pick(generalChat.cleaning);
        else if (t.match(/ì¬ë¯¸|ì›ƒê¸°|ã…‹ã…‹|ã…ã…/)) reply = pick(funFacts);
        else if (t.match(/ë„ì›€|ë„ì™€|ë­ í•  ìˆ˜|ê¸°ëŠ¥/)) {
            reply = "ë‚´ê°€ í•  ìˆ˜ ìˆëŠ” ê²ƒë“¤ì´ì•¼! ğŸ‘‡\n\nğŸ³ <b>ìš”ë¦¬ ì¬ë£Œ</b> â€” \"ë–¡ë³¶ì´ ì¬ë£Œ ì¶”ê°€\"\nğŸ“… <b>ì¼ì • ë“±ë¡</b> â€” \"ë‚´ì¼ ë³‘ì› ì¼ì • ì¶”ê°€\"\nğŸ›’ <b>ì¥ë³´ê¸°</b> â€” \"ìš°ìœ  ì¥ë³´ê¸° ì¶”ê°€\"\nğŸ½ï¸ <b>ë©”ë‰´ ì¶”ì²œ</b> â€” \"ì €ë… ë­ ë¨¹ì§€?\"\nğŸ’¬ <b>ì¡ë‹´</b> â€” ë­ë“  ë¬¼ì–´ë´!";
        }
    }

    // 6. ìµœí›„ì˜ ë³´ë£¨
    if (!reply) {
        const fallbacks = [
            "ìŒ~ ê·¸ê±´ ì˜ ëª¨ë¥´ê² ì§€ë§Œ, ë‹¤ë¥¸ ê±° ë¬¼ì–´ë´! ğŸ¤”",
            "ì–´ë µë‹¤~ ğŸ˜… 'ë„ì›€ë§'ì´ë¼ê³  ì¹˜ë©´ ë‚´ê°€ í•  ìˆ˜ ìˆëŠ” ê²ƒë“¤ ì•Œë ¤ì¤„ê²Œ!",
            `ì˜ ëª¨ë¥´ê² ì–´! ëŒ€ì‹  ì¬ë°ŒëŠ” ê±° í•˜ë‚˜ ì•Œë ¤ì¤„ê²Œ~ ${pick(funFacts)}`,
            "ê·¸ê±´ ë‚˜í•œí…Œ ì¢€ ì–´ë ¤ì›Œ! ğŸ™ˆ ìš”ë¦¬ë‚˜ ì¼ì •ì€ ì˜í•˜ë‹ˆê¹Œ ê·¸ìª½ìœ¼ë¡œ ë¬¼ì–´ë´~"
        ];
        reply = pick(fallbacks);
    }

    return { text: reply, action };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ’¾ Firestore ìºì‹± ì‹œìŠ¤í…œ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getCacheKey(text) {
    // í•µì‹¬ í‚¤ì›Œë“œë§Œ ì¶”ì¶œí•´ì„œ ìºì‹œ í‚¤ ìƒì„±
    return text.toLowerCase().replace(/[^ê°€-í£a-z0-9]/g, '').substring(0, 50);
}

async function getCachedResponse(text) {
    const key = getCacheKey(text);
    if (!key) return null;
    try {
        const snap = await db.collection("ai_cache").doc(key).get();
        if (snap.exists) {
            const data = snap.data();
            // 24ì‹œê°„ ì´ë‚´ì˜ ìºì‹œë§Œ ì‚¬ìš©
            const age = Date.now() - (data.timestamp?.toMillis?.() || 0);
            if (age < 24 * 60 * 60 * 1000) {
                return data.response;
            }
        }
    } catch(e) { console.warn("Cache read error:", e); }
    return null;
}

async function setCachedResponse(text, response) {
    const key = getCacheKey(text);
    if (!key || key.length < 3) return;
    try {
        await db.collection("ai_cache").doc(key).set({
            query: text,
            response: response,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch(e) { console.warn("Cache write error:", e); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ¤– AI ì±„íŒ… (í‚¤ ë¡œí…Œì´ì…˜ + ìºì‹œ + Fallback)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const AI_MODELS = ["gemini-2.5-flash", "gemini-2.0-flash", "gemini-1.5-flash"];

async function sendChat() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;
    appendMessage(text, 'user');
    input.value = '';
    const loadingId = appendLoading();

    // 1ë‹¨ê³„: ìºì‹œ í™•ì¸
    const cached = await getCachedResponse(text);
    if (cached) {
        document.getElementById(loadingId).remove();
        appendMessage(cached + ' <span class="cache-badge">âš¡ìºì‹œ</span>', 'bot');
        handleAIActions(cached);
        return;
    }

    const systemPrompt = `ë„ˆëŠ” 'ì²´ë¦¬'ë¼ëŠ” ê°€ì¡± AI ë¹„ì„œì•¼. ì¹œê·¼í•œ ë°˜ë§ë¡œ ëŒ€ë‹µí•´. ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•´.
[ê¸°ëŠ¥ ì‹¤í–‰ ê·œì¹™]
1. ì¼ì • ì¶”ê°€: {"action":"add_event", "date":"YYYY-MM-DD", "title":"ë‚´ìš©"} (ì˜¤ëŠ˜:${new Date().toISOString().split('T')[0]})
2. ì¥ë³´ê¸° ì¶”ê°€: {"action":"add_shopping", "item":"ë¬¼ê±´"}
3. ì—¬ëŸ¬ê°œ ì¶”ê°€: {"action":"add_shopping_multi", "items":["ë¬¼ê±´1","ë¬¼ê±´2"]}
4. ê·¸ ì™¸: ê·¸ëƒ¥ í…ìŠ¤íŠ¸ ëŒ€í™”.
ì¤‘ìš”: ì¬ë£Œ ì¶”ê°€ ìš”ì²­ ì‹œ ì‹¤ì œ ì¬ë£Œëª…ì„ itemsì— ë‹´ì•„ì¤˜. ì‘ë‹µì€ ì§§ê³  ì¹œê·¼í•˜ê²Œ!`;

    let aiText = "", success = false;

    // 2ë‹¨ê³„: API í˜¸ì¶œ (3ê°œ í‚¤ Ã— 3ê°œ ëª¨ë¸ = ìµœëŒ€ 9ë²ˆ ì‹œë„)
    for (const model of AI_MODELS) {
        for (let k = 0; k < GEMINI_API_KEYS.length; k++) {
            const key = getNextKey();
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: systemPrompt + "\nUser: " + text }] }] })
                });
                if (res.status === 429) { console.warn(`Key ${k} + ${model}: 429`); continue; }
                if (!res.ok) throw new Error("API Error " + res.status);
                const data = await res.json();
                aiText = data.candidates[0].content.parts[0].text;
                success = true;
                break;
            } catch(e) { console.warn(`${model} key${k}: ${e.message}`); }
        }
        if (success) break;
    }

    document.getElementById(loadingId).remove();

    // 3ë‹¨ê³„: ì‹¤íŒ¨ ì‹œ Fallback AI
    if (!success) {
        console.log("All API attempts failed â†’ Fallback AI");
        const fb = fallbackAI(text);
        aiText = fb.text;
        if (fb.action) executeAction(fb.action);
        appendMessage(aiText, 'bot');
        return;
    }

    // 4ë‹¨ê³„: ì„±ê³µ â†’ ìºì‹œ ì €ì¥ & ì•¡ì…˜ ì‹¤í–‰
    setCachedResponse(text, aiText);
    handleAIActions(aiText);
    appendMessage(aiText, 'bot');
}

function handleAIActions(aiText) {
    if (!aiText.includes('{"action"')) return;
    try {
        const match = aiText.match(/\{"action":[^}]*\}/) || aiText.match(/\{"action":[^}]*\]\}/);
        if (match) {
            const cmd = JSON.parse(match[0]);
            executeAction(cmd);
        }
    } catch(e) { console.warn("Action parse error:", e); }
}

function executeAction(cmd) {
    if (cmd.action === 'add_event') {
        db.collection("family_events").add({ date: cmd.date, title: cmd.title, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
    } else if (cmd.action === 'add_shopping') {
        db.collection("family_shopping").add({ text: cmd.item, checked: false, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
    } else if (cmd.action === 'add_shopping_multi') {
        cmd.items.forEach(i => db.collection("family_shopping").add({ text: i, checked: false, timestamp: firebase.firestore.FieldValue.serverTimestamp() }));
    }
}

function appendMessage(t, s) { const box = document.getElementById('chatBody'); box.innerHTML += `<div class="chat-msg msg-${s}">${marked.parse(t)}</div>`; box.scrollTop = box.scrollHeight; }
function appendLoading() { const id = 'load-'+Date.now(); document.getElementById('chatBody').innerHTML += `<div class="chat-msg msg-bot typing-indicator" id="${id}"><span></span><span></span><span></span></div>`; return id; }
function toggleChat() { const w = document.getElementById('chatWindow'); w.style.display = w.style.display === 'flex' ? 'none' : 'flex'; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± / í”¼ë“œ / ìº˜ë¦°ë” / ì¥ë³´ê¸°
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let familyData=[], selectedRole="";
function loadFamily(){
    db.collection("family_members").orderBy("timestamp").onSnapshot(snap=>{
        familyData=[]; const con=document.getElementById('family-container'); const chips=document.getElementById('writerChips');
        con.innerHTML=""; chips.innerHTML="";
        if(snap.empty) chips.innerHTML=`<div style="padding:10px;font-size:14px;color:#aaa;">ê°€ì¡±ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”!</div>`;
        snap.forEach(doc=>{
            const d=doc.data(); familyData.push({id:doc.id,...d});
            const imgHtml=d.imageUrl?`<img src="${d.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user" style="font-size:30px;"></i>`;
            con.innerHTML+=`<div class="mem-card"><button onclick="delFamily('${doc.id}')" style="position:absolute;top:10px;right:10px;border:none;background:none;color:#999;cursor:pointer;"><i class="fa-solid fa-times"></i></button><div class="mem-pic">${imgHtml}</div><div class="mem-role">${d.role}</div><div class="mem-desc">${d.desc||'Yummy!'}</div></div>`;
            const chk=selectedRole===d.role?'checked':'';
            chips.innerHTML+=`<input type="radio" name="auth" id="c-${doc.id}" class="radio-hidden" value="${d.role}" onchange="selAuth(this)" ${chk}><label for="c-${doc.id}" class="writer-tag"><div style="width:24px;height:24px;border-radius:50%;overflow:hidden;background:#eee;border:1px solid #444;display:flex;align-items:center;justify-content:center;">${d.imageUrl?`<img src="${d.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user" style="font-size:12px;"></i>`}</div> ${d.role}</label>`;
        });
        con.innerHTML+=`<div class="mem-card add-card" onclick="openFamModal()"><i class="fa-solid fa-plus-circle" style="font-size:40px;"></i><span style="font-family:'Jua';font-size:18px;">ê°€ì¡± ì¶”ê°€</span></div>`;
        updateHeaderProf(); updateCommentAvatars();
    });
}
function selAuth(rd){ selectedRole=rd.value; updateHeaderProf(); updateCommentAvatars(); }
function updateHeaderProf(){
    const hp=document.getElementById('headerProfile');
    if(!selectedRole){hp.innerHTML=`<i class="fa-solid fa-user"></i>`;return;}
    const mem=familyData.find(m=>m.role===selectedRole);
    hp.innerHTML=mem&&mem.imageUrl?`<img src="${mem.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user"></i>`;
}
function updateCommentAvatars(){const h=getMyAvatarHtml();document.querySelectorAll('.cmt-my-avatar').forEach(el=>{el.innerHTML=h;});}
function getMemberImg(role){const m=familyData.find(x=>x.role===role);return m&&m.imageUrl?`<img src="${m.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`:`<i class="fa-solid fa-user" style="font-size:14px;color:#bbb;"></i>`;}
function getMyAvatarHtml(){return selectedRole?getMemberImg(selectedRole):`<i class="fa-solid fa-user" style="font-size:12px;color:#bbb;"></i>`;}

let feedImg=null;
function handleImageSelect(e){if(e.target.files[0])compressImage(e.target.files[0],500,d=>{feedImg=d;document.getElementById('imagePreview').src=d;document.getElementById('imagePreviewBox').style.display='block';});}
function clearImage(){feedImg=null;document.getElementById('imageInput').value='';document.getElementById('imagePreviewBox').style.display='none';}
function addPost(){
    if(!selectedRole) return alert("ê°€ì¡±ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
    const txt=document.getElementById('postContent').value,btn=document.getElementById('btnPost');
    if(!txt&&!feedImg) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    const mem=familyData.find(m=>m.role===selectedRole);btn.disabled=true;btn.innerText="ì €ì¥ ì¤‘...";
    db.collection("family_posts").add({author:selectedRole,authorImg:mem?mem.imageUrl:null,content:txt,imageUrl:feedImg,likedBy:[],comments:[],timestamp:firebase.firestore.FieldValue.serverTimestamp()})
    .then(()=>{document.getElementById('postContent').value='';clearImage();btn.disabled=false;btn.innerText="ì—…ë¡œë“œ!";window.scrollTo(0,0);})
    .catch(()=>{alert("ì‹¤íŒ¨!");btn.disabled=false;btn.innerText="ì—…ë¡œë“œ!";});
}
function likePost(id,likedByArr){
    if(!selectedRole) return alert("í”„ë¡œí•„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
    const likedBy=likedByArr||[];
    if(likedBy.includes(selectedRole)){db.collection("family_posts").doc(id).update({likedBy:firebase.firestore.FieldValue.arrayRemove(selectedRole)});}
    else{db.collection("family_posts").doc(id).update({likedBy:firebase.firestore.FieldValue.arrayUnion(selectedRole)});const b=document.querySelector(`[data-like-id="${id}"]`);if(b){b.classList.add('heart-pop');setTimeout(()=>b.classList.remove('heart-pop'),400);}}
}
function loadFeed(){
    db.collection("family_posts").limit(20).onSnapshot(snap=>{
        const con=document.getElementById('feed-container');con.innerHTML="";let posts=[];
        snap.forEach(d=>{const data=d.data();if(!data.likedBy)data.likedBy=[];posts.push({id:d.id,...data});});
        posts.sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
        if(!posts.length){con.innerHTML=`<div style="text-align:center;padding:40px;color:#aaa;">ì²« ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”! ğŸ’</div>`;return;}
        posts.forEach(d=>{
            const pImg=d.authorImg?`<div class="fp-img"><img src="${d.authorImg}" style="width:100%;height:100%;object-fit:cover;"></div>`:`<div class="fp-img"><i class="fa-solid fa-user"></i></div>`;
            const iHtml=d.imageUrl?`<div class="feed-photo"><img src="${d.imageUrl}"></div>`:'';
            const likedBy=d.likedBy||[],likeCount=likedBy.length,iLiked=selectedRole&&likedBy.includes(selectedRole);
            let lpHtml='';
            if(likeCount>0){lpHtml='<div class="like-profiles">';likedBy.slice(0,5).forEach(r=>{lpHtml+=`<div class="like-avatar">${getMemberImg(r)}</div>`;});lpHtml+=`<span class="like-text"><b>${likedBy.join(', ')}</b>ë‹˜ì´ ì¢‹ì•„í•©ë‹ˆë‹¤</span></div>`;}
            let cmH='';
            if(d.comments&&d.comments.length>0)d.comments.forEach((c,i)=>{cmH+=`<div class="cmt-single"><div class="cmt-avatar">${getMemberImg(c.author)}</div><div class="cmt-body"><span class="cmt-author">${c.author}</span><span class="cmt-text">${c.text}</span></div><button class="cmt-del" onclick="delComment('${d.id}',${i})"><i class="fa-solid fa-times"></i></button></div>`;});
            const ts=d.timestamp?new Date(d.timestamp.seconds*1000).toLocaleDateString('ko-KR',{month:'long',day:'numeric'}):'ë°©ê¸ˆ';
            con.innerHTML+=`<div class="retro-card" style="padding-bottom:0;overflow:hidden;">
                <div class="feed-head"><div class="feed-profile">${pImg}<div><h4 style="font-size:15px;">${d.author}</h4><span style="font-size:12px;color:#999;">${ts}</span></div></div><button onclick="delPost('${d.id}')" style="border:none;background:none;color:#bbb;cursor:pointer;"><i class="fa-solid fa-trash" style="font-size:14px;"></i></button></div>
                <div style="margin-bottom:12px;font-size:15px;line-height:1.6;">${d.content}</div>${iHtml}
                <div style="display:flex;gap:12px;padding:8px 0;">
                    <button class="act-btn ${iLiked?'liked':''}" data-like-id="${d.id}" onclick='likePost("${d.id}",${JSON.stringify(likedBy)})'><i class="${iLiked?'fa-solid fa-heart':'fa-regular fa-heart'}" style="font-size:18px;"></i> ${likeCount||''}</button>
                    <button class="act-btn" onclick="toggleCmt('${d.id}')"><i class="fa-regular fa-comment" style="font-size:18px;"></i> ${d.comments?d.comments.length:''}</button>
                </div>${lpHtml}
                <div id="cmt-${d.id}" class="cmt-area">
                    <div class="cmt-list">${cmH||'<div style="text-align:center;padding:20px;color:#ccc;font-size:13px;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ì–´ìš”</div>'}</div>
                    <div class="cmt-input-bar"><div class="cmt-my-avatar">${getMyAvatarHtml()}</div><input type="text" id="cInp-${d.id}" placeholder="ëŒ“ê¸€ ë‹¬ê¸°..." onkeydown="if(event.key==='Enter')addCmt('${d.id}')"><button class="cmt-send-btn" onclick="addCmt('${d.id}')">ê²Œì‹œ</button></div>
                </div></div>`;
        });
    });
}
function delPost(id){if(confirm("ì‚­ì œí• ê¹Œìš”?"))db.collection("family_posts").doc(id).delete();}
function toggleCmt(id){document.getElementById(`cmt-${id}`).classList.toggle('show');}
function addCmt(id){if(!selectedRole)return alert("í”„ë¡œí•„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");const t=document.getElementById(`cInp-${id}`).value.trim();if(!t)return;db.collection("family_posts").doc(id).update({comments:firebase.firestore.FieldValue.arrayUnion({author:selectedRole,text:t,time:Date.now()})});document.getElementById(`cInp-${id}`).value='';}
function delComment(pid,idx){if(!confirm("ì‚­ì œ?"))return;db.collection("family_posts").doc(pid).get().then(doc=>{if(doc.exists){const c=doc.data().comments||[];c.splice(idx,1);db.collection("family_posts").doc(pid).update({comments:c});}});}

let curDate=new Date(),events=[],curModDate=null;
function loadCal(){const y=curDate.getFullYear(),m=curDate.getMonth();document.getElementById('month-display').innerText=`${m+1}ì›”`;const f=new Date(y,m,1),l=new Date(y,m+1,0),con=document.getElementById('calendar-days');con.innerHTML="";for(let i=0;i<f.getDay();i++)con.innerHTML+=`<div></div>`;for(let i=1;i<=l.getDate();i++){const dS=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`,hE=events.filter(e=>e.date===dS).length?`<div class="ev-badge"></div>`:'',td=new Date().toDateString()===new Date(y,m,i).toDateString()?'today':'';con.innerHTML+=`<div class="date-box ${td}" onclick="openEvModal('${dS}')"><span>${i}</span>${hE}</div>`;}}
function moveMonth(n){curDate.setMonth(curDate.getMonth()+n);loadCal();}
function openEvModal(d){curModDate=d;document.getElementById('modalDateDisplay').innerText=d;renderEvList();document.getElementById('eventModal').style.display='flex';}
function renderEvList(){const el=document.getElementById('eventList'),evs=events.filter(e=>e.date===curModDate);el.innerHTML=evs.length?"":"<li style='text-align:center;color:#999;'>ì¼ì • ì—†ìŒ</li>";evs.forEach(e=>el.innerHTML+=`<li style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #ccc;"><span>${e.title}</span><i class="fa-solid fa-times" style="color:red;cursor:pointer;" onclick="delEv('${e.id}')"></i></li>`);}
function saveEvent(){const t=document.getElementById('eventTitle').value;if(curModDate&&t)db.collection("family_events").add({date:curModDate,title:t,timestamp:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{document.getElementById('eventTitle').value='';closeModal('eventModal');});}
function delEv(id){if(confirm("ì‚­ì œ?"))db.collection("family_events").doc(id).delete();}
db.collection("family_events").onSnapshot(s=>{events=[];s.forEach(d=>events.push({id:d.id,...d.data()}));loadCal();if(curModDate)renderEvList();});

let famImg=null;
function closeModal(id){document.getElementById(id).style.display='none';famImg=null;curModDate=null;}
function openFamModal(){document.getElementById('familyModal').style.display='flex';}
function handleFamImgSelect(e){if(e.target.files[0])compressImage(e.target.files[0],500,d=>{famImg=d;document.getElementById('famImgPreview').innerHTML=`<img src="${d}" style="width:100%;height:100%;object-fit:cover;">`;});}
function saveFam(){const r=document.getElementById('famRole').value,n=document.getElementById('famName').value,d=document.getElementById('famDesc').value;if(!r)return alert("ì—­í•  ì…ë ¥!");const btn=document.getElementById('btnSaveFam');btn.disabled=true;btn.innerText="ì €ì¥ ì¤‘...";db.collection("family_members").add({role:r,name:n,desc:d,imageUrl:famImg,timestamp:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{closeModal('familyModal');btn.disabled=false;btn.innerText="ì¶”ê°€";document.getElementById('famRole').value='';document.getElementById('famName').value='';document.getElementById('famDesc').value='';document.getElementById('famImgInput').value='';document.getElementById('famImgPreview').innerHTML=`<i class="fa-solid fa-camera" style="font-size:30px;color:var(--text-choco);"></i>`;}).catch(()=>{alert("ì˜¤ë¥˜!");btn.disabled=false;btn.innerText="ì¶”ê°€";});}
function delFamily(id){if(confirm("ì‚­ì œ?"))db.collection("family_members").doc(id).delete();}

function loadShopping(){db.collection("family_shopping").orderBy("timestamp","desc").onSnapshot(snap=>{const list=document.getElementById('shopList');list.innerHTML="";snap.forEach(doc=>{const d=doc.data();list.innerHTML+=`<div class="shop-item"><div style="display:flex;align-items:center;"><div class="shop-check ${d.checked?'on':''}" onclick="toggleShop('${doc.id}',${!d.checked})"><i class="fa-solid fa-check" style="color:white;font-size:12px;"></i></div><span style="${d.checked?'text-decoration:line-through;color:#aaa;':''}">${d.text}</span></div><i class="fa-solid fa-times shop-del" onclick="delShop('${doc.id}')"></i></div>`;});});}
function addShopItem(){const inp=document.getElementById('shopInput');if(inp.value.trim()){db.collection("family_shopping").add({text:inp.value,checked:false,timestamp:firebase.firestore.FieldValue.serverTimestamp()});inp.value='';}}
function toggleShop(id,s){db.collection("family_shopping").doc(id).update({checked:s});}
function delShop(id){if(confirm("ì‚­ì œ?"))db.collection("family_shopping").doc(id).delete();}

window.changeTab=function(id,el){document.querySelectorAll('.tab-section').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));if(el)el.classList.add('active');window.scrollTo(0,0);}

loadFeed(); loadCal(); loadFamily(); loadShopping();
</script>
</body>
</html>
